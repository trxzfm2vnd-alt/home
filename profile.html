<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Perfil - Sophie</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            padding-top: 0;
        }

        .profile-wrapper {
            min-height: 100vh;
            padding: 40px 20px;
        }

        .profile-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 50px;
            animation: slideDown 0.5s ease;
        }

        .profile-header h1 {
            font-family: Playfair Display, serif;
            color: #5a2032;
            font-size: 2.8rem;
            margin: 0 0 10px 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .profile-header p {
            color: #7a6a75;
            font-size: 1.1rem;
            margin: 0;
            font-weight: 500;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #d946a6;
            text-decoration: none;
            font-weight: 700;
            margin-bottom: 30px;
            transition: all 0.2s;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .back-link:hover {
            background: rgba(217, 70, 166, 0.1);
            transform: translateX(-4px);
        }

        .profile-card {
            background: #fff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 16px 48px rgba(82, 44, 60, 0.12);
            margin-bottom: 30px;
            border: 1px solid rgba(217, 70, 166, 0.1);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-section h2 {
            color: #5a2032;
            font-size: 1.5rem;
            margin: 0 0 25px 0;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3e5f5;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-section h2::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background: linear-gradient(135deg, #ff6b9d, #d946a6);
            border-radius: 50%;
        }

        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-item {
            padding: 18px;
            background: linear-gradient(135deg, #f8f5f7 0%, #faf8fb 100%);
            border-radius: 14px;
            border-left: 4px solid #d946a6;
            transition: all 0.3s;
        }

        .info-item:hover {
            background: linear-gradient(135deg, #f3e5f5 0%, #f5e9f0 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(217, 70, 166, 0.1);
        }

        .info-label {
            font-size: 0.75rem;
            color: #9a7a8f;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }

        .info-value {
            font-size: 1.05rem;
            color: #333;
            font-weight: 600;
            word-break: break-word;
        }

        .no-shipping {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
            padding: 20px;
            border-radius: 12px;
            color: #e65100;
            margin: 25px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .no-shipping::before {
            content: '‚ö†Ô∏è';
            font-size: 1.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 14px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5a8dee, #3a70d6);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(74, 144, 226, 0.35);
        }

        .btn-secondary {
            background: #f3e5f5;
            color: #5a2032;
            border: 2px solid #d946a6;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-secondary:hover {
            background: #e9d5ff;
            transform: translateY(-3px);
        }

        .btn-danger {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ef9a9a;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-danger:hover {
            background: #ffcdd2;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(198, 40, 40, 0.25);
        }

        .btn-save {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-save:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        .btn-cancel {
            background: #e0e0e0;
            color: #333;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-cancel:hover {
            background: #d0d0d0;
        }

        #no-session {
            text-align: center;
            padding: 80px 40px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 16px 48px rgba(82, 44, 60, 0.12);
            animation: slideUp 0.5s ease;
        }

        #no-session p {
            color: #7a6a75;
            font-size: 1.2rem;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .shipping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .edit-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #d946a6;
            border-radius: 10px;
            font-family: Montserrat, sans-serif;
            font-size: 1rem;
            background: #fff;
            transition: all 0.2s;
        }

        .edit-input:focus {
            outline: none;
            border-color: #5a8dee;
            box-shadow: 0 0 0 3px rgba(90, 139, 238, 0.15);
        }

        @media (max-width: 768px) {
            .profile-card {
                padding: 30px 20px;
            }

            .profile-header h1 {
                font-size: 2.2rem;
            }

            .profile-info,
            .shipping-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-primary,
            .btn-secondary,
            .btn-danger,
            .btn-save,
            .btn-cancel {
                width: 100%;
                justify-content: center;
            }

            #no-session {
                padding: 60px 20px;
            }

            #no-session p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="profile-wrapper">
        <div class="profile-container">
            <a href="index.html" class="back-link">‚Üê Volver a la tienda</a>

            <div class="profile-header">
                <h1>Mi Perfil</h1>
                <p>Informaci√≥n de tu cuenta y direcci√≥n de env√≠o</p>
            </div>

            <div id="profile-content" style="display: none;">
                <div class="profile-card profile-section">
                    <h2>Informaci√≥n Personal</h2>
                    <div class="profile-info" id="personal-info"></div>
                </div>

                <div class="profile-card profile-section">
                    <h2>Direcci√≥n de Env√≠o</h2>
                    <div id="shipping-info"></div>
                    <div class="action-buttons" id="action-buttons"></div>
                </div>
            </div>

            <div id="no-session" style="display: none;">
                <p>Debes iniciar sesi√≥n para ver tu perfil</p>
                <a href="user-login.html" class="btn-primary">üîì Iniciar Sesi√≥n</a>
            </div>
        </div>
    </div>

    <script>
        // ============== FUNCIONES GLOBALES ==============
        function getUserSession() {
            try {
                const raw = localStorage.getItem('user_session');
                return raw ? JSON.parse(raw) : null;
            } catch (e) {
                return null;
            }
        }

        function getUserFullData(email) {
            try {
                const accounts = JSON.parse(localStorage.getItem('user_accounts') || '[]');
                return accounts.find(a => a.email === email);
            } catch (e) {
                return null;
            }
        }

        function setUserSession(session) {
            localStorage.setItem('user_session', JSON.stringify(session));
        }

        function updateUserAccount(email, userData) {
            try {
                const accounts = JSON.parse(localStorage.getItem('user_accounts') || '[]');
                const idx = accounts.findIndex(a => a.email === email);
                if (idx !== -1) {
                    accounts[idx] = { ...accounts[idx], ...userData };
                    localStorage.setItem('user_accounts', JSON.stringify(accounts));
                    return accounts[idx];
                }
            } catch (e) {
                console.error('Error updating account:', e);
            }
            return null;
        }

        function clearUserSession() {
            localStorage.removeItem('user_session');
        }

        // ============== VISTA DE LECTURA ==============
        function showViewMode() {
            const session = getUserSession();
            if (!session) {
                document.getElementById('profile-content').style.display = 'none';
                document.getElementById('no-session').style.display = 'block';
                return;
            }

            document.getElementById('profile-content').style.display = 'block';
            document.getElementById('no-session').style.display = 'none';

            // Datos personales
            const personalInfo = document.getElementById('personal-info');
            personalInfo.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Nombre</span>
                    <div class="info-value">${session.name || '-'}</div>
                </div>
                <div class="info-item">
                    <span class="info-label">Apellidos</span>
                    <div class="info-value">${session.lastName || '-'}</div>
                </div>
                <div class="info-item">
                    <span class="info-label">Correo</span>
                    <div class="info-value">${session.email || '-'}</div>
                </div>
            `;

            // Direcci√≥n
            const fullData = getUserFullData(session.email);
            const shippingInfo = document.getElementById('shipping-info');

            if (fullData && fullData.shipping) {
                const s = fullData.shipping;
                shippingInfo.innerHTML = `
                    <div class="shipping-grid">
                        <div class="info-item">
                            <span class="info-label">Tel√©fono</span>
                            <div class="info-value">${s.phone || '-'}</div>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Provincia</span>
                            <div class="info-value">${s.provincia || '-'}</div>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Cant√≥n</span>
                            <div class="info-value">${s.canton || '-'}</div>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Distrito</span>
                            <div class="info-value">${s.distrito || '-'}</div>
                        </div>
                        <div class="info-item">
                            <span class="info-label">C√≥digo Postal</span>
                            <div class="info-value">${s.zip || '-'}</div>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Direcci√≥n</span>
                            <div class="info-value">${s.address || '-'}</div>
                        </div>
                    </div>
                `;
            } else {
                shippingInfo.innerHTML = '<div class="no-shipping">No has agregado direcci√≥n de env√≠o. Agrega una en checkout o en tu perfil.</div>';
            }

            // Botones
            const actionButtons = document.getElementById('action-buttons');
            actionButtons.innerHTML = `
                <a href="index.html" class="btn-primary">üì¶ Continuar Comprando</a>
                <button class="btn-secondary" onclick="showEditMode()">‚úèÔ∏è Actualizar Perfil</button>
                <button class="btn-secondary" onclick="showPurchaseHistory()">üßæ Ver historial de compras</button>
                <button class="btn-danger" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            `;
// ============== HISTORIAL DE COMPRAS ==============
function showPurchaseHistory() {
    const session = getUserSession();
    if (!session) return;
    const email = session.email;
    let invoices = [];
    try {
        invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
    } catch (e) {}
    const userEmail = email.toLowerCase();
    const userInvoices = invoices.filter(inv => inv.customerEmail && inv.customerEmail.toLowerCase() === userEmail);

    let modal = document.getElementById('purchase-history-modal');
    if (modal) modal.remove();
    modal = document.createElement('div');
    modal.id = 'purchase-history-modal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
    let content = `<div style="background:white;padding:30px;border-radius:16px;max-width:700px;width:96vw;max-height:90vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.18);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;border-bottom:2px solid #d946a6;padding-bottom:12px;">
            <h2 style="margin:0;color:#d946a6;font-size:1.5rem;">üßæ Historial de Compras</h2>
            <button onclick="document.getElementById('purchase-history-modal').remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>
        </div>`;
    if (userInvoices.length === 0) {
        content += `<p style='text-align:center;color:#999;padding:40px'>No se encontraron compras registradas.</p>`;
    } else {
        content += `<div style='display:flex;flex-direction:column;gap:18px;'>`;
        userInvoices.sort((a,b)=>new Date(b.date)-new Date(a.date));
        userInvoices.forEach(inv => {
            const date = new Date(inv.date).toLocaleString('es-CR');
            const total = inv.subtotal ? `‚Ç°${inv.subtotal.toLocaleString()}` : '';
            content += `<div style='border:1px solid #e3cfe0;border-radius:10px;padding:16px;background:#faf8fb;'>
                <div style='display:flex;justify-content:space-between;align-items:center;'>
                    <div><strong style='color:#5a2032'>${inv.id || 'Factura'}</strong></div>
                    <div style='color:#d946a6;font-weight:700'>${total}</div>
                </div>
                <div style='color:#666;font-size:0.95rem;margin:6px 0 0 0;'>${date}</div>
                <div style='margin-top:10px;'>
                    ${(inv.items||[]).map(item=>`<div style='display:flex;justify-content:space-between;'><span>${item.title}${item.variantName?` <span style='color:#999'>(${item.variantName})</span>`:''} x${item.qty}</span><span style='color:#333'>‚Ç°${item.price.toLocaleString()}</span></div>`).join('')}
                </div>
            </div>`;
        });
        content += `</div>`;
    }
    content += `</div>`;
    modal.innerHTML = content;
    document.body.appendChild(modal);
}
        }

        // ============== VISTA DE EDICI√ìN ==============
        function showEditMode() {
            const session = getUserSession();
            const fullData = getUserFullData(session.email);

            // Datos personales
            const personalInfo = document.getElementById('personal-info');
            personalInfo.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Nombre</span>
                    <input type="text" class="edit-input" id="edit-name" value="${session.name || ''}">
                </div>
                <div class="info-item">
                    <span class="info-label">Apellidos</span>
                    <input type="text" class="edit-input" id="edit-lastname" value="${session.lastName || ''}">
                </div>
                <div class="info-item">
                    <span class="info-label">Correo</span>
                    <input type="email" class="edit-input" id="edit-email" value="${session.email || ''}">
                </div>
            `;

            // Direcci√≥n
            let shippingHTML = '<div class="shipping-grid">';
            const s = (fullData && fullData.shipping) ? fullData.shipping : {};
            
            shippingHTML += `
                <div class="info-item">
                    <span class="info-label">Tel√©fono</span>
                    <input type="tel" class="edit-input" id="edit-phone" value="${s.phone || ''}">
                </div>
                <div class="info-item">
                    <span class="info-label">Provincia</span>
                    <input type="text" class="edit-input" id="edit-provincia" value="${s.provincia || ''}">
                </div>
                <div class="info-item">
                    <span class="info-label">Cant√≥n</span>
                    <input type="text" class="edit-input" id="edit-canton" value="${s.canton || ''}">
                </div>
                <div class="info-item">
                    <span class="info-label">Distrito</span>
                    <input type="text" class="edit-input" id="edit-distrito" value="${s.distrito || ''}">
                </div>
                <div class="info-item">
                    <span class="info-label">C√≥digo Postal</span>
                    <input type="text" class="edit-input" id="edit-zip" value="${s.zip || ''}">
                </div>
                <div class="info-item">
                    <span class="info-label">Direcci√≥n</span>
                    <input type="text" class="edit-input" id="edit-address" value="${s.address || ''}">
                </div>
            </div>`;

            const shippingInfo = document.getElementById('shipping-info');
            shippingInfo.innerHTML = shippingHTML;

            // Botones
            const actionButtons = document.getElementById('action-buttons');
            actionButtons.innerHTML = `
                <button class="btn-save" onclick="saveProfile()">‚úì Guardar Cambios</button>
                <button class="btn-cancel" onclick="showViewMode()">‚úï Cancelar</button>
            `;
        }

        // ============== GUARDAR PERFIL ==============
        function saveProfile() {
            const session = getUserSession();
            
            const newName = document.getElementById('edit-name').value.trim();
            const newLastname = document.getElementById('edit-lastname').value.trim();

            if (!newName || !newLastname) {
                alert('Nombre y Apellidos son requeridos');
                return;
            }

            const newShipping = {
                phone: document.getElementById('edit-phone').value,
                provincia: document.getElementById('edit-provincia').value,
                canton: document.getElementById('edit-canton').value,
                distrito: document.getElementById('edit-distrito').value,
                zip: document.getElementById('edit-zip').value,
                address: document.getElementById('edit-address').value
            };

            const updatedData = {
                name: newName,
                lastName: newLastname,
                email: session.email,
                password: (getUserFullData(session.email) || {}).password || '',
                shipping: newShipping
            };

            updateUserAccount(session.email, updatedData);
            const updatedSession = { 
                name: newName, 
                lastName: newLastname,
                email: session.email,
                loginAt: session.loginAt,
                shipping: newShipping
            };
            setUserSession(updatedSession);

            alert('‚úì Perfil actualizado correctamente');
            showViewMode();
        }

        // ============== CERRAR SESI√ìN ==============
        function logout() {
            if (confirm('¬øDeseas cerrar sesi√≥n?')) {
                clearUserSession();
                window.location.href = 'index.html';
            }
        }

        // ============== INICIALIZAR ==============
        showViewMode();

        // ============== HISTORIAL DE COMPRAS ==============
        function showPurchaseHistory() {
            const session = getUserSession();
            if (!session) return;
            const email = session.email;
            let invoices = [];
            try {
                invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
            } catch (e) {}
            const userEmail = email.toLowerCase();
            const userInvoices = invoices.filter(inv => inv.customerEmail && inv.customerEmail.toLowerCase() === userEmail);

            let modal = document.getElementById('purchase-history-modal');
            if (modal) modal.remove();
            modal = document.createElement('div');
            modal.id = 'purchase-history-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
            let content = `<div style="background:white;padding:30px;border-radius:16px;max-width:700px;width:96vw;max-height:90vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.18);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;border-bottom:2px solid #d946a6;padding-bottom:12px;">
                    <h2 style="margin:0;color:#d946a6;font-size:1.5rem;">üßæ Historial de Compras</h2>
                    <button onclick="document.getElementById('purchase-history-modal').remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>
                </div>`;
            if (userInvoices.length === 0) {
                content += `<p style='text-align:center;color:#999;padding:40px'>No se encontraron compras registradas.</p>`;
            } else {
                content += `<div style='display:flex;flex-direction:column;gap:18px;'>`;
                userInvoices.sort((a,b)=>new Date(b.date)-new Date(a.date));
                userInvoices.forEach(inv => {
                    const date = new Date(inv.date).toLocaleString('es-CR');
                    const total = inv.subtotal ? `‚Ç°${inv.subtotal.toLocaleString()}` : '';
                    content += `<div style='border:1px solid #e3cfe0;border-radius:10px;padding:16px;background:#faf8fb;'>
                        <div style='display:flex;justify-content:space-between;align-items:center;'>
                            <div><strong style='color:#5a2032'>${inv.id || 'Factura'}</strong></div>
                            <div style='color:#d946a6;font-weight:700'>${total}</div>
                        </div>
                        <div style='color:#666;font-size:0.95rem;margin:6px 0 0 0;'>${date}</div>
                        <div style='margin-top:10px;'>
                            ${(inv.items||[]).map(item=>`<div style='display:flex;justify-content:space-between;'><span>${item.title}${item.variantName?` <span style='color:#999'>(${item.variantName})</span>`:''} x${item.qty}</span><span style='color:#333'>‚Ç°${item.price.toLocaleString()}</span></div>`).join('')}
                        </div>
                    </div>`;
                });
                content += `</div>`;
            }
            content += `</div>`;
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
