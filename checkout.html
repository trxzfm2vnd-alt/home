<!doctype html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Sophie - Checkout</title>
		<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="styles.css" />
		<style>
			.checkout-hero { background: linear-gradient(135deg, rgba(255,107,157,0.12), rgba(217,70,166,0.08)); border-bottom: 1px solid rgba(0,0,0,0.04); }
			.checkout-hero .hero-title { margin-bottom: 6px; }
			.checkout-badges { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
			.checkout-pill { padding:6px 12px; border-radius:999px; font-size:0.9rem; border:1px solid rgba(0,0,0,0.08); background:rgba(255,255,255,0.65); color:#6b2840; }
			.checkout-pill.solid { background:#6b2840; color:#fff; border-color:#6b2840; }
			.checkout-pill.outline { background:transparent; }
			.checkout-section { padding:24px 16px 48px; }
			.checkout-grid { display:grid; grid-template-columns:1.15fr 0.85fr; gap:12px; align-items:start; max-width:1100px; margin:0 auto; }
			.checkout-card { padding:20px; border-radius:14px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); }
			.checkout-card h2 { margin-top:0; margin-bottom:10px; }
			.checkout-form { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
			.checkout-form label { font-weight:600; font-size:0.95rem; color:#4a4a4a; display:block; margin-bottom:4px; }
			.checkout-form input, .checkout-form textarea, .checkout-form select { width:100%; padding:10px 12px; border:1px solid #e6e6e6; border-radius:10px; font-size:0.98rem; transition:border-color 0.2s, box-shadow 0.2s; background:#fff; }
			.checkout-form input:focus, .checkout-form textarea:focus, .checkout-form select:focus { outline:none; border-color:#C7499F; box-shadow:0 0 0 3px rgba(217,70,166,0.15); }
			.checkout-radio-group { grid-column:1/3; display:flex; flex-direction:column; gap:10px; padding:16px; border:1px solid #e0e0e0; border-radius:10px; background:rgba(0,0,0,0.02); }
			.checkout-radio-group strong { font-size:0.95rem; margin-bottom:4px; display:block; color:#333; }
			.checkout-radio { display:flex; align-items:center; gap:10px; cursor:pointer; }
			.checkout-radio input[type="radio"] { width:auto; margin:0; cursor:pointer; }
			.payment-note { display:flex; align-items:center; gap:6px; font-size:0.82rem; color:#7a7a7a; margin-left:28px; padding:6px 10px; background:linear-gradient(135deg, rgba(217,70,166,0.08), rgba(255,107,157,0.05)); border-left:3px solid #C7499F; border-radius:4px; }
			.payment-note::before { content:"⏱"; font-size:0.9rem; }
			#payment-card-section { transition:all 0.3s ease; }
			#payment-card-section h3 { font-size:1.05rem; color:#6b2840; font-weight:600; }
			#payment-card-section input { background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(217,70,166,0.02)) !important; transition:all 0.2s ease !important; }
			#payment-card-section input:focus { background:linear-gradient(135deg, #fff, rgba(217,70,166,0.05)) !important; border-color:#C7499F !important; box-shadow:0 0 0 3px rgba(217,70,166,0.2) !important; }
			.checkout-summary { padding:0; margin-top:12px; border-top:1px solid #eee; }
			.checkout-summary .amounts { display:flex; flex-direction:column; gap:8px; padding-top:12px; }
			.checkout-summary .amounts div { display:flex; justify-content:space-between; align-items:center; }
			.checkout-summary .amounts div strong { font-size:1.05rem; }
			.checkout-actions { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
			.checkout-note { margin-top:8px; font-size:0.95rem; color:#6b6b6b; }
			.checkout-divider { height:1px; background:linear-gradient(90deg, transparent, rgba(0,0,0,0.08), transparent); margin:14px 0; }
		</style>
	</head>
	<body>
		<header class="site-header">
			<div class="container header-inner">
				<button id="hamburger" class="hamburger" aria-label="Abrir menu">☰</button>
				<a href="index.html" class="logo" style="text-decoration:none;cursor:pointer;display:flex;align-items:center;gap:10px">
					<span style="font-family:'Daily',Playfair Display,serif;font-size:2.5rem;font-weight:400;color:#2c4a8c">SophieWeb</span>
				</a>
				<button id="account-btn" class="account" type="button" aria-label="Abrir cuenta">👤 Iniciar sesión</button>
				<div id="account-menu" class="account-menu hidden" aria-hidden="true">
					<a href="profile.html" class="menu-item">👤 Ver Perfil</a>
					<button id="logout-btn" class="menu-item logout" type="button">🚪 Cerrar Sesión</button>
				</div>
				<div class="cart" id="open-cart" role="button">🛍️ <span id="cart-count">0</span></div>
			</div>
		</header>

		<div id="nav-overlay" class="nav-overlay" aria-hidden="true"></div>
		<!-- Modal para agradecimiento y factura -->
		<div id="order-modal" class="modal" aria-hidden="true" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.25)">
			<div id="order-modal-body" style="background:#fff;padding:32px 24px;border-radius:16px;max-width:420px;width:95vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative"></div>
		</div>
		<aside id="nav-drawer" class="nav-drawer" aria-hidden="true">
			<div class="nav-drawer-inner">
				<button id="close-nav" class="close">✕</button>
				<nav class="nav-drawer-list">
					<a class="btn" href="index.html">Inicio</a>
					<button id="nav-products-toggle" class="btn nav-item">Productos ▾</button>
					<ul id="nav-products-submenu" class="nav-submenu" aria-hidden="true">
						<li><a class="btn" href="products.html?cat=all">Todos los productos</a></li>
						<li><a class="btn" href="products.html?cat=peluches">Peluches</a></li>
						<li><a class="btn" href="products.html?cat=tazas">Tazas</a></li>
						<li><a class="btn" href="products.html?cat=vasos">Vasos</a></li>
						<li><a class="btn" href="products.html?cat=mochilas">Mochilas</a></li>
						<li><a class="btn" href="products.html?cat=papeleria">Papelería</a></li>
						<li><a class="btn" href="products.html?cat=decoracion">Decoración</a></li>
						<li><a class="btn" href="products.html?cat=botellas">Botellas</a></li>
						<li><a class="btn" href="products.html?cat=belleza">Belleza</a></li>
						<li><a class="btn" href="products.html?cat=bloques">Bloques</a></li>
					</ul>
					<a class="btn" id="drawer-account" href="user-login.html" style="border-top:1px solid rgba(230,200,215,0.4);padding-top:12px;color:#6b2840;font-weight:700">👤 Iniciar sesión</a>
				</nav>
			</div>
		</aside>

		<main>
			<section class="hero checkout-hero">
				<div class="container hero-inner">
					<h1 class="hero-title">Procesar pedido</h1>
					<p class="hero-sub">Datos de envío, pago y resumen de tu compra.</p>
				</div>
			</section>

			<section class="container checkout-section">
				<div class="checkout-grid">
					<section class="checkout-card">
						<h2>Detalles de facturación y envío</h2>
						<form id="checkout-form" class="checkout-form">
							<div>
								<label>Nombre</label>
								<input name="firstName" placeholder="Nombre" required />
							</div>
							<div>
								<label>Apellidos</label>
								<input name="lastName" placeholder="Apellidos" required />
							</div>
							<div>
								<label>Correo</label>
								<input name="email" type="email" placeholder="correo@ejemplo.com" required />
							</div>
							<div>
								<label>Teléfono</label>
								<input name="phone" type="tel" placeholder="8888-8888" required />
							</div>
							
							<div id="shipping-fields" style="grid-column:1/-1;display:grid;gap:12px;grid-template-columns:1fr 1fr">
								<div>
									<label>Provincia</label>
									<select id="provincia" name="provincia" required>
										<option value="" disabled selected>Selecciona provincia</option>
									</select>
								</div>
								<div>
									<label>Cantón</label>
									<select id="canton" name="canton" required>
										<option value="" disabled selected>Selecciona cantón</option>
									</select>
								</div>
								<div>
									<label>Distrito</label>
									<input id="distrito" name="distrito" placeholder="Distrito" required />
								</div>
								<div>
									<label>Dirección exacta</label>
									<input name="address" placeholder="Casa, referencias, código postal" required />
								</div>
								<div style="grid-column:1/-1">
									<label>Notas de entrega (opcional)</label>
									<textarea name="notes" placeholder="Indicaciones especiales para la entrega" rows="3" style="width:100%;resize:vertical;font-family:inherit;font-size:inherit;padding:10px;border:1px solid #ddd;border-radius:8px;"></textarea>
								</div>
							</div>

							<div class="checkout-radio-group">
								<strong>Método de envío</strong>
								<label class="checkout-radio"><input type="radio" name="shipping" value="correos" checked /> Correos de Costa Rica</label>
							<label class="checkout-radio"><input type="radio" name="shipping" value="pickup" /> Retiro en tienda física (gratis)</label>
								
								<!-- Selector de tienda para retiro -->
								<div id="store-selector-container" style="display:none;margin-left:20px;margin-top:10px;padding:15px;background:#F5E6F0;border-radius:10px;border-left:4px solid #C7499F">
									<label for="pickup-store" style="display:block;font-weight:600;color:#2D4A9C;margin-bottom:8px">📍 Selecciona la tienda de retiro:</label>
									<select id="pickup-store" style="width:100%;padding:12px 14px;border:2px solid #E8F3F8;border-radius:10px;font-family:Montserrat,sans-serif;font-size:0.95rem;cursor:pointer">
										<option value="">-- Selecciona una tienda --</option>
										<option value="tienda1">Sophie Store</option>
										<option value="tienda2">Sophie Mall</option>
										<option value="tienda3">Sophie's Ticados</option>
										<option value="tienda4">Poas</option>
									</select>
								</div>
								
								<strong>Método de pago</strong>
								<div>
								<label class="checkout-radio"><input type="radio" name="payment" value="transferencia" /> Transferencia </label>
							<span class="payment-note">Validamos el depósito en hasta 24 horas hábiles</span>
						</div>
						<div>
							<label class="checkout-radio"><input type="radio" name="payment" value="sinpe" /> SINPE Móvil</label>
							<span class="payment-note">Validamos el pago en hasta 24 horas hábiles</span>
							</div>
							<label class="checkout-radio"><input type="radio" name="payment" value="tarjeta" checked /> Tarjeta de crédito/débito</label>
							<!-- Sección para subir comprobante de pago -->
							<div id="payment-receipt-section" style="display:none;grid-column:1/3;margin-top:10px;padding:20px;background:linear-gradient(135deg, rgba(33,150,243,0.08), rgba(33,150,243,0.03));border-radius:10px;border-left:4px solid #2196f3">
								<h3 style="margin:0 0 12px 0;font-size:1.05rem;color:#1976d2;display:flex;align-items:center;gap:8px">
									📸 Comprobante de Pago
								</h3>
								<p style="font-size:0.9rem;color:#555;margin:0 0 15px 0">
									Por favor, adjunta una foto o captura de pantalla del comprobante de tu transferencia o SINPE Móvil.
								</p>
								<div style="display:flex;flex-direction:column;gap:12px">
									<label style="display:block;cursor:pointer">
										<div id="upload-area" style="border:2px dashed #2196f3;border-radius:10px;padding:30px 20px;text-align:center;background:#fff;transition:all 0.3s ease">
											<div style="font-size:2.5rem;margin-bottom:8px">📁</div>
											<div style="font-weight:600;color:#1976d2;margin-bottom:5px">Haz clic para seleccionar archivo</div>
											<div style="font-size:0.85rem;color:#777">o arrastra y suelta aquí</div>
											<div style="font-size:0.8rem;color:#999;margin-top:8px">Formatos: JPG, PNG, PDF (Max 5MB)</div>
										</div>
										<input type="file" id="payment-receipt" name="payment_receipt" accept="image/jpeg,image/png,image/jpg,application/pdf" style="display:none">
									</label>
									<div id="file-preview" style="display:none;padding:12px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
										<div style="display:flex;align-items:center;justify-content:space-between">
											<div style="display:flex;align-items:center;gap:10px">
												<span style="font-size:1.5rem">📎</span>
												<div>
													<div id="file-name" style="font-weight:600;color:#333;font-size:0.9rem"></div>
													<div id="file-size" style="font-size:0.8rem;color:#777"></div>
												</div>
											</div>
											<button type="button" id="remove-file" style="background:#f44336;color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center">✕</button>
										</div>
									</div>
								</div>
							</div>

							<button type="submit" class="add" style="grid-column:1/3">Realizar pedido</button>
						</form>
					</section>

					<section class="checkout-card">
						<h2>Tu pedido</h2>
						<div id="checkout-items" class="cart-items" style="max-height:340px;overflow:auto"></div>
						<div id="checkout-empty" style="display:none;padding:12px 0;color:#666">Tu carrito está vacío.</div>
						<div class="checkout-summary">
							<div class="amounts">
								<div><span>Subtotal</span><strong id="checkout-subtotal">₡0.00</strong></div>
								<div><span>Envío</span><strong id="checkout-shipping">₡0.00</strong></div>
								<div class="checkout-divider"></div>
								<div><strong>Total</strong><strong id="checkout-total">₡0.00</strong></div>
							</div>
							<div class="checkout-note">Validamos pagos y coordinamos entrega en menos de 24 horas hábiles.</div>
						</div>

						<div id="payment-card-section" style="display:none;margin-top:16px;padding-top:16px;border-top:2px solid rgba(217,70,166,0.2)">
							<h3 style="margin:0 0 14px 0;font-size:1.05rem;color:#6b2840">💳 Datos de la tarjeta</h3>
							<div id="payment-card-fields" style="display:grid;gap:12px">
								<div>
									<label style="font-weight:600;font-size:0.95rem;color:#4a4a4a;display:block;margin-bottom:4px">Número de tarjeta</label>
									<input name="card_number" placeholder="1234 5678 9012 3456" maxlength="19" style="width:100%;padding:10px 12px;border:1px solid #e6e6e6;border-radius:10px;font-size:0.98rem;background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(217,70,166,0.02))" />
								</div>
								<div>
									<label style="font-weight:600;font-size:0.95rem;color:#4a4a4a;display:block;margin-bottom:4px">Nombre del titular</label>
									<input name="card_holder" placeholder="Nombre como aparece en la tarjeta" style="width:100%;padding:10px 12px;border:1px solid #e6e6e6;border-radius:10px;font-size:0.98rem;background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(217,70,166,0.02))" />
								</div>
								<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
									<div>
										<label style="font-weight:600;font-size:0.95rem;color:#4a4a4a;display:block;margin-bottom:4px">Vencimiento (MM/YY)</label>
										<input name="card_expiry" placeholder="12/25" maxlength="5" style="width:100%;padding:10px 12px;border:1px solid #e6e6e6;border-radius:10px;font-size:0.98rem;background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(217,70,166,0.02))" />
									</div>
									<div>
										<label style="font-weight:600;font-size:0.95rem;color:#4a4a4a;display:block;margin-bottom:4px">CVV</label>
										<input name="card_cvv" placeholder="123" maxlength="3" type="password" style="width:100%;padding:10px 12px;border:1px solid #e6e6e6;border-radius:10px;font-size:0.98rem;background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(217,70,166,0.02))" />
									</div>
								</div>
								<p style="font-size:0.82rem;color:#999;margin:10px 0 0 0;padding:10px;background:rgba(217,70,166,0.08);border-radius:8px;border-left:3px solid #C7499F">🔒 Tus datos de tarjeta son seguros y encriptados</p>
							</div>
						</div>
					</section>
				</div>
			</section>
		</main>

		<div id="cart-overlay" class="cart-overlay" aria-hidden="true"></div>
		<aside id="cart-drawer" class="cart-drawer" aria-hidden="true">
			<div class="cart-drawer-header">
				<h3>Tu carrito</h3>
				<button id="close-cart" class="close">✕</button>
			</div>
			<div id="cart-items" class="cart-items"></div>
			<div class="cart-summary">
				<div class="amounts">
					<div><strong>Total</strong><strong id="cart-total">₡0</strong></div>
				</div>
				<div class="cart-actions">
					<button id="clear-cart" class="btn">Vaciar carrito</button>
					<button id="checkout" class="add">Pagar</button>
				</div>
			</div>
		</aside>

		<div id="product-modal" class="modal" aria-hidden="true">
			<div class="modal-content">
				<button id="close-modal" class="close">✕</button>
				<div id="modal-body"></div>
			</div>
		</div>

		<div id="order-modal" class="modal" aria-hidden="true">
			<div class="modal-content" style="text-align:center;padding:40px">
				<button id="close-order-modal" class="close">✕</button>
				<div id="order-modal-body"></div>
			</div>
		</div>

		<script src="script.js"></script>
		<script>
			(function(){
				const itemsNode = document.getElementById('checkout-items');
				const emptyNode = document.getElementById('checkout-empty');
				const subtotalNode = document.getElementById('checkout-subtotal');
				const shippingNode = document.getElementById('checkout-shipping');
				const totalNode = document.getElementById('checkout-total');
				const form = document.getElementById('checkout-form');
				const provinciaSel = document.getElementById('provincia');
				const cantonSel = document.getElementById('canton');
				const distritoInput = document.getElementById('distrito');
				const firstNameInput = form ? form.querySelector('input[name="firstName"]') : null;
				const lastNameInput = form ? form.querySelector('input[name="lastName"]') : null;
				const emailInput = form ? form.querySelector('input[name="email"]') : null;
				const phoneInput = form ? form.querySelector('input[name="phone"]') : null;
				const addressInput = form ? form.querySelector('input[name="address"]') : null;
			const notesInput = form ? form.querySelector('textarea[name="notes"]') : null;

				// Tarifas de Correos de Costa Rica por zona
				const shippingRatesByZone = {
					'GAM': 3500,           // Gran Área Metropolitana
					'Pacifico': 5000,      // Costa Pacífica
					'Atlantico': 5500      // Costa Atlántica y zonas alejadas
				};

				// Clasificación de provincias por zona
				const provinceZones = {
					'San José': 'GAM',
					'Heredia': 'GAM',
					'Alajuela': 'GAM',
					'Cartago': 'GAM',
					'Guanacaste': 'Pacifico',
					'Puntarenas': 'Pacifico',
					'Limón': 'Atlantico'
				};

				// Dataset completo (provincias -> cantones -> distritos) para Costa Rica
				const crLocations = {
					"San José": {
						"San José": ["Carmen","Merced","Hospital","Catedral","Zapote","San Francisco de Dos Ríos","Uruca","Mata Redonda","Pavas","Hatillo","San Sebastián"],
						"Escazú": ["Escazú","San Antonio","San Rafael"],
						"Desamparados": ["Desamparados","San Miguel","San Juan de Dios","San Rafael Arriba","San Antonio","Frailes","Patarrá","San Cristóbal","Rosario","Damas","San Rafael Abajo","Gravilias","Los Guido"],
						"Puriscal": ["Santiago","Mercedes Sur","Barbacoas","Grifo Alto","San Rafael","Candelarita","Desamparaditos","San Antonio","Chires"] ,
						"Tarrazú": ["San Marcos","San Lorenzo","San Carlos"],
						"Aserrí": ["Aserrí","Tarbaca","Vuelta de Jorco","San Gabriel","Legua","Monterrey","Salitrillos"],
						"Mora": ["Colón","Guayabo","Tabarcia","Piedras Negras","Picagres","Jaris","Quitirrisí"],
						"Goicoechea": ["Guadalupe","San Francisco","Calle Blancos","Mata de Plátano","Ipís","Rancho Redondo","Purral"],
						"Santa Ana": ["Santa Ana","Salitral","Pozos","Uruca","Piedades","Brasil"],
						"Alajuelita": ["Alajuelita","San Josecito","San Antonio","Concepción","San Felipe"],
						"Vázquez de Coronado": ["San Isidro","San Rafael","Dulce Nombre de Jesús","Patalillo","Cascajal"],
						"Acosta": ["San Ignacio","Guaitil","Palmichal","Cangrejal","Sabanillas"],
						"Tibás": ["San Juan","Cinco Esquinas","Anselmo Llorente","León XIII","Colima"],
						"Moravia": ["San Vicente","San Jerónimo","La Trinidad"],
						"Montes de Oca": ["San Pedro","Sabanilla","Mercedes","San Rafael"],
						"Turrubares": ["San Pablo","San Pedro","San Juan de Mata","San Luis","Carara"],
						"Dota": ["Santa María","Jardín","Copey"],
						"Curridabat": ["Curridabat","Granadilla","Sánchez","Tirrases"],
						"Pérez Zeledón": ["San Isidro de El General","El General","Daniel Flores","Rivas","San Pedro","Platanares","Pejibaye","Cajón","Barú","Río Nuevo","Páramo"] ,
						"León Cortés": ["San Pablo","San Andrés","Llano Bonito","San Isidro","Santa Cruz","San Antonio"]
					},
					"Alajuela": {
						"Alajuela": ["Alajuela","San José","Carrizal","San Antonio","Guácima","San Isidro","Sabanilla","San Rafael","Río Segundo","Desamparados","Turrúcares","Tambor","Garita","Sarapiquí"],
						"San Ramón": ["San Ramón","Santiago","San Juan","Piedades Norte","Piedades Sur","San Rafael","San Isidro","Angeles","Alfaro","Volio","Concepción","Zapotal","San Isidro de Peñas Blancas"],
						"Grecia": ["Grecia","San Isidro","San José","San Roque","Tacares","Río Cuarto","Puente de Piedra","Bolívar"],
						"San Mateo": ["San Mateo","Desmonte","Jesús María","Labrador"],
						"Atenas": ["Atenas","Jesús","Mercedes","San Isidro","Concepción","San José","Santa Eulalia","Escobal"],
						"Naranjo": ["Naranjo","San Miguel","San José","Cirrí Sur","San Jerónimo","San Juan","El Rosario","Palmitos"],
						"Palmares": ["Palmares","Zaragoza","Buenos Aires","Santiago","Candelaria","Esquipulas","La Granja"],
						"Poás": ["San Pedro","San Juan","San Rafael","Carrillos","Sabana Redonda"],
						"Orotina": ["Orotina","Mastate","Hacienda Vieja","Coyolar","La Ceiba"],
						"San Carlos": ["Quesada","Florencia","Buenavista","Aguas Zarcas","Venecia","Pital","La Fortuna","La Tigra","Palmera","Venado","Cutris","Monterrey","Pocosol"],
						"Zarcero": ["Zarcero","Laguna","Tapezco","Guadalupe","Palmira","Zapote","Brisas"],
						"Sarchí": ["Sarchí Norte","Sarchí Sur","Toro Amarillo","San Pedro","Rodríguez"],
						"Upala": ["Upala","Aguas Claras","San José o Pizote","Bijagua","Delicias","Dos Ríos","Yolillal","Canalete"],
						"Los Chiles": ["Los Chiles","Caño Negro","El Amparo","San Jorge"],
						"Guatuso": ["San Rafael","Buenavista","Cote","Katira"],
						"Río Cuarto": ["Río Cuarto","Santa Rita","Santa Isabel"]
					},
					"Cartago": {
						"Cartago": ["Oriental","Occidental","Carmen","San Nicolás","Aguacaliente o San Francisco","Guadalupe o Arenilla","Corralillo","Tierra Blanca","Dulce Nombre","Llano Grande","Quebradilla"],
						"Paraíso": ["Paraíso","Santiago","Orosi","Cachí","Llanos de Santa Lucía"],
						"La Unión": ["Tres Ríos","San Diego","San Juan","San Rafael","Concepción","Dulce Nombre","San Ramón","Río Azul"],
						"Jiménez": ["Juan Viñas","Tucurrique","Pejibaye"],
						"Turrialba": ["Turrialba","La Suiza","Peralta","Santa Teresita","Pavones","Tuis","Tayutic","Santa Rosa","Tres Equis","La Isabel","Chirripó"],
						"Alvarado": ["Pacayas","Cervantes","Capellades"],
						"Oreamuno": ["San Rafael","Cot","Potrero Cerrado","Cipreses","Santa Rosa"],
						"El Guarco": ["El Tejar","San Isidro","Tobosi","Patio de Agua"]
					},
					"Heredia": {
						"Heredia": ["Heredia","Mercedes","San Francisco","Ulloa","Varablanca"],
						"Barva": ["Barva","San Pedro","San Pablo","San Roque","Santa Lucía","San José de la Montaña"],
						"Santo Domingo": ["Santo Domingo","San Vicente","San Miguel","Paracito","Santo Tomás","Santa Rosa","Tures","Pará"],
						"Santa Bárbara": ["Santa Bárbara","San Pedro","San Juan","Jesús","Santo Domingo","Purabá"],
						"San Rafael": ["San Rafael","San Josecito","Santiago","Angeles","Concepción"],
						"San Isidro": ["San Isidro","San José","Concepción","San Francisco"],
						"Belén": ["San Antonio","La Ribera","La Asunción"],
						"Flores": ["San Joaquín","Barrantes","Llorente"],
						"San Pablo": ["San Pablo","Rincón de Sabanilla"],
						"Sarapiquí": ["Puerto Viejo","La Virgen","Horquetas","Llanuras del Gaspar","Cureña"],
						"San Joaquín": ["San Joaquín"]
					},
					"Guanacaste": {
						"Liberia": ["Liberia","Cañas Dulces","Mayorga","Nacascolo","Curubandé"],
						"Nicoya": ["Nicoya","Mansión","San Antonio","Quebrada Honda","Sámara","Nosara","Belén de Nosarita"],
						"Santa Cruz": ["Santa Cruz","Bolsón","Veintisiete de Abril","Tempate","Cartagena","Cuajiniquil","Diriá","Cabo Velas","Tamarindo"],
						"Bagaces": ["Bagaces","La Fortuna","Mogote","Río Naranjo"],
						"Carrillo": ["Filadelfia","Palmira","Sardinal","Belén"],
						"Cañas": ["Cañas","Palmira","San Miguel","Bebedero","Porozal"],
						"Abangares": ["Las Juntas","Sierra","San Juan","Colorado"],
						"Tilarán": ["Tilarán","Quebrada Grande","Tronadora","Santa Rosa","Líbano","Tierras Morenas","Arenal"],
						"Nandayure": ["Carmona","Santa Rita","Zapotal","San Pablo","Porvenir","Bejuco"],
						"La Cruz": ["La Cruz","Santa Cecilia","Garita","Santa Elena"],
						"Hojancha": ["Hojancha","Monte Romo","Puerto Carrillo","Huacas","Matambú"]
					},
					"Puntarenas": {
						"Puntarenas": ["Puntarenas","Pitahaya","Chomes","Lepanto","Paquera","Manzanillo","Guacimal","Barranca","Monte Verde","Isla del Coco","Cobano","Chacarita","Chira","Acapulco","Roble","Arancibia"],
						"Esparza": ["Espíritu Santo","San Juan Grande","Macacona","San Rafael","San Jerónimo","Caldera"],
						"Buenos Aires": ["Buenos Aires","Volcán","Potrero Grande","Boruca","Pilas","Colinas","Chánguena","Biolley","Brunka"],
						"Montes de Oro": ["Miramar","La Unión","San Isidro"],
						"Osa": ["Puerto Cortés","Palmar","Sierpe","Bahía Ballena","Piedras Blancas","Bahía Drake"],
						"Quepos": ["Quepos","Savegre","Naranjito"],
						"Golfito": ["Golfito","Puerto Jiménez","Guaycará","Pavón"],
						"Coto Brus": ["San Vito","Sabalito","Agua Buena","Limoncito","Pittier","Gutiérrez Brown"],
						"Parrita": ["Parrita"],
						"Corredores": ["Corredor","La Cuesta","Canoas","Laurel"],
						"Garabito": ["Jacó","Tárcoles"]
					},
					"Limón": {
						"Limón": ["Limón","Valle La Estrella","Río Blanco","Matama"],
						"Pococí": ["Guápiles","Jiménez","Rita","Roxana","Cariari","Colorado","La Colonia"],
						"Siquirres": ["Siquirres","Pacuarito","Florida","Germania","Cairo","Alegría"],
						"Talamanca": ["Bratsi","Sixaola","Cahuita","Telire"],
						"Matina": ["Matina","Batán","Carrandí"],
						"Guácimo": ["Guácimo","Mercedes","Pocora","Duacarí","Río Jiménez"]
					}
				};

				const safeFormat = window.formatPrice || function(n){ return '₡' + Number(n||0).toFixed(2); };
				const getCart = window.loadCart || function(){ return JSON.parse(localStorage.getItem('cart_v2')||'[]'); };
				function incrementSoldCounts(cartItems){
					if(!Array.isArray(cartItems)) return;
					const storedProducts = typeof window.loadProductsFromStorage === 'function' ? window.loadProductsFromStorage() : [];
					let changed = false;
					cartItems.forEach(item => {
						const id = item && item.id;
						const qty = Number(item && item.qty) || 0;
						if(!id || qty <= 0) return;
						const p = storedProducts.find(prod => prod.id === id);
						if(p){
							p.sold = (Number(p.sold) || 0) + qty;
							changed = true;
						}
					});
					if(changed && typeof window.saveProductsToStorage === 'function'){
						window.saveProductsToStorage(storedProducts);
						if(Array.isArray(window.products)) window.products = storedProducts;
					}
				}

				function currentShipping(){
					const checked = document.querySelector('input[name="shipping"]:checked');
					return checked ? checked.value : 'correos';
				}

				function getShippingCost(){
					const shippingMethod = currentShipping();
					if(shippingMethod === 'pickup') return 0;
					
					// Para Correos, calcular según la provincia seleccionada
					const selectedProvincia = provinciaSel.value;
					if(!selectedProvincia) return 0; // Sin costo hasta seleccionar provincia
					
					const zone = provinceZones[selectedProvincia] || 'GAM';
					return shippingRatesByZone[zone] || 3500;
				}

				function getShippingLabel(){
					const shippingMethod = currentShipping();
					if(shippingMethod === 'pickup') return 'Gratis';
					
					const selectedProvincia = provinciaSel.value;
					if(!selectedProvincia) return 'Seleccione provincia';
					
					const zone = provinceZones[selectedProvincia] || 'GAM';
					const cost = shippingRatesByZone[zone] || 3500;
					const zoneName = zone === 'GAM' ? 'GAM' : zone === 'Pacifico' ? 'Zona Pacífico' : 'Zona Atlántico';
					return `${safeFormat(cost)} (${zoneName})`;
				}

				function render(){
					const cart = getCart();
					itemsNode.innerHTML = '';
					if(!Array.isArray(cart) || cart.length===0){
						itemsNode.style.display='none';
						emptyNode.style.display='block';
						subtotalNode.textContent = safeFormat(0);
						shippingNode.textContent = getShippingLabel();
						totalNode.textContent = safeFormat(0);
						return;
					}
					itemsNode.style.display='block';
					emptyNode.style.display='none';
					let subtotal = 0;
					cart.forEach(item=>{
						const row = document.createElement('div');
						row.className = 'cart-item';
						const line = (item.price||0) * (item.qty||0);
						subtotal += line;
						row.innerHTML = `
							<img src="${item.img}" alt="${item.title}" />
							<div style="flex:1">
								<div style="display:flex;justify-content:space-between;align-items:center">
									<strong>${item.title}</strong>
									<span>x${item.qty||1}</span>
								</div>
								<div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
									<div class="item-price">${safeFormat(item.price||0)}</div>
									<div class="item-price">${safeFormat(line)}</div>
								</div>
							</div>`;
						itemsNode.appendChild(row);
					});
					const ship = getShippingCost();
					subtotalNode.textContent = safeFormat(subtotal);
					shippingNode.textContent = getShippingLabel();
					totalNode.textContent = safeFormat(subtotal + ship);
				}

				// Dependientes provincia -> canton -> distrito
				function populateProvincias(){
					if(!provinciaSel) return;
					Object.keys(crLocations).forEach(p=>{
						const opt = document.createElement('option');
						opt.value = p;
						opt.textContent = p;
						provinciaSel.appendChild(opt);
					});
				}

				function populateCantones(prov){
					if(!cantonSel) return;
					cantonSel.innerHTML = '<option value="" disabled selected>Selecciona cantón</option>';
					if(distritoInput) distritoInput.value = '';
					if(!crLocations[prov]) return;
					Object.keys(crLocations[prov]).forEach(c=>{
						const opt = document.createElement('option');
						opt.value = c;
						opt.textContent = c;
						cantonSel.appendChild(opt);
					});
				}

				function loadAccounts(){
					try{ return JSON.parse(localStorage.getItem('user_accounts')||'[]'); }
					catch(e){ return []; }
				}

				function saveAccounts(list){
					localStorage.setItem('user_accounts', JSON.stringify(list));
				}

				function loadUserSession(){
					try{ return JSON.parse(localStorage.getItem('user_session')||'null'); }
					catch(e){ return null; }
				}

				function prefillFromSession(){
					const session = loadUserSession();
					if(!session) return;
					if(firstNameInput || lastNameInput){
						const parts = (session.name || '').trim().split(' ');
						if(firstNameInput) firstNameInput.value = parts[0] || '';
						if(lastNameInput) lastNameInput.value = session.lastName || parts.slice(1).join(' ');
					}
					if(emailInput && session.email) emailInput.value = session.email;
					const ship = session.shipping || {};
					if(phoneInput && ship.phone) phoneInput.value = ship.phone;
					if(provinciaSel && ship.provincia){
						provinciaSel.value = ship.provincia;
						populateCantones(ship.provincia);
					}
					if(cantonSel && ship.canton){ cantonSel.value = ship.canton; }
					if(distritoInput && ship.distrito){ distritoInput.value = ship.distrito; }
				if(addressInput && ship.address){ addressInput.value = ship.address; }
				if(notesInput && ship.notes){ notesInput.value = ship.notes; }

					render();
				}

				function collectShippingFromForm(){
					return {
						phone: phoneInput ? phoneInput.value.trim() : '',
						provincia: provinciaSel ? provinciaSel.value : '',
						canton: cantonSel ? cantonSel.value : '',
						distrito: distritoInput ? distritoInput.value.trim() : '',
						zip: '',
					address: addressInput ? addressInput.value.trim() : '',
					notes: notesInput ? notesInput.value.trim() : ''
				};
			}

			function saveShippingToAccount(){
				const session = loadUserSession();
				if(!session || !session.email){
					alert('Inicia sesión para guardar tu dirección.');
						return;
					}
					const accounts = loadAccounts();
					const idx = accounts.findIndex(acc => (acc.email||'').toLowerCase() === (session.email||'').toLowerCase());
					if(idx === -1){
						alert('No se encontró tu cuenta local.');
						return;
					}
					const ship = collectShippingFromForm();
					accounts[idx].shipping = ship;
					const newFirst = firstNameInput ? firstNameInput.value.trim() : '';
					const newLast = lastNameInput ? lastNameInput.value.trim() : '';
					if(newFirst) accounts[idx].name = newFirst;
					if(newLast) accounts[idx].lastName = newLast;
					saveAccounts(accounts);
					// Actualizar sesión
					const newSession = { ...session, shipping: ship, name: accounts[idx].name, lastName: accounts[idx].lastName || '' };
					localStorage.setItem('user_session', JSON.stringify(newSession));
					alert('Dirección guardada para futuras compras.');
				}

				// Poblar provincias al cargar
				populateProvincias();
				prefillFromSession();
				
				// Renderizar carrito inicial
				render();

				// Botón para guardar dirección
				if(form){
					const submitBtn = form.querySelector('button[type="submit"]');
					// Verificar que no exista ya un botón de guardar dirección
					const existingSaveBtn = form.querySelector('button.btn[type="button"]');
					if(submitBtn && !existingSaveBtn){
						saveAddressBtn = document.createElement('button');
						saveAddressBtn.type = 'button';
						saveAddressBtn.textContent = 'Guardar dirección en mi cuenta';
						saveAddressBtn.className = 'btn';
						saveAddressBtn.style.cssText = 'grid-column:1/3;margin:8px 0 0 0';
						submitBtn.parentNode.insertBefore(saveAddressBtn, submitBtn);
						saveAddressBtn.addEventListener('click', saveShippingToAccount);
					}
				}

				if(provinciaSel) provinciaSel.addEventListener('change',()=>{
					populateCantones(provinciaSel.value);
					render(); // Actualiza tarifa de envío según zona
				});
				if(cantonSel) cantonSel.addEventListener('change',()=>{
					render(); // Actualiza totales
				});
				if(distritoInput) distritoInput.addEventListener('input',()=>{
					render(); // Actualiza totales
				});

				const shippingRadios = document.querySelectorAll('input[name="shipping"]');
				const shippingFields = document.getElementById('shipping-fields');
				const storeSelector = document.getElementById('store-selector-container');
				const pickupStore = document.getElementById('pickup-store');
				
				function toggleShippingFields(){
					const isCorreos = document.querySelector('input[name="shipping"]:checked').value === 'correos';
					const isPickup = document.querySelector('input[name="shipping"]:checked').value === 'pickup';
					
					if(shippingFields){
						shippingFields.style.display = isCorreos ? 'grid' : 'none';
					}
					
					if(storeSelector){
						storeSelector.style.display = isPickup ? 'block' : 'none';
						if(isPickup && pickupStore) pickupStore.setAttribute('required', 'required');
						else if(pickupStore) pickupStore.removeAttribute('required');
					}
					
					// Actualizar atributo required para campos de envío
					const requiredFields = shippingFields ? shippingFields.querySelectorAll('input[required], select[required], textarea[required]') : [];
					requiredFields.forEach(field => {
						if(isCorreos) field.setAttribute('required', 'required');
						else field.removeAttribute('required');
					});
				}
				
				shippingRadios.forEach(r=> {
					r.addEventListener('change', ()=>{
						toggleShippingFields();
						render();
					});
				});
				
				toggleShippingFields();

				// Mostrar/ocultar campos de tarjeta según método de pago
				const paymentRadios = document.querySelectorAll('input[name="payment"]');
				const cardSection = document.getElementById('payment-card-section');
				const receiptSection = document.getElementById('payment-receipt-section');
				
				function toggleCardFields(){
					const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
					const isTarjeta = paymentMethod === 'tarjeta';
					const needsReceipt = paymentMethod === 'transferencia' || paymentMethod === 'sinpe';
					
					if(cardSection){
						cardSection.style.display = isTarjeta ? 'block' : 'none';
					}
					
					if(receiptSection){
						receiptSection.style.display = needsReceipt ? 'block' : 'none';
					}
					
					// Actualizar atributo required para campos de tarjeta
					const cardInputs = cardSection ? cardSection.querySelectorAll('input') : [];
					cardInputs.forEach(input => {
						if(isTarjeta) input.setAttribute('required', 'required');
						else input.removeAttribute('required');
					});
					
					// Actualizar atributo required para comprobante
					const receiptInput = document.getElementById('payment-receipt');
					if(receiptInput){
						if(needsReceipt) receiptInput.setAttribute('required', 'required');
						else receiptInput.removeAttribute('required');
					}
				}
				
				paymentRadios.forEach(r=> {
					r.addEventListener('change', toggleCardFields);
				});
				
				// Manejo de carga de archivo de comprobante
				const receiptInput = document.getElementById('payment-receipt');
				const uploadArea = document.getElementById('upload-area');
				const filePreview = document.getElementById('file-preview');
				const fileName = document.getElementById('file-name');
				const fileSize = document.getElementById('file-size');
				const removeFileBtn = document.getElementById('remove-file');
				
				if(receiptInput && uploadArea){
					// Click en área de carga
					uploadArea.addEventListener('click', () => receiptInput.click());
					
					// Drag and drop
					uploadArea.addEventListener('dragover', (e) => {
						e.preventDefault();
						uploadArea.style.borderColor = '#1976d2';
						uploadArea.style.background = 'rgba(33,150,243,0.1)';
					});
					
					uploadArea.addEventListener('dragleave', (e) => {
						e.preventDefault();
						uploadArea.style.borderColor = '#2196f3';
						uploadArea.style.background = '#fff';
					});
					
					uploadArea.addEventListener('drop', (e) => {
						e.preventDefault();
						uploadArea.style.borderColor = '#2196f3';
						uploadArea.style.background = '#fff';
						
						if(e.dataTransfer.files.length > 0){
							receiptInput.files = e.dataTransfer.files;
							displayFilePreview(e.dataTransfer.files[0]);
						}
					});
					
					// Cambio de archivo
					receiptInput.addEventListener('change', (e) => {
						if(e.target.files.length > 0){
							displayFilePreview(e.target.files[0]);
						}
					});
					
					// Remover archivo
					if(removeFileBtn){
						removeFileBtn.addEventListener('click', (e) => {
							e.preventDefault();
							e.stopPropagation();
							receiptInput.value = '';
							filePreview.style.display = 'none';
							uploadArea.style.display = 'block';
						});
					}
					
					function displayFilePreview(file){
						// Validar tamaño (5MB max)
						if(file.size > 5 * 1024 * 1024){
							alert('El archivo es demasiado grande. El tamaño máximo es 5MB.');
							receiptInput.value = '';
							return;
						}
						
						// Validar tipo
						const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
						if(!validTypes.includes(file.type)){
							alert('Tipo de archivo no válido. Solo se permiten JPG, PNG o PDF.');
							receiptInput.value = '';
							return;
						}
						
						// Mostrar preview
						fileName.textContent = file.name;
						fileSize.textContent = formatFileSize(file.size);
						uploadArea.style.display = 'none';
						filePreview.style.display = 'block';
					}
					
					function formatFileSize(bytes){
						if(bytes < 1024) return bytes + ' B';
						if(bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
						return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
					}
				}

				function generateOrderNumber(){
					const date = new Date();
					const year = date.getFullYear();
					const month = String(date.getMonth() + 1).padStart(2, '0');
					const day = String(date.getDate()).padStart(2, '0');
					const randomNum = String(Math.floor(Math.random() * 100000)).padStart(5, '0');
					return `ORD-${year}${month}${day}-${randomNum}`;
				}

				if(form){
					form.addEventListener('submit',(e)=>{
						e.preventDefault();
						const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
						const shippingMethod = document.querySelector('input[name="shipping"]:checked').value;
						const userEmail = document.querySelector('input[name="email"]').value;
						const requiresValidation = paymentMethod === 'sinpe' || paymentMethod === 'transferencia';
						const cartItems = getCart();

						// Validación visual de campos requeridos para Correos
						if(shippingMethod === 'correos'){
							let missing = [];
							const provincia = provinciaSel.value;
							const canton = cantonSel.value;
							const distrito = distritoInput.value.trim();
							const address = addressInput.value.trim();
							if(!provincia) missing.push('Provincia');
							if(!canton) missing.push('Cantón');
							if(!distrito) missing.push('Distrito');
							if(!address) missing.push('Dirección exacta');
							if(missing.length > 0){
								alert('Por favor completa los siguientes campos de envío: ' + missing.join(', '));
								// Resaltar los campos faltantes
								if(!provincia) provinciaSel.style.borderColor = '#C7499F'; else provinciaSel.style.borderColor = '';
								if(!canton) cantonSel.style.borderColor = '#C7499F'; else cantonSel.style.borderColor = '';
								if(!distrito) distritoInput.style.borderColor = '#C7499F'; else distritoInput.style.borderColor = '';
								if(!address) addressInput.style.borderColor = '#C7499F'; else addressInput.style.borderColor = '';
								return;
							}
						}
						// Decrementar inventario de productos al comprar online
						(function decrementInventory(cartItems, shippingMethod, pickupStoreKey) {
							if (!Array.isArray(cartItems)) return;
							const storedProducts = typeof window.loadProductsFromStorage === 'function' ? window.loadProductsFromStorage() : [];
							let changed = false;
							cartItems.forEach(item => {
								const id = item && item.id;
								const qty = Number(item && item.qty) || 0;
								const itemBarcode = item && item.barcode ? String(item.barcode) : '';
								if (!id || qty <= 0) return;
								const p = storedProducts.find(prod => prod.id === id);
								if (p) {
									// Si el producto tiene variantes, buscar la opción por barcode (o por nombre si existe)
									if (p.variants && p.variants.options && p.variants.options.length > 0 && itemBarcode) {
										let opt = (p.variants.options || []).find(o => String(o.barcode || '') === itemBarcode);
										if (!opt && item.variant) {
											opt = (p.variants.options || []).find(o => o.name === item.variant);
										}
										if (opt && opt.inventory) {
											let left = qty;
											let keys;
											if (shippingMethod === 'pickup' && pickupStoreKey && opt.inventory[pickupStoreKey] !== undefined) {
												// Solo descontar de la tienda seleccionada
												keys = [pickupStoreKey];
											} else {
												// Decrementar de bodega primero, luego tiendas
												keys = ['bodega', 'tienda1', 'tienda2', 'tienda3', 'tienda4'];
											}
											for (const k of keys) {
													if (typeof opt.inventory[k] === 'number' && opt.inventory[k] > 0 && left > 0) {
													const take = Math.min(opt.inventory[k], left);
													opt.inventory[k] -= take;
													left -= take;
												}
											}
											changed = true;
										}
									} else if (p.inventory) {
										let left = qty;
										let keys;
										if (shippingMethod === 'pickup' && pickupStoreKey && p.inventory[pickupStoreKey] !== undefined) {
											keys = [pickupStoreKey];
										} else {
											keys = ['bodega', 'tienda1', 'tienda2', 'tienda3', 'tienda4'];
										}
										for (const k of keys) {
											if (typeof p.inventory[k] === 'number' && p.inventory[k] > 0 && left > 0) {
												const take = Math.min(p.inventory[k], left);
												p.inventory[k] -= take;
												left -= take;
											}
										}
										changed = true;
									}
								}
							});
							if (changed) {
								if (typeof window.saveProductsToStorage === 'function') {
									window.saveProductsToStorage(storedProducts);
								} else {
									localStorage.setItem('products_data', JSON.stringify(storedProducts));
								}
								if (Array.isArray(window.products)) window.products = storedProducts;
							}
						})(cartItems, shippingMethod, (shippingMethod === 'pickup' ? document.getElementById('pickup-store').value : null));
						
						// Capturar información de retiro en tienda si aplica
						let pickupStoreInfo = '';
						let pickupStoreKey = '';
						if(shippingMethod === 'pickup'){
							const pickupStore = document.getElementById('pickup-store').value;
							const storeNames = {
								'tienda1': 'Sophie Store',
								'tienda2': 'Sophie Mall',
								'tienda3': 'Sophie\'s Ticados',
								'tienda4': 'Poas'
							};
							pickupStoreInfo = storeNames[pickupStore] || 'Tienda no especificada';
							pickupStoreKey = pickupStore;
						}
						
						// Guardar la orden en invoiceHistory como venta de tienda virtual
						const orderNum = generateOrderNumber();
						const invoiceHistory = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
						
						// Manejar el archivo del comprobante si existe
						let receiptData = null;
						const receiptInput = document.getElementById('payment-receipt');
						if(receiptInput && receiptInput.files && receiptInput.files.length > 0){
							const file = receiptInput.files[0];
							// Convertir archivo a base64 para almacenamiento
							const reader = new FileReader();
							reader.onloadend = function() {
								receiptData = {
									name: file.name,
									type: file.type,
									size: file.size,
									data: reader.result // base64
								};
								console.log('✅ Comprobante cargado:', file.name, '(' + (file.size/1024).toFixed(1) + ' KB)');
							};
							reader.readAsDataURL(file);
						}
						
						const invoice = {
							id: orderNum,
							date: new Date().toISOString(),
							source: 'tienda_virtual',
							cashier: 'Tienda Virtual',
							store: 'tienda_virtual',
							paymentMethods: [{method: paymentMethod, amount: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0)}],
							items: cartItems,
							subtotal: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0),
							discount: 0,
							shippingMethod: shippingMethod,
							pickupStore: pickupStoreKey,
							pickupStoreInfo: pickupStoreInfo,
							customerEmail: userEmail,
							customerName: userEmail.split('@')[0],
							status: 'pendiente',
							paymentReceipt: receiptData
						};
						
						invoiceHistory.push(invoice);
						localStorage.setItem('invoiceHistory', JSON.stringify(invoiceHistory));
						console.log('✅ Venta de tienda virtual guardada:', invoice);
						
						// TAMBIÉN guardar en onlineOrders para el tab de Pedidos Online
						const onlineOrders = JSON.parse(localStorage.getItem('onlineOrders') || '[]');
						console.log('📦 Pedidos existentes antes de agregar:', onlineOrders);
						
						const onlineOrder = {
							id: orderNum,
							date: new Date().toISOString(),
							customerEmail: userEmail,
							paymentMethod: paymentMethod,
							total: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0),
							status: paymentMethod === 'tarjeta' ? 'confirmado' : 'pendiente',
							items: cartItems,
							shippingMethod: shippingMethod,
							confirmedDate: paymentMethod === 'tarjeta' ? new Date().toISOString() : null,
							dispatchedDate: null,
							paymentReceipt: receiptData
						};
						onlineOrders.push(onlineOrder);
						localStorage.setItem('onlineOrders', JSON.stringify(onlineOrders));
						console.log('✅ Pedido online guardado en onlineOrders:', onlineOrder);
						console.log('✅ Total de pedidos ahora:', onlineOrders.length);
						
						if(paymentMethod === 'tarjeta'){
							// Modal de agradecimiento y factura para tarjeta
							let facturaHTML = `
								<style>
									@media print {
										body { margin: 0; padding: 0; }
										#receipt-content { width: 100%; }
										.print-receipt-btn, .order-confirm-btn { display: none; }
										.buttons-container { display: none; }
									}
								</style>
								<div id="receipt-content" style="padding:0;background:linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);border-radius:12px;font-family:Montserrat,Arial,sans-serif">
									<div style="text-align:center;margin:0;padding:20px 20px 15px 20px;border-bottom:3px solid #C7499F">
										<h1 style="font-family:'Daily',serif;color:#2c4a8c;font-size:2.2rem;margin:0 0 5px 0;letter-spacing:2px">SophieWeb</h1>
										<p style="color:#C7499F;margin:0;font-weight:600;font-size:0.9rem">Tienda Online</p>
									</div>
									
									<div style="background:transparent;padding:15px 20px;margin:0;border-radius:0;box-shadow:none">
										<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px">
											<div>
												<p style="color:#999;font-size:0.8rem;margin:0 0 3px 0">NÚMERO DE FACTURA</p>
												<p style="font-size:1.2rem;font-weight:700;color:#2c4a8c;margin:0;font-family:monospace;letter-spacing:2px">${orderNum}</p>
											</div>
											<div style="text-align:right">
												<p style="color:#999;font-size:0.8rem;margin:0 0 3px 0">FECHA</p>
												<p style="font-size:1rem;font-weight:600;color:#333;margin:0">${new Date().toLocaleDateString('es-CR')}</p>
											</div>
										</div>
										<div style="padding-top:12px;border-top:1px solid #e0e0e0">
											<p style="color:#999;font-size:0.8rem;margin:0 0 3px 0">CLIENTE</p>
											<p style="font-size:0.95rem;color:#333;margin:0;font-weight:500">${userEmail}</p>
										</div>
									</div>
									
									<div style="background:transparent;padding:15px 20px;margin:0;border-radius:0;box-shadow:none">
										<h3 style="color:#2c4a8c;margin:0 0 12px 0;font-size:1rem;font-weight:700">PRODUCTOS</h3>
										<table style='width:100%;font-size:0.85rem;border-collapse:collapse;min-width:300px'>
											<thead>
												<tr style='background:#F5E6F0;border-bottom:2px solid #C7499F'>
													<th style='text-align:left;padding:10px;color:#2c4a8c;font-weight:700;width:45%'>Producto</th>
													<th style='text-align:center;padding:10px;color:#2c4a8c;font-weight:700;width:15%'>Cant.</th>
													<th style='text-align:right;padding:10px;color:#2c4a8c;font-weight:700;width:20%'>Precio</th>
													<th style='text-align:right;padding:10px;color:#2c4a8c;font-weight:700;width:20%'>Total</th>
												</tr>
											</thead>
											<tbody>
												${cartItems.map(item => `<tr style='border-bottom:1px solid #e0e0e0'><td style='padding:10px;white-space:normal'><strong style="color:#333">${item.title}</strong>${item.variant ? '<br><span style="color:#999;font-size:0.75rem">'+item.variant+'</span>' : ''}</td><td style='text-align:center;padding:10px'>${item.qty}</td><td style='text-align:right;padding:10px'>₡${(item.price).toFixed(2)}</td><td style='text-align:right;padding:10px;font-weight:700;color:#2c4a8c'>₡${(item.price*item.qty).toFixed(2)}</td></tr>`).join('')}
											</tbody>
										</table>
									</div>
									
									<div style="background:linear-gradient(135deg, rgba(217,70,166,0.08), rgba(44,74,140,0.08));padding:15px 20px;margin:0;border-radius:0;border-left:5px solid #C7499F">
										<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:0.9rem">
											<span style="color:#666;font-weight:500">Subtotal:</span>
											<span style="font-weight:600;color:#333">₡${invoice.subtotal.toFixed(2)}</span>
										</div>
										<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(0,0,0,0.15);font-size:0.9rem">
											<span style="color:#666;font-weight:500">Envío:</span>
											<span style="font-weight:600;color:#333">${shippingMethod==='pickup' ? 'Gratis' : '₡' + getShippingCost().toFixed(2)}</span>
										</div>
										<div style="display:flex;justify-content:space-between;align-items:center;padding-top:8px">
											<span style="color:#2c4a8c;font-size:1rem;font-weight:700">TOTAL A PAGAR:</span>
											<span style="font-size:1.3rem;font-weight:700;color:#C7499F">₡${(invoice.subtotal + (shippingMethod==='pickup'?0:getShippingCost())).toFixed(2)}</span>
										</div>
									</div>
									
									<div style="text-align:center;margin:0;padding:15px 20px 20px 20px;border-top:1px solid #e0e0e0">
										<p style="color:#999;font-size:0.85rem;margin:0 0 3px 0">Gracias por tu compra en SophieWeb</p>
										<p style="color:#999;font-size:0.85rem;margin:0 0 8px 0">www.sophieshop.com</p>
										<p style="color:#C7499F;font-size:0.8rem;margin:0">✓ Pago recibido exitosamente</p>
									</div>
								</div>`;
							let modal = document.getElementById('order-modal');
							let modalBody = document.getElementById('order-modal-body');
							
							// Crear contenedor para botones
							const buttonsHTML = `<div class="buttons-container" style="display:flex;gap:10px;margin-top:15px;width:100%">
								<button class="print-receipt-btn" style="flex:1;padding:12px;background:#2D4A9C;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.95rem;transition:background 0.3s">🖨️ Imprimir</button>
								<button class="add order-confirm-btn" style="flex:1;padding:12px;font-size:0.95rem">Cerrar</button>
							</div>`;
							
							modalBody.innerHTML = facturaHTML + buttonsHTML;
							modal.setAttribute('aria-hidden', 'false');
							
							// Botón de impresión
							const printBtn = modalBody.querySelector('.print-receipt-btn');
							if(printBtn){
								printBtn.addEventListener('click', ()=>{
									window.print();
								});
							}
							
							const confirmBtn = modalBody.querySelector('.order-confirm-btn');
							confirmBtn.addEventListener('click', ()=>{
								modal.setAttribute('aria-hidden', 'true');
								localStorage.removeItem('cart_v2');
								if(typeof window.renderCartCount === 'function') window.renderCartCount([]);
								window.location.href = 'index.html';
							});
						} else if(requiresValidation){
							const paymentText = paymentMethod === 'sinpe' ? 'SINPE Móvil' : 'Transferencia Bancaria';
							let orderDetailsHTML = `
								<style>
									@media print {
										body { margin: 0; padding: 0; }
										.print-receipt-btn, .order-confirm-btn { display: none; }
										.buttons-container { display: none; }
									}
								</style>
								<div style="padding:0;background:linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);border-radius:12px;font-family:Montserrat,Arial,sans-serif">
									<div style="text-align:center;margin:0;padding:20px 20px 15px 20px;border-bottom:3px solid #C7499F">
										<h1 style="font-family:'Daily',serif;color:#2c4a8c;font-size:2.2rem;margin:0 0 5px 0;letter-spacing:2px">SophieWeb</h1>
										<p style="color:#C7499F;margin:0;font-weight:600;font-size:0.9rem">Tienda Online</p>
									</div>
									
									<div style="background:transparent;padding:15px 20px;margin:0">
										<div style="text-align:center;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #e0e0e0">
											<p style="color:#999;font-size:0.8rem;margin:0 0 5px 0">TU NÚMERO DE ORDEN</p>
											<p style="font-size:2rem;font-weight:700;color:#2c4a8c;margin:0;font-family:monospace;letter-spacing:3px">${orderNum}</p>
										</div>
										
										<div style="background:linear-gradient(135deg, rgba(255,152,0,0.08), rgba(255,193,7,0.08));padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ff9800">
											<p style="color:#999;font-size:0.75rem;margin:0 0 3px 0;text-transform:uppercase">Estado del Pedido</p>
											<p style="font-size:1rem;font-weight:700;color:#e65100;margin:0 0 3px 0">⏳ Pendiente de Verificación</p>
											<p style="font-size:0.8rem;color:#666;margin:0">Validaremos tu pago en hasta 24 horas hábiles</p>
										</div>
										
										<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e0e0e0">
											<p style="color:#999;font-size:0.75rem;margin:0 0 3px 0;text-transform:uppercase">Método de Pago</p>
											<p style="font-size:0.95rem;color:#333;margin:0;font-weight:600">${paymentText}</p>
										</div>
										
										<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e0e0e0">
											<p style="color:#999;font-size:0.75rem;margin:0 0 3px 0;text-transform:uppercase">Correo de Contacto</p>
											<p style="font-size:0.9rem;color:#333;margin:0;font-weight:500">${userEmail}</p>
										</div>
										
										${pickupStoreInfo ? `<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e0e0e0">
											<p style="color:#999;font-size:0.75rem;margin:0 0 3px 0;text-transform:uppercase">Punto de Retiro</p>
											<p style="font-size:0.9rem;color:#333;margin:0;font-weight:500">${pickupStoreInfo}</p>
										</div>` : ''}
										
										${receiptData ? `<div style="margin-top:12px;padding:10px;background:#e8f5e9;border-left:4px solid #4caf50;border-radius:6px">
											<p style="margin:0;color:#2e7d32;font-size:0.8rem"><strong>✓ Comprobante recibido:</strong> ${receiptData.name}</p>
										</div>` : ''}
									</div>
									
									<div style="background:linear-gradient(135deg, rgba(255,152,0,0.08), rgba(255,193,7,0.08));border-left:4px solid #ff9800;padding:12px 15px;margin:15px 20px;border-radius:6px">
										<p style="color:#e65100;margin:0 0 3px 0;font-size:0.85rem;font-weight:700">ℹ️ Próximos pasos:</p>
										<p style="color:#e65100;margin:0;font-size:0.8rem">Verificaremos tu comprobante de pago y confirmaremos tu pedido por correo electrónico.</p>
									</div>
									
									<div style="text-align:center;margin:0;padding:12px 20px 15px 20px;border-top:1px solid #e0e0e0">
										<p style="color:#999;font-size:0.8rem;margin:0 0 3px 0">Gracias por tu compra en SophieWeb</p>
										<p style="color:#999;font-size:0.9rem;margin:0">www.sophieshop.com</p>
									</div>
								</div>`;
							
							// Crear botones para transferencia/SINPE
							const buttonsHTMLTransfer = `<div class="buttons-container" style="display:flex;gap:10px;margin-top:12px;width:100%">
								<button class="print-receipt-btn" style="flex:1;padding:12px;background:#2D4A9C;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.9rem;transition:background 0.3s">🖨️ Imprimir</button>
								<button class="add order-confirm-btn" style="flex:1;padding:12px;font-size:0.9rem">Entendido</button>
							</div>`;
							
							// Corregir referencia al modal y su body
							let orderModal = document.getElementById('order-modal');
							let orderModalBody = document.getElementById('order-modal-body');
							orderModalBody.innerHTML = orderDetailsHTML + buttonsHTMLTransfer;
							orderModal.setAttribute('aria-hidden', 'false');
							
							// Botón de impresión para transferencia
							const printBtnTransfer = orderModalBody.querySelector('.print-receipt-btn');
							if(printBtnTransfer){
								printBtnTransfer.addEventListener('click', ()=>{
									window.print();
								});
							}
							
							const confirmBtn = orderModalBody.querySelector('.order-confirm-btn');
							confirmBtn.addEventListener('click', ()=>{
								orderModal.setAttribute('aria-hidden', 'true');
								localStorage.removeItem('cart_v2');
								if(typeof window.renderCartCount === 'function') window.renderCartCount([]);
								window.location.href = 'index.html';
							});
						} else {
							const confirmMsg = pickupStoreInfo 
								? `Gracias por tu compra.\n\nRetiro en: ${pickupStoreInfo}\n\nProto te contactaremos para confirmar.`
								: 'Gracias por tu compra. Pronto te contactaremos para procesar el pago.';
							alert(confirmMsg);
							localStorage.removeItem('cart_v2');
							if(typeof window.renderCartCount === 'function') window.renderCartCount([]);
							render();
						}
					});
				}
			})();
		</script>
	</body>
</html>
