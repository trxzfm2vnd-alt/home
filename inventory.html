<!doctype html>
<html lang="es">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario - Sophie</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
      .admin-tabs {
        max-width: 1400px;
        margin: 20px auto 0;
        padding: 0 20px;
        display: flex;
        gap: 4px;
        border-bottom: 2px solid #e3cfe0;
      }
      .admin-tab {
        padding: 14px 28px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #666;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: Montserrat, sans-serif;
        text-decoration: none;
        display: inline-block;
      }
      .admin-tab:hover {
        color: #5a2032;
        background: rgba(243, 229, 245, 0.3);
      }
      .admin-tab.active {
        color: #d946a6;
        border-bottom-color: #d946a6;
        background: rgba(243, 229, 245, 0.5);
      }
      .inventory-container {
        max-width: 1400px;
        margin: 20px auto 40px;
        padding: 20px;
      }
      .inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--accent);
      }
      .inventory-header h1 {
        font-family: Playfair Display, serif;
        color: #5a2032;
        margin: 0;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(82, 44, 60, 0.1);
        border-left: 4px solid;
      }
      .stat-card.tienda1 { border-left-color: #ff6b9d; }
      .stat-card.tienda2 { border-left-color: #5a8dee; }
      .stat-card.tienda3 { border-left-color: #ffc107; }
      .stat-card.bodega { border-left-color: #4caf50; }
      .stat-card.total { border-left-color: #d946a6; }
      
      .stat-card h3 {
        margin: 0 0 8px 0;
        color: #5a2032;
        font-size: 1rem;
        font-weight: 600;
      }
      .stat-card .value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #d946a6;
        margin: 0;
      }
      .stat-card .label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 4px;
      }
      .search-filter {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .search-filter input,
      .search-filter select {
        padding: 10px;
        border: 1px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
      }
      .search-filter input {
        flex: 1;
        min-width: 250px;
      }
      .inventory-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow-x: auto;
        overflow-y: visible;
        box-shadow: 0 4px 20px rgba(82, 44, 60, 0.1);
      }
      .inventory-table table {
        width: 100%;
        min-width: 1200px;
        border-collapse: collapse;
      }
      .inventory-table th {
        background: linear-gradient(135deg, #f3e5f5, #fce4ec);
        padding: 12px 10px;
        text-align: left;
        font-weight: 700;
        color: #5a2032;
        font-size: 0.85rem;
        white-space: nowrap;
      }
      .inventory-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #f0f0f0;
        color: #3a2f33;
        font-size: 0.9rem;
      }
      .inventory-table tr:hover {
        background: #fff8fb;
      }
      .product-img-small {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
      }
      .stock-cell {
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        min-width: 60px;
      }
      .stock-low {
        color: #f44336;
      }
      .stock-medium {
        color: #ff9800;
      }
      .stock-good {
        color: #4caf50;
      }
      .btn-adjust {
        padding: 6px 10px;
        background: #5a8dee;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.8rem;
      }
      .btn-adjust:hover {
        background: #3a70d6;
      }
      .btn-export {
        padding: 12px 24px;
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-export:hover {
        box-shadow: 0 4px 14px rgba(76, 175, 80, 0.5);
        transform: translateY(-2px);
      }
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
      }
      .modal-content h2 {
        margin-top: 0;
        color: #5a2032;
        font-family: Playfair Display, serif;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #5a2032;
      }
      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
        font-size: 0.95rem;
      }
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }
      .btn-cancel {
        padding: 10px 20px;
        background: #9e9e9e;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-cancel:hover {
        background: #757575;
      }
      .btn-save {
        padding: 10px 20px;
        background: linear-gradient(135deg, #5a8dee, #3a70d6);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn-save:hover {
        box-shadow: 0 4px 14px rgba(74, 144, 226, 0.5);
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <button id="hamburger" class="hamburger" aria-label="Abrir men√∫">‚ò∞</button>
        <a href="index.html" class="logo" style="text-decoration:none;cursor:pointer;display:flex;align-items:center;gap:10px">
          <svg width="32" height="32" viewBox="0 0 32 32" style="flex-shrink:0;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1))">
            <defs>
              <linearGradient id="giftGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ff6b9d;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#d946a6;stop-opacity:1" />
              </linearGradient>
              <linearGradient id="ribbonGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ffed4e;stop-opacity:1" />
              </linearGradient>
            </defs>
            <rect x="4" y="10" width="24" height="16" rx="2" fill="url(#giftGradient)" />
            <path d="M 4 10 Q 16 4 28 10" fill="#ff8ab3" />
            <rect x="14" y="4" width="4" height="22" fill="url(#ribbonGradient)" />
            <rect x="4" y="14" width="24" height="3" fill="url(#ribbonGradient)" />
            <circle cx="16" cy="8" r="3" fill="#ffd700" />
            <ellipse cx="8" cy="14" rx="2" ry="3" fill="rgba(255,255,255,0.4)" />
          </svg>
          <span style="font-size:1.3rem;font-weight:700;color:white">Sophie - Inventario</span>
        </a>
        <a href="index.html" class="btn">‚Üê Volver a la tienda</a>
        <button id="logout-btn" class="btn" style="color:#f44336;font-weight:700">Cerrar Sesi√≥n</button>
      </div>
    </header>

    <div id="nav-overlay" class="nav-overlay" aria-hidden="true"></div>
    <aside id="nav-drawer" class="nav-drawer" aria-hidden="true">
      <div class="nav-drawer-inner">
        <button id="close-nav" class="close">‚úï</button>
        <nav class="nav-drawer-list">
          <a class="btn" href="index.html">Inicio</a>
          <a class="btn" href="admin.html">Administraci√≥n</a>
          <a class="btn" href="pos.html">Punto de Ventas</a>
          <a class="btn active" href="inventory.html">Inventario</a>
        </nav>
      </div>
    </aside>

    <!-- Tabs de navegaci√≥n -->
    <div class="admin-tabs">
      <a href="pos.html" class="admin-tab">üí≥ Punto de Ventas</a>
      <a href="#" onclick="openApartadosTab(); return false;" class="admin-tab">üìã Apartados</a>
      <a href="#" onclick="openPedidosOnlineTab(); return false;" class="admin-tab">üì¶ Pedidos Online</a>
      <a href="#" onclick="checkAdminAccessAndNavigate('admin.html'); return false;" class="admin-tab">üì¶ Administraci√≥n</a>
      <a href="inventory.html" class="admin-tab active">üìä Inventario</a>
    </div>

    <main class="inventory-container">
      <div class="inventory-header">
        <h1>Gesti√≥n de Inventario</h1>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-export" id="btn-add-product-inventory" style="background:#d946a6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600">+ Agregar Producto</button>
          <button class="btn-export" id="export-inventory">üì• Exportar Inventario</button>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div class="stats-grid">
        <div class="stat-card tienda1">
          <h3>üè™ Sophie Store</h3>
          <div class="value" id="stat-tienda1">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card tienda2">
          <h3>üè™ Sophie Mall</h3>
          <div class="value" id="stat-tienda2">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card tienda3">
          <h3>üè™ Sophie's Ticados</h3>
          <div class="value" id="stat-tienda3">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card bodega">
          <h3>üì¶ Bodega</h3>
          <div class="value" id="stat-bodega">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card total">
          <h3>üìä Total General</h3>
          <div class="value" id="stat-total">0</div>
          <div class="label">unidades</div>
        </div>
      </div>

      <div class="search-filter">
        <input type="text" id="search-inventory" placeholder="Buscar producto...">
        <select id="filter-category-inventory">
          <option value="">Todas las categor√≠as</option>
          <option value="peluches">Peluches</option>
          <option value="tazas">Tazas</option>
          <option value="vasos">Vasos</option>
          <option value="mochilas">Mochilas</option>
          <option value="papeleria">Papeler√≠a</option>
          <option value="decoracion">Decoraci√≥n</option>
          <option value="botellas">Botellas</option>
          <option value="belleza">Belleza</option>
          <option value="bloques">Bloques</option>
        </select>
        <select id="filter-stock">
          <option value="">Todos los niveles</option>
          <option value="low">Stock bajo (‚â§5)</option>
          <option value="medium">Stock medio (6-15)</option>
          <option value="good">Stock bueno (>15)</option>
        </select>
      </div>

      <div class="inventory-table">
        <table>
          <thead>
            <tr>
              <th style="width:60px">Imagen</th>
              <th style="min-width:180px">Producto</th>
              <th style="width:130px">C√≥digo</th>
              <th style="width:110px">Categor√≠a</th>
              <th style="width:80px;text-align:center">Sophie Store</th>
              <th style="width:80px;text-align:center">Sophie Mall</th>
              <th style="width:80px;text-align:center">Sophie's Ticados</th>
              <th style="width:80px;text-align:center">Bodega</th>
              <th style="width:80px;text-align:center">Total</th>
              <th style="width:100px;text-align:center">Estado</th>
              <th style="min-width:180px">Acciones</th>
            </tr>
          </thead>
          <tbody id="inventory-tbody">
            <!-- Los productos se cargar√°n din√°micamente -->
          </tbody>
        </table>
      </div>
    </main>

    <!-- Modal para ajustar inventario -->
    <div id="adjust-modal" class="modal">
      <div class="modal-content" style="max-width:700px;max-height:85vh;overflow-y:auto">
        <h2>Ajustar Inventario</h2>
        <div id="adjust-product-info"></div>
        <form id="adjust-form">
          <input type="hidden" id="adjust-product-id">
          <div id="adjust-inventory-fields">
            <!-- Los campos se generar√°n din√°micamente -->
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" id="btn-cancel-adjust">Cancelar</button>
            <button type="submit" class="btn-save">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar producto desde inventario -->
    <div id="add-product-modal" class="modal">
      <div class="modal-content">
        <h2>Agregar Producto al Inventario</h2>
        <form id="add-product-form-inventory">
          <div class="form-group">
            <label for="inv-product-title">Nombre del Producto *</label>
            <input type="text" id="inv-product-title" required>
          </div>

          <div class="form-group">
            <label for="inv-product-category">Categor√≠a *</label>
            <select id="inv-product-category" required>
              <option value="">Seleccionar categor√≠a</option>
              <option value="peluches">Peluches</option>
              <option value="tazas">Tazas</option>
              <option value="vasos">Vasos</option>
              <option value="mochilas">Mochilas</option>
              <option value="papeleria">Papeler√≠a</option>
              <option value="decoracion">Decoraci√≥n</option>
              <option value="botellas">Botellas</option>
              <option value="belleza">Belleza</option>
              <option value="bloques">Bloques</option>
            </select>
          </div>

          <div class="form-group">
            <label for="inv-product-price">Precio (‚Ç°) *</label>
            <input type="number" id="inv-product-price" min="0" step="500" required>
          </div>

          <div class="form-group">
            <label for="inv-product-desc">Descripci√≥n *</label>
            <textarea id="inv-product-desc" required></textarea>
          </div>

          <div class="form-group">
            <label for="inv-product-img">Ruta de Imagen *</label>
            <input type="text" id="inv-product-img" placeholder="Fotos productos/..." required>
          </div>

          <div class="form-group">
            <label for="inv-product-barcode">C√≥digo de Barras (opcional)</label>
            <input type="text" id="inv-product-barcode" placeholder="Dejar vac√≠o para generar autom√°ticamente" style="font-family:monospace;">
            <small style="color:#666;display:block;margin-top:4px;">Si no ingresa un c√≥digo, se generar√° uno autom√°ticamente basado en el ID del producto</small>
          </div>

          <div class="form-group">
            <label style="font-weight:600;color:#5a2032;margin-bottom:8px;display:block">Inventario Inicial por Ubicaci√≥n</label>
            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:12px">
              <div>
                <label for="inv-inventory-tienda1" style="font-size:0.9rem;color:#666">Sophie Store</label>
                <input type="number" id="inv-inventory-tienda1" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
              <div>
                <label for="inv-inventory-tienda2" style="font-size:0.9rem;color:#666">Sophie Mall</label>
                <input type="number" id="inv-inventory-tienda2" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
              <div>
                <label for="inv-inventory-tienda3" style="font-size:0.9rem;color:#666">Sophie's Ticados</label>
                <input type="number" id="inv-inventory-tienda3" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
              <div>
                <label for="inv-inventory-bodega" style="font-size:0.9rem;color:#666">Bodega</label>
                <input type="number" id="inv-inventory-bodega" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
            </div>
            <div style="margin-top:8px;padding:10px;background:#fff3e0;border-radius:6px;font-size:0.9rem;color:#f57c00">
              <strong>‚ö†Ô∏è Nota:</strong> Este producto se agregar√° desactivado en el Admin. Deber√° activarlo manualmente para que sea visible en la tienda.
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" id="btn-cancel-add-product">Cancelar</button>
            <button type="submit" class="btn-save">Agregar Producto</button>
          </div>
        </form>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
      // Funci√≥n para abrir el tab de apartados
      function openApartadosTab() {
        window.location.href = 'pos.html';
      }

      // Verificar autenticaci√≥n y tipo de usuario
      if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }
      
      // Redirigir vendedores a POS
      const userType = sessionStorage.getItem('userType');
      if (userType === 'vendedor') {
        window.location.href = 'pos.html';
      }
      
      let productsData = [];
      
      function openApartadosTab() {
        window.location.href = 'pos.html';
      }
      
      function checkAdminAccessAndNavigate(page) {
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
          alert('‚õî Acceso denegado.\nDebes estar autenticado como administrador para acceder a ' + (page === 'admin.html' ? 'Administraci√≥n' : 'Inventario'));
          return;
        }
        window.location.href = page;
      }

      window.addEventListener('DOMContentLoaded', () => {
        if (typeof loadProductsFromStorage !== 'undefined') {
          productsData = loadProductsFromStorage();
        } else if (typeof products !== 'undefined') {
          productsData = [...products];
        }
        
        renderInventoryStats();
        renderInventoryTable();
        setupInventoryListeners();
      });

      function setupInventoryListeners() {
        const searchInput = document.getElementById('search-inventory');
        const filterCategory = document.getElementById('filter-category-inventory');
        const filterStock = document.getElementById('filter-stock');
        const exportBtn = document.getElementById('export-inventory');
        const addProductBtn = document.getElementById('btn-add-product-inventory');

        if (searchInput) searchInput.addEventListener('input', filterInventory);
        if (filterCategory) filterCategory.addEventListener('change', filterInventory);
        if (filterStock) filterStock.addEventListener('change', filterInventory);
        if (exportBtn) exportBtn.addEventListener('click', exportInventory);

        // Modal para agregar producto
        const addProductModal = document.getElementById('add-product-modal');
        const addProductForm = document.getElementById('add-product-form-inventory');
        const btnCancelAddProduct = document.getElementById('btn-cancel-add-product');

        if (addProductBtn) {
          addProductBtn.addEventListener('click', () => {
            document.getElementById('inv-product-title').value = '';
            document.getElementById('inv-product-category').value = '';
            document.getElementById('inv-product-price').value = '';
            document.getElementById('inv-product-desc').value = '';
            document.getElementById('inv-product-img').value = '';
            document.getElementById('inv-product-barcode').value = '';
            document.getElementById('inv-inventory-tienda1').value = '0';
            document.getElementById('inv-inventory-tienda2').value = '0';
            document.getElementById('inv-inventory-tienda3').value = '0';
            document.getElementById('inv-inventory-bodega').value = '0';
            addProductModal.setAttribute('aria-hidden', 'false');
          });
        }

        if (btnCancelAddProduct) {
          btnCancelAddProduct.addEventListener('click', () => {
            addProductModal.setAttribute('aria-hidden', 'true');
          });
        }

        if (addProductModal) {
          addProductModal.addEventListener('click', (e) => {
            if (e.target === addProductModal) {
              addProductModal.setAttribute('aria-hidden', 'true');
            }
          });
        }

        if (addProductForm) {
          addProductForm.addEventListener('submit', handleAddProductSubmit);
        }

        // Modal ajustar inventario
        const modal = document.getElementById('adjust-modal');
        const btnCancel = document.getElementById('btn-cancel-adjust');
        const form = document.getElementById('adjust-form');

        if (btnCancel) {
          btnCancel.addEventListener('click', () => {
            modal.setAttribute('aria-hidden', 'true');
          });
        }

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.setAttribute('aria-hidden', 'true');
            }
          });
        }

        if (form) {
          form.addEventListener('submit', handleAdjustSubmit);
        }

        // Hamburger menu
        const hamburger = document.getElementById('hamburger');
        const navDrawer = document.getElementById('nav-drawer');
        const navOverlay = document.getElementById('nav-overlay');
        const closeNav = document.getElementById('close-nav');

        if (hamburger) {
          hamburger.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'false');
            navOverlay.setAttribute('aria-hidden', 'false');
          });
        }

        if (closeNav) {
          closeNav.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        if (navOverlay) {
          navOverlay.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        // Cerrar sesi√≥n
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            if (confirm('¬øDeseas cerrar sesi√≥n?')) {
              sessionStorage.removeItem('adminLoggedIn');
              sessionStorage.removeItem('adminUsername');
              window.location.href = 'login.html';
            }
          });
        }
      }

      function renderInventoryStats() {
        let tienda1Total = 0, tienda2Total = 0, tienda3Total = 0, bodegaTotal = 0;

        productsData.forEach(product => {
          const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          tienda1Total += inv.tienda1 || 0;
          tienda2Total += inv.tienda2 || 0;
          tienda3Total += inv.tienda3 || 0;
          bodegaTotal += inv.bodega || 0;
        });

        const total = tienda1Total + tienda2Total + tienda3Total + bodegaTotal;

        document.getElementById('stat-tienda1').textContent = tienda1Total.toLocaleString();
        document.getElementById('stat-tienda2').textContent = tienda2Total.toLocaleString();
        document.getElementById('stat-tienda3').textContent = tienda3Total.toLocaleString();
        document.getElementById('stat-bodega').textContent = bodegaTotal.toLocaleString();
        document.getElementById('stat-total').textContent = total.toLocaleString();
      }

      function renderInventoryTable(filteredProducts = productsData) {
        const tbody = document.getElementById('inventory-tbody');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (filteredProducts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;color:#999">No hay productos para mostrar</td></tr>';
          return;
        }

        filteredProducts.forEach(product => {
          // Calcular inventario total considerando variantes
          let inv = {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          let total = 0;
          
          if (product.variants && product.variants.options && product.variants.options.length > 0) {
            // Si tiene variantes, sumar el inventario de todas las opciones
            product.variants.options.forEach(option => {
              const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
              inv.tienda1 += (optInv.tienda1 || 0);
              inv.tienda2 += (optInv.tienda2 || 0);
              inv.tienda3 += (optInv.tienda3 || 0);
              inv.bodega += (optInv.bodega || 0);
            });
            total = inv.tienda1 + inv.tienda2 + inv.tienda3 + inv.bodega;
          } else {
            // Sin variantes, usar inventario directo
            inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            total = (inv.tienda1 || 0) + (inv.tienda2 || 0) + (inv.tienda3 || 0) + (inv.bodega || 0);
          }

          function getStockClass(qty) {
            if (qty <= 5) return 'stock-low';
            if (qty <= 15) return 'stock-medium';
            return 'stock-good';
          }

          // Determinar estado: disponible o agotado
          const statusBadge = total === 0 
            ? '<span style="display:inline-block;background:#f44336;color:white;padding:4px 10px;border-radius:16px;font-weight:600;font-size:0.75rem;white-space:nowrap">Agotado</span>'
            : '<span style="display:inline-block;background:#4caf50;color:white;padding:4px 10px;border-radius:16px;font-weight:600;font-size:0.75rem;white-space:nowrap">Disponible</span>';

          const tr = document.createElement('tr');
          
          // Generar c√≥digo de barras display
          let barcodeDisplay = '';
          if (product.variants && product.variants.options && product.variants.options.length > 0) {
            barcodeDisplay = '<select style="font-family:monospace;font-size:0.75rem;color:#666;background:#f7f0f6;padding:4px 6px;border:1px solid #e0d0e0;border-radius:4px;width:100%">';
            product.variants.options.forEach(option => {
              const barcode = option.barcode || 'N/A';
              barcodeDisplay += `<option>${option.name}: ${barcode}</option>`;
            });
            barcodeDisplay += '</select>';
          } else {
            barcodeDisplay = `<div style="font-family:monospace;font-size:0.8rem;color:#666;background:#f7f0f6;padding:4px 8px;border-radius:4px;text-align:center">${product.barcode || 'N/A'}</div>`;
          }
          
          tr.innerHTML = `
            <td><img src="${product.img}" alt="${product.title}" class="product-img-small" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'60\\' height=\\'60\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'60\\' height=\\'60\\'/%3E%3C/svg%3E'"></td>
            <td><strong style="color:#5a2032">${product.title}</strong></td>
            <td>${barcodeDisplay}</td>
            <td style="font-size:0.85rem;color:#666">${product.category}</td>
            <td class="stock-cell ${getStockClass(inv.tienda1 || 0)}">${inv.tienda1 || 0}</td>
            <td class="stock-cell ${getStockClass(inv.tienda2 || 0)}">${inv.tienda2 || 0}</td>
            <td class="stock-cell ${getStockClass(inv.tienda3 || 0)}">${inv.tienda3 || 0}</td>
            <td class="stock-cell ${getStockClass(inv.bodega || 0)}">${inv.bodega || 0}</td>
            <td class="stock-cell" style="font-weight:900;color:#5a2032;font-size:1.1rem">${total}</td>
            <td style="text-align:center">${statusBadge}</td>
            <td style="white-space:nowrap">
              <button class="btn-adjust" data-id="${product.id}">Ajustar</button>
              <button class="btn-delete-inv" data-id="${product.id}" style="margin-left:6px;background:#f44336;color:white;border:none;border-radius:6px;padding:6px 10px;font-weight:600;cursor:pointer;font-size:0.8rem">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('.btn-adjust').forEach(btn => {
          btn.addEventListener('click', () => openAdjustModal(parseInt(btn.dataset.id)));
        });

        tbody.querySelectorAll('.btn-delete-inv').forEach(btn => {
          btn.addEventListener('click', () => deleteProductFromInventory(parseInt(btn.dataset.id)));
        });
      }

      function filterInventory() {
        const searchTerm = document.getElementById('search-inventory').value.toLowerCase();
        const categoryFilter = document.getElementById('filter-category-inventory').value;
        const stockFilter = document.getElementById('filter-stock').value;

        const filtered = productsData.filter(product => {
          // Buscar en nombre del producto
          let matchesSearch = product.title.toLowerCase().includes(searchTerm);
          
          // Buscar en c√≥digo de barras principal
          if (!matchesSearch && product.barcode) {
            matchesSearch = product.barcode.toLowerCase().includes(searchTerm);
          }
          
          // Buscar en c√≥digos de barras de variantes
          if (!matchesSearch && product.variants && product.variants.options) {
            matchesSearch = product.variants.options.some(option => 
              option.barcode && option.barcode.toLowerCase().includes(searchTerm)
            );
          }
          
          const matchesCategory = !categoryFilter || product.category === categoryFilter;
          
          let matchesStock = true;
          if (stockFilter) {
            // Calcular total considerando variantes
            let total = 0;
            if (product.variants && product.variants.options && product.variants.options.length > 0) {
              product.variants.options.forEach(option => {
                const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
                total += (optInv.tienda1 || 0) + (optInv.tienda2 || 0) + (optInv.tienda3 || 0) + (optInv.bodega || 0);
              });
            } else {
              const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
              total = (inv.tienda1 || 0) + (inv.tienda2 || 0) + (inv.tienda3 || 0) + (inv.bodega || 0);
            }
            
            if (stockFilter === 'low') matchesStock = total <= 5;
            else if (stockFilter === 'medium') matchesStock = total > 5 && total <= 15;
            else if (stockFilter === 'good') matchesStock = total > 15;
          }

          return matchesSearch && matchesCategory && matchesStock;
        });

        renderInventoryTable(filtered);
      }

      function openAdjustModal(productId) {
        const product = productsData.find(p => p.id === productId);
        if (!product) return;

        const modal = document.getElementById('adjust-modal');
        const productInfo = document.getElementById('adjust-product-info');
        const fieldsContainer = document.getElementById('adjust-inventory-fields');
        
        productInfo.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#f9f9f9;border-radius:8px;margin-bottom:20px">
            <img src="${product.img}" alt="${product.title}" style="width:60px;height:60px;object-fit:cover;border-radius:8px">
            <div>
              <h3 style="margin:0;color:#5a2032">${product.title}</h3>
              <p style="margin:4px 0 0 0;color:#666">Categor√≠a: ${product.category}</p>
            </div>
          </div>
        `;

        document.getElementById('adjust-product-id').value = product.id;
        
        // Verificar si tiene variantes
        if (product.variants && product.variants.options && product.variants.options.length > 0) {
          // Producto con variantes: crear campos para cada variante
          fieldsContainer.innerHTML = '<p style="color:#5a2032;font-weight:600;margin-bottom:12px">Ajustar inventario por variante:</p>';
          
          product.variants.options.forEach((option, index) => {
            const inv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            fieldsContainer.innerHTML += `
              <div style="border:1px solid #e3cfe0;border-radius:8px;padding:12px;margin-bottom:12px;background:#fafafa">
                <h4 style="margin:0 0 8px 0;color:#5a2032;font-size:1rem">${option.name}</h4>
                <div style="margin-bottom:12px">
                  <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">C√≥digo de Barras</label>
                  <input type="text" class="variant-barcode" data-variant-index="${index}" value="${option.barcode || ''}" placeholder="SOPHIE000000-1" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px;font-family:monospace">
                </div>
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px">
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Sophie Store</label>
                    <input type="number" class="variant-tienda1" data-variant-index="${index}" min="0" value="${inv.tienda1 || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Sophie Mall</label>
                    <input type="number" class="variant-tienda2" data-variant-index="${index}" min="0" value="${inv.tienda2 || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Sophie's Ticados</label>
                    <input type="number" class="variant-tienda3" data-variant-index="${index}" min="0" value="${inv.tienda3 || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Bodega</label>
                    <input type="number" class="variant-bodega" data-variant-index="${index}" min="0" value="${inv.bodega || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                </div>
              </div>
            `;
          });
        } else {
          // Producto simple: crear campos normales
          const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          fieldsContainer.innerHTML = `
            <div class="form-group">
              <label for="adjust-barcode">C√≥digo de Barras</label>
              <input type="text" id="adjust-barcode" value="${product.barcode || ''}" placeholder="SOPHIE000000" style="font-family:monospace">
            </div>
            <div class="form-group">
              <label for="adjust-tienda1">Sophie Store</label>
              <input type="number" id="adjust-tienda1" min="0" value="${inv.tienda1 || 0}">
            </div>
            <div class="form-group">
              <label for="adjust-tienda2">Sophie Mall</label>
              <input type="number" id="adjust-tienda2" min="0" value="${inv.tienda2 || 0}">
            </div>
            <div class="form-group">
              <label for="adjust-tienda3">Sophie's Ticados</label>
              <input type="number" id="adjust-tienda3" min="0" value="${inv.tienda3 || 0}">
            </div>
            <div class="form-group">
              <label for="adjust-bodega">Bodega</label>
              <input type="number" id="adjust-bodega" min="0" value="${inv.bodega || 0}">
            </div>
          `;
        }

        modal.setAttribute('aria-hidden', 'false');
      }

      function handleAdjustSubmit(e) {
        e.preventDefault();

        const productId = parseInt(document.getElementById('adjust-product-id').value);
        const product = productsData.find(p => p.id === productId);
        
        if (!product) return;

        // Verificar si tiene variantes
        if (product.variants && product.variants.options && product.variants.options.length > 0) {
          // Actualizar inventario y c√≥digo de barras de cada variante
          product.variants.options.forEach((option, index) => {
            const tienda1Input = document.querySelector(`.variant-tienda1[data-variant-index="${index}"]`);
            const tienda2Input = document.querySelector(`.variant-tienda2[data-variant-index="${index}"]`);
            const tienda3Input = document.querySelector(`.variant-tienda3[data-variant-index="${index}"]`);
            const bodegaInput = document.querySelector(`.variant-bodega[data-variant-index="${index}"]`);
            const barcodeInput = document.querySelector(`.variant-barcode[data-variant-index="${index}"]`);
            
            if (tienda1Input && tienda2Input && tienda3Input && bodegaInput) {
              option.inventory = {
                tienda1: parseInt(tienda1Input.value) || 0,
                tienda2: parseInt(tienda2Input.value) || 0,
                tienda3: parseInt(tienda3Input.value) || 0,
                bodega: parseInt(bodegaInput.value) || 0
              };
              
              // Actualizar c√≥digo de barras
              if (barcodeInput) {
                option.barcode = barcodeInput.value.trim() || ('SOPHIE' + String(product.id).padStart(6, '0') + '-' + String(index + 1));
              }
            }
          });
        } else {
          // Actualizar inventario y c√≥digo de barras del producto simple
          product.inventory = {
            tienda1: parseInt(document.getElementById('adjust-tienda1').value) || 0,
            tienda2: parseInt(document.getElementById('adjust-tienda2').value) || 0,
            tienda3: parseInt(document.getElementById('adjust-tienda3').value) || 0,
            bodega: parseInt(document.getElementById('adjust-bodega').value) || 0
          };
          
          // Actualizar c√≥digo de barras
          const barcodeInput = document.getElementById('adjust-barcode');
          if (barcodeInput) {
            product.barcode = barcodeInput.value.trim() || ('SOPHIE' + String(product.id).padStart(6, '0'));
          }
        }

        // Guardar en localStorage
        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        } else {
          // Fallback si no est√° disponible saveProductsToStorage
          localStorage.setItem('products_data', JSON.stringify(productsData));
        }

        document.getElementById('adjust-modal').setAttribute('aria-hidden', 'true');
        renderInventoryStats();
        renderInventoryTable();
        alert('Inventario actualizado correctamente ‚úÖ');
      }

      function deleteProductFromInventory(id) {
        const product = productsData.find(p => p.id === id);
        if (!product) return;

        if (!confirm('¬øEst√°s seguro de eliminar este producto del inventario?')) return;

        const index = productsData.findIndex(p => p.id === id);
        if (index === -1) return;

        productsData.splice(index, 1);

        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        } else {
          localStorage.setItem('products_data', JSON.stringify(productsData));
        }

        renderInventoryStats();
        renderInventoryTable();
        alert('Producto eliminado correctamente ‚úÖ');
      }

      function exportInventory() {
        let csv = 'Producto,Categor√≠a,Tienda 1,Tienda 2,Tienda 3,Bodega,Total\n';

        productsData.forEach(product => {
          const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          const total = (inv.tienda1 || 0) + (inv.tienda2 || 0) + (inv.tienda3 || 0) + (inv.bodega || 0);
          
          csv += `"${product.title}","${product.category}",${inv.tienda1 || 0},${inv.tienda2 || 0},${inv.tienda3 || 0},${inv.bodega || 0},${total}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `inventario_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function handleAddProductSubmit(e) {
        e.preventDefault();

        const newId = Math.max(0, ...productsData.map(p => p.id)) + 1;
        let barcode = document.getElementById('inv-product-barcode').value.trim();
        
        // Si no proporciona c√≥digo de barras, generar uno autom√°ticamente
        if (!barcode) {
          barcode = 'SOPHIE' + String(newId).padStart(6, '0');
        }

        const productData = {
          id: newId,
          title: document.getElementById('inv-product-title').value,
          category: document.getElementById('inv-product-category').value,
          price: parseFloat(document.getElementById('inv-product-price').value),
          desc: document.getElementById('inv-product-desc').value,
          img: document.getElementById('inv-product-img').value,
          images: [document.getElementById('inv-product-img').value],
          gender: 'unisex',
          barcode: barcode,  // ‚Üê NUEVO: C√≥digo de barras
          outOfStock: false,
          active: false,  // ‚Üê PRODUCTOS AGREGADOS DESDE INVENTARIO SIEMPRE DESACTIVADOS
          inventory: {
            tienda1: parseInt(document.getElementById('inv-inventory-tienda1').value) || 0,
            tienda2: parseInt(document.getElementById('inv-inventory-tienda2').value) || 0,
            tienda3: parseInt(document.getElementById('inv-inventory-tienda3').value) || 0,
            bodega: parseInt(document.getElementById('inv-inventory-bodega').value) || 0
          },
          sold: 0
        };

        productsData.push(productData);

        // Guardar en localStorage
        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        } else {
          // Fallback si no est√° disponible saveProductsToStorage
          localStorage.setItem('products_data', JSON.stringify(productsData));
        }

        document.getElementById('add-product-modal').setAttribute('aria-hidden', 'true');
        renderInventoryStats();
        renderInventoryTable();
        alert('Producto agregado correctamente. Recuerda activarlo en el m√≥dulo de Administraci√≥n para que sea visible en la tienda. ‚úÖ');
      }
    </script>
  </body>
</html>
