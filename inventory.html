  <!-- Pagination will be moved below the table -->
    <script>
    // Paginación para inventario
    let inventoryCurrentPage = 1;
    const INVENTORY_PRODUCTS_PER_PAGE = 20;
    function renderInventoryPagination(totalPages) {
      const container = document.getElementById('inventory-pagination');
      if (!container) return;
      if (totalPages <= 1) {
        container.innerHTML = '';
        container.style.display = 'none';
        return;
      }
      container.style.display = 'flex';
      container.innerHTML = `
        <button class="page-btn prev" ${inventoryCurrentPage===1 ? 'disabled aria-disabled="true"' : ''}>Anterior</button>
        <span class="page-info">Página ${inventoryCurrentPage} de ${totalPages}</span>
        <button class="page-btn next" ${inventoryCurrentPage===totalPages ? 'disabled aria-disabled="true"' : ''}>Siguiente</button>
      `;
      const prev = container.querySelector('.page-btn.prev');
      const next = container.querySelector('.page-btn.next');
      if(prev) prev.addEventListener('click',()=>{ if(inventoryCurrentPage>1){ inventoryCurrentPage-=1; renderInventoryTable(); } });
      if(next) next.addEventListener('click',()=>{ if(inventoryCurrentPage<totalPages){ inventoryCurrentPage+=1; renderInventoryTable(); } });
    }
    </script>
<!doctype html>
<html lang="es">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario - Sophie</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .admin-tabs {
        max-width: 1400px;
        margin: 20px auto 0;
        padding: 0 20px;
        display: flex;
        gap: 4px;
        border-bottom: 2px solid #e3cfe0;
      }
      .admin-tab {
        padding: 14px 28px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #666;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: Montserrat, sans-serif;
        text-decoration: none;
        display: inline-block;
      }
      .admin-tab:hover {
        color: #5a2032;
        background: rgba(243, 229, 245, 0.3);
      }
      .admin-tab.active {
        color: #d946a6;
        border-bottom-color: #d946a6;
        background: rgba(243, 229, 245, 0.5);
      }
      .inventory-container {
        max-width: 1400px;
        margin: 20px auto 40px;
        padding: 20px;
      }
      .inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--accent);
      }
      .inventory-header h1 {
        font-family: Playfair Display, serif;
        color: #5a2032;
        margin: 0;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(82, 44, 60, 0.1);
        border-left: 4px solid;
      }
      .stat-card.tienda1 { border-left-color: #ff6b9d; }
      .stat-card.tienda2 { border-left-color: #5a8dee; }
      .stat-card.tienda3 { border-left-color: #ffc107; }
      .stat-card.bodega { border-left-color: #4caf50; }
      .stat-card.total { border-left-color: #d946a6; }
      
      .stat-card h3 {
        margin: 0 0 8px 0;
        color: #5a2032;
        font-size: 1rem;
        font-weight: 600;
      }
      .stat-card .value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #d946a6;
        margin: 0;
      }
      .stat-card .label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 4px;
      }
      .search-filter {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .search-filter input,
      .search-filter select {
        padding: 10px;
        border: 1px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
      }
      .search-filter input {
        flex: 1;
        min-width: 250px;
      }
      .inventory-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow-x: auto;
        overflow-y: visible;
        box-shadow: 0 4px 20px rgba(82, 44, 60, 0.1);
      }
      .inventory-table table {
        width: 100%;
        min-width: 1200px;
        border-collapse: collapse;
      }
      .inventory-table th {
        background: linear-gradient(135deg, #f3e5f5, #fce4ec);
        padding: 12px 10px;
        text-align: left;
        font-weight: 700;
        color: #5a2032;
        font-size: 0.85rem;
        white-space: nowrap;
      }
      .inventory-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #f0f0f0;
        color: #3a2f33;
        font-size: 0.9rem;
      }
      .inventory-table tr:hover {
        background: #fff8fb;
      }
      .product-img-small {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
      }
      .inventory-product-title {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.2;
        max-width: 260px;
      }
      .stock-cell {
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        min-width: 60px;
      }
      .stock-low {
        color: #f44336;
      }
      .stock-medium {
        color: #ff9800;
      }
      .stock-good {
        color: #4caf50;
      }
      .btn-adjust {
        padding: 6px 10px;
        background: #5a8dee;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.8rem;
      }
      .btn-adjust:hover {
        background: #3a70d6;
      }
      .btn-export {
        padding: 12px 24px;
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-export:hover {
        box-shadow: 0 4px 14px rgba(76, 175, 80, 0.5);
        transform: translateY(-2px);
      }
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        padding: 40px;
        border-radius: 16px;
        max-width: 700px;
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      }
      .modal-content h2 {
        margin-top: 0;
        margin-bottom: 30px;
        color: #5a2032;
        font-family: Playfair Display, serif;
        font-size: 1.8rem;
        border-bottom: 3px solid #e3cfe0;
        padding-bottom: 15px;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #5a2032;
        font-size: 0.95rem;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
        font-size: 0.95rem;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #5a8dee;
      }
      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }
      .form-group small {
        display: block;
        margin-top: 6px;
        color: #999;
        font-size: 0.85rem;
      }
      .image-preview-container {
        margin-top: 12px;
        border: 2px dashed #e3cfe0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background: #fafafa;
      }
      .image-preview-container img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 12px;
      }
      .image-preview-container.has-image {
        border-style: solid;
        border-color: #5a8dee;
        background: #f0f7ff;
      }
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e3cfe0;
      }
      .btn-cancel {
        padding: 10px 20px;
        background: #9e9e9e;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-cancel:hover {
        background: #757575;
      }
      .btn-save {
        padding: 10px 20px;
        background: linear-gradient(135deg, #5a8dee, #3a70d6);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn-save:hover {
        box-shadow: 0 4px 14px rgba(74, 144, 226, 0.5);
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <button id="hamburger" class="hamburger" aria-label="Abrir menú">☰</button>
        <a href="index.html" class="logo" style="text-decoration:none;cursor:pointer;display:flex;align-items:center;gap:10px">
          <span style="font-family:'Daily',Playfair Display,serif;font-size:2.5rem;font-weight:400;color:#2c4a8c">SophieWeb - Inventario</span>
        </a>
        <a href="index.html" class="btn">← Volver a la tienda</a>
        <button id="logout-btn" class="btn" style="color:#f44336;font-weight:700">Cerrar Sesión</button>
      </div>
    </header>

    <div id="nav-overlay" class="nav-overlay" aria-hidden="true"></div>
    <aside id="nav-drawer" class="nav-drawer" aria-hidden="true">
      <div class="nav-drawer-inner">
        <button id="close-nav" class="close">✕</button>
        <nav class="nav-drawer-list">
          <a class="btn" href="index.html">Inicio</a>
          <a class="btn" href="admin.html">Administración</a>
          <a class="btn" href="pos.html">Punto de Ventas</a>
          <a class="btn active" href="inventory.html">Inventario</a>
        </nav>
      </div>
    </aside>

    <!-- Tabs de navegación -->
    <div class="admin-tabs">
      <a href="pos.html" class="admin-tab">💳 Punto de Ventas</a>
      <a href="#" onclick="openApartadosTab(); return false;" class="admin-tab">📋 Apartados</a>
      <a href="#" onclick="openPedidosOnlineTab(); return false;" class="admin-tab">📦 Pedidos Online</a>
      <a href="#" onclick="checkAdminAccessAndNavigate('admin.html'); return false;" class="admin-tab">📦 Administración</a>
      <a href="inventory.html" class="admin-tab active">📊 Inventario</a>
    </div>

    <main class="inventory-container">
      <div class="inventory-header">
        <h1>Gestión de Inventario</h1>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-export" id="btn-add-product-inventory" style="background:#d946a6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600">+ Agregar Producto</button>
          <button class="btn-export" id="export-inventory">📥 Exportar Inventario</button>
          <button class="btn-export" id="import-inventory-btn" style="background:#5a8dee;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600">📤 Importar Inventario</button>
          <input type="file" id="import-inventory-file" accept=".csv" style="display:none" />
          <button class="btn-export" id="open-transfer-modal" style="background:#4caf50;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600">Transferir Bodega → Tienda</button>
          <button class="btn-export" id="open-history-modal" style="background:#ff9800;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600">📋 Historial de Transferencias</button>
          <div id="transfer-modal" class="modal" aria-hidden="true" style="display:none">
            <div class="modal-content" style="max-width:1200px;max-height:90vh;overflow-y:auto;padding:0">
              <div style="display:grid;grid-template-columns:1.5fr 2fr;gap:0;min-height:520px">
                <div style="padding:32px 32px 32px 40px;display:flex;flex-direction:column;gap:18px;border-right:2px solid #e3cfe0;background:#f8f5fa">
                  <h2 style="margin-bottom:0;font-size:2rem;color:#5a2032">Transferir productos de Bodega</h2>
                  <div style="font-size:1rem;color:#555;margin-bottom:10px">Selecciona la tienda destino, agrega productos y cantidades, y tu nombre de usuario. Puedes buscar productos por nombre o código y se mostrarán sugerencias.</div>
                  <form id="form-transfer-bodega" style="display:flex;flex-direction:column;gap:16px;margin-top:8px">
                    <label style="font-weight:600;color:#5a2032">Usuario que transfiere *</label>
                    <input type="text" id="transfer-usuario" placeholder="" style="width:100%;padding:10px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1.05rem;background-color:#f5f5f5;cursor:not-allowed" readonly />
                    <label style="font-weight:600;color:#5a2032">Agregar productos *</label>
                    <input type="text" id="transfer-input" placeholder="Buscar y selecciona productos..." style="padding:10px;border-radius:8px;border:2px solid #e3cfe0;min-width:220px;font-size:1.05rem" autocomplete="off" />
                    <div id="transfer-suggestions" style="background:#fff;border:1.5px solid #e3cfe0;border-radius:8px;max-height:180px;overflow-y:auto;display:none;position:relative;z-index:10"></div>
                    <label style="font-weight:600;color:#5a2032">Tiendas destino *</label>
                    <div style="display:flex;flex-direction:column;gap:12px">
                      <label style="display:flex;align-items:center;gap:10px;font-weight:500;color:#5a2032;cursor:pointer;font-size:1rem">
                        <input type="checkbox" id="transfer-tienda1" value="tienda1" checked style="width:18px;height:18px;cursor:pointer;accent-color:#ff6b9d" />
                        🏪 Sophie Store
                      </label>
                      <label style="display:flex;align-items:center;gap:10px;font-weight:500;color:#5a2032;cursor:pointer;font-size:1rem">
                        <input type="checkbox" id="transfer-tienda2" value="tienda2" checked style="width:18px;height:18px;cursor:pointer;accent-color:#5a8dee" />
                        🏬 Sophie Mall
                      </label>
                      <label style="display:flex;align-items:center;gap:10px;font-weight:500;color:#5a2032;cursor:pointer;font-size:1rem">
                        <input type="checkbox" id="transfer-tienda3" value="tienda3" checked style="width:18px;height:18px;cursor:pointer;accent-color:#ffc107" />
                        🛍️ Sophie's Ticados
                      </label>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px">
                      <button type="button" id="close-transfer-modal" class="btn-cancel" style="padding:10px 20px;border-radius:8px;border:none;background:#eee;color:#333;font-weight:600;font-size:1.05rem">Cancelar</button>
                      <button type="submit" class="btn-export" style="background:#4caf50;color:white;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:700;font-size:1.15rem">Transferir</button>
                    </div>
                  </form>
                </div>
                <div style="padding:32px 32px 32px 32px;background:white;display:flex;flex-direction:column;gap:0;min-width:400px">
                  <h3 style="margin:0 0 18px 0;font-size:1.5rem;color:#5a2032;font-weight:700">Productos seleccionados</h3>
                  <div id="transfer-list" style="flex:1;overflow-y:auto;border-top:1.5px solid #e3cfe0;padding-top:18px;font-size:1.05rem">
                    <!-- Aquí se mostrarán los productos seleccionados tipo carrito -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- MODAL DE HISTORIAL DE TRANSFERENCIAS -->
          <div id="history-modal" class="modal" aria-hidden="true" style="display:none">
            <div class="modal-content" style="max-width:1000px;max-height:90vh;overflow-y:auto;padding:32px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin:0;font-size:1.8rem;color:#5a2032">📋 Historial de Transferencias</h2>
                <button type="button" id="close-history-modal" style="background:none;border:none;color:#888;font-size:1.8rem;cursor:pointer">✕</button>
              </div>
              <div style="display:flex;gap:12px;margin-bottom:24px">
                <button id="export-history-excel" style="background:#e74c3c;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem">📄 Descargar como PDF</button>
                <button id="export-history-csv" style="background:#3498db;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem">📥 Descargar como CSV</button>
              </div>
              <div id="history-container" style="background:#f8f5fa;padding:18px;border-radius:8px;max-height:600px;overflow-y:auto">
                <!-- Aquí se mostrarán las transferencias agrupadas por fecha -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estadísticas -->
      <div class="stats-grid">
        <div class="stat-card tienda1">
          <h3>🏪 Sophie Store</h3>
          <div class="value" id="stat-tienda1">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card tienda2">
          <h3>🏪 Sophie Mall</h3>
          <div class="value" id="stat-tienda2">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card tienda3">
          <h3>🏪 Sophie's Ticados</h3>
          <div class="value" id="stat-tienda3">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card bodega">
          <h3>📦 Bodega</h3>
          <div class="value" id="stat-bodega">0</div>
          <div class="label">unidades</div>
        </div>
        <div class="stat-card total">
          <h3>📊 Total General</h3>
          <div class="value" id="stat-total">0</div>
          <div class="label">unidades</div>
        </div>
      </div>

      <div class="search-filter">
        <input type="text" id="search-inventory" placeholder="Buscar producto...">
        <select id="filter-category-inventory">
          <option value="">Todas las categorías</option>
          <option value="peluches">Peluches</option>
          <option value="tazas">Tazas</option>
          <option value="vasos">Vasos</option>
          <option value="mochilas">Mochilas</option>
          <option value="papeleria">Papelería</option>
          <option value="decoracion">Decoración</option>
          <option value="botellas">Botellas</option>
          <option value="belleza">Belleza</option>
          <option value="bloques">Bloques</option>
        </select>
        <select id="filter-stock">
          <option value="">Todos los niveles</option>
          <option value="low">Stock bajo (≤5)</option>
          <option value="medium">Stock medio (6-15)</option>
          <option value="good">Stock bueno (>15)</option>
        </select>
      </div>

      <div class="inventory-table">
        <table>
          <thead>
            <tr>
              <th style="width:60px">Imagen</th>
              <th style="min-width:180px">Producto</th>
              <th style="width:130px">Código Barras</th>
              <th style="width:110px">Código Proveedor</th>
              <th style="width:110px">Categoría</th>
              <th style="width:80px;text-align:center">Sophie Store</th>
              <th style="width:80px;text-align:center">Sophie Mall</th>
              <th style="width:80px;text-align:center">Sophie's Ticados</th>
              <th style="width:80px;text-align:center">Bodega</th>
              <th style="width:80px;text-align:center">Total</th>
              <th style="width:100px;text-align:center">Estado</th>
              <th style="min-width:180px">Acciones</th>
            </tr>
          </thead>
          <tbody id="inventory-tbody">
            <!-- Los productos se cargarán dinámicamente -->
          </tbody>
        </table>
        <div id="inventory-pagination" class="pagination" style="margin:18px 0;display:flex;justify-content:center;gap:10px"></div>
      </div>
    </main>

    <!-- Modal para ajustar inventario -->
    <div id="adjust-modal" class="modal">
      <div class="modal-content" style="max-width:700px;max-height:85vh;overflow-y:auto">
        <h2>Ajustar Inventario</h2>
        <div id="adjust-product-info"></div>
        <form id="adjust-form">
          <input type="hidden" id="adjust-product-id">
          <div id="adjust-inventory-fields">
            <!-- Los campos se generarán dinámicamente -->
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" id="btn-cancel-adjust">Cancelar</button>
            <button type="submit" class="btn-save">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar producto desde inventario -->
    <div id="add-product-modal" class="modal">
      <div class="modal-content">
        <h2>Agregar Producto al Inventario</h2>
        <form id="add-product-form-inventory">
          <div class="form-group">
            <label for="inv-product-title">Nombre del Producto *</label>
            <input type="text" id="inv-product-title" required>
          </div>

          <div class="form-group">
            <label for="inv-product-category">Categoría *</label>
            <select id="inv-product-category" required>
              <option value="">Seleccionar categoría</option>
              <option value="peluches">Peluches</option>
              <option value="tazas">Tazas</option>
              <option value="vasos">Vasos</option>
              <option value="mochilas">Mochilas</option>
              <option value="papeleria">Papelería</option>
              <option value="decoracion">Decoración</option>
              <option value="botellas">Botellas</option>
              <option value="belleza">Belleza</option>
              <option value="bloques">Bloques</option>
            </select>
          </div>

          <div class="form-group">
            <label for="inv-product-price">Precio (₡) *</label>
            <input type="number" id="inv-product-price" min="0" step="500" required>
          </div>

          <div class="form-group">
            <label for="inv-product-desc">Descripción *</label>
            <textarea id="inv-product-desc" required></textarea>
          </div>

          <div class="form-group">
            <label for="inv-product-img">Subir Imagen *</label>
            <input type="file" id="inv-product-img" accept="image/*" required>
            <small>Formatos: JPG, PNG, WebP | Máx. 5MB</small>
            <div id="inv-image-preview" class="image-preview-container">
              <span style="color: #999;">📷 No hay imagen seleccionada</span>
            </div>
          </div>

          <div class="form-group">
            <label for="inv-product-barcode">Código de Barras (opcional)</label>
            <input type="text" id="inv-product-barcode" placeholder="Dejar vacío para generar automáticamente" style="font-family:monospace;">
            <small style="color:#666;display:block;margin-top:4px;">Si no ingresa un código, se generará uno automáticamente basado en el ID del producto</small>
          </div>

          <div class="form-group">
            <label for="inv-product-supplier-code">Código de Proveedor (opcional)</label>
            <input type="text" id="inv-product-supplier-code" placeholder="Código del proveedor" style="font-family:monospace;">
            <small style="color:#666;display:block;margin-top:4px;">Identificador único del proveedor para rastreo</small>
          </div>

          <div class="form-group">
            <label style="font-weight:600;color:#5a2032;margin-bottom:8px;display:block">Inventario Inicial por Ubicación</label>
            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:12px">
              <div>
                <label for="inv-inventory-tienda1" style="font-size:0.9rem;color:#666">Sophie Store</label>
                <input type="number" id="inv-inventory-tienda1" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
              <div>
                <label for="inv-inventory-tienda2" style="font-size:0.9rem;color:#666">Sophie Mall</label>
                <input type="number" id="inv-inventory-tienda2" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
              <div>
                <label for="inv-inventory-tienda3" style="font-size:0.9rem;color:#666">Sophie's Ticados</label>
                <input type="number" id="inv-inventory-tienda3" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
              <div>
                <label for="inv-inventory-bodega" style="font-size:0.9rem;color:#666">Bodega</label>
                <input type="number" id="inv-inventory-bodega" min="0" value="0" style="padding:8px;border:1px solid #e3cfe0;border-radius:6px;width:100%">
              </div>
            </div>
            <div style="margin-top:8px;padding:10px;background:#fff3e0;border-radius:6px;font-size:0.9rem;color:#f57c00">
              <strong>⚠️ Nota:</strong> Este producto se agregará desactivado en el Admin. Deberá activarlo manualmente para que sea visible en la tienda.
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" id="btn-cancel-add-product">Cancelar</button>
            <button type="submit" class="btn-save">Agregar Producto</button>
          </div>
        </form>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
                              // Autocompletado para productos en transferencia
                              document.addEventListener('DOMContentLoaded', function() {
                                const input = document.getElementById('transfer-input');
                                const suggestions = document.getElementById('transfer-suggestions');
                                if (input && suggestions) {
                                  input.addEventListener('input', function() {
                                    const val = input.value.trim().toLowerCase();
                                    if (!val || !productsData) {
                                      suggestions.style.display = 'none';
                                      return;
                                    }
                                    const claves = val.split(',').map(c => c.trim()).filter(c => c.length > 0);
                                    const last = claves[claves.length - 1];
                                    if (!last) {
                                      suggestions.style.display = 'none';
                                      return;
                                    }
                                    const matches = [];
                                    productsData.forEach(p => {
                                      const titleMatch = p.title && p.title.toLowerCase().includes(last);
                                      const barcodeMatch = p.barcode && p.barcode.toLowerCase().includes(last);
                                      if (titleMatch || barcodeMatch) {
                                        matches.push({
                                          label: p.title,
                                          barcode: p.barcode
                                        });
                                      }
                                      if (p.variants && Array.isArray(p.variants.options)) {
                                        p.variants.options.forEach(opt => {
                                          if (!opt || !opt.barcode) return;
                                          const optName = opt.name ? opt.name : 'Variante';
                                          const optLabel = `${p.title} (${optName})`;
                                          const optMatch = optLabel.toLowerCase().includes(last) || opt.barcode.toLowerCase().includes(last);
                                          if (optMatch) {
                                            matches.push({
                                              label: optLabel,
                                              barcode: opt.barcode
                                            });
                                          }
                                        });
                                      }
                                    });
                                    const limited = matches.slice(0, 8);
                                    if (limited.length === 0) {
                                      suggestions.style.display = 'none';
                                      return;
                                    }
                                    suggestions.innerHTML = limited.map(p => `<div class="suggestion-item" style="padding:6px 10px;cursor:pointer" data-value="${p.barcode}">${p.label} <span style='color:#888;font-size:0.85em'>(${p.barcode})</span></div>`).join('');
                                    suggestions.style.display = 'block';
                                    Array.from(suggestions.children).forEach(item => {
                                      item.addEventListener('mousedown', function(e) {
                                        e.preventDefault();
                                        const valActual = input.value;
                                        const arr = valActual.split(',').map(c => c.trim());
                                        arr[arr.length - 1] = item.getAttribute('data-value');
                                        input.value = arr.join(', ') + ', ';
                                        suggestions.style.display = 'none';
                                      });
                                    });
                                  });
                                  input.addEventListener('blur', function() {
                                    setTimeout(() => { suggestions.style.display = 'none'; }, 150);
                                  });
                                }
                              });
                        // Modal para transferir productos de bodega a tienda
                        document.addEventListener('DOMContentLoaded', function() {
                          const openBtn = document.getElementById('open-transfer-modal');
                          const modal = document.getElementById('transfer-modal');
                          const closeBtn = document.getElementById('close-transfer-modal');
                          const usuarioInput = document.getElementById('transfer-usuario');
                          
                          if (openBtn && modal) {
                            openBtn.addEventListener('click', () => {
                              // Llenar el campo con el usuario logueado
                              const loggedUser = sessionStorage.getItem('adminUsername') || sessionStorage.getItem('poasUsername') || localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser') || '';
                              if (usuarioInput) {
                                usuarioInput.value = loggedUser;
                              }
                              modal.setAttribute('aria-hidden', 'false');
                              modal.style.display = 'block';
                            });
                          }
                          if (closeBtn && modal) {
                            closeBtn.addEventListener('click', () => {
                              modal.setAttribute('aria-hidden', 'true');
                              modal.style.display = 'none';
                            });
                          }
                          if (modal) {
                            modal.addEventListener('click', (e) => {
                              if (e.target === modal) {
                                modal.setAttribute('aria-hidden', 'true');
                                modal.style.display = 'none';
                              }
                            });
                          }
                        });
                  // Transferir productos de bodega a tienda por código o nombre (múltiples)
                  document.addEventListener('DOMContentLoaded', function() {
                    const formTransfer = document.getElementById('form-transfer-bodega');
                    if (formTransfer) {
                      formTransfer.addEventListener('submit', function(e) {
                        e.preventDefault();
                        if (window.selectedProducts) {
                          return;
                        }
                        if (!productsData || !Array.isArray(productsData)) {
                          alert('No hay productos cargados.');
                          return;
                        }
                        const usuario = document.getElementById('transfer-usuario').value.trim();
                        const rawInput = document.getElementById('transfer-input').value.trim();
                        // const cantidadGlobal = parseInt(document.getElementById('transfer-cantidad').value) || null;
                        if (!usuario) {
                          alert('Debes ingresar tu nombre de usuario.');
                          document.getElementById('transfer-usuario').focus();
                          return;
                        }
                        if (!rawInput) {
                          alert('Debes ingresar al menos un código o nombre de producto.');
                          document.getElementById('transfer-input').focus();
                          return;
                        }
                        const claves = rawInput.split(',').map(c => c.trim()).filter(c => c.length > 0);
                        let transferidos = 0, productosProcesados = [];
                        claves.forEach(clave => {
                          let prod = productsData.find(p => (p.barcode && p.barcode.toLowerCase() === clave.toLowerCase()) || (p.title && p.title.toLowerCase() === clave.toLowerCase()));
                          if (prod && prod.inventory && prod.inventory.bodega > 0) {
                            let cantidad = cantidadGlobal !== null ? Math.min(cantidadGlobal, prod.inventory.bodega) : prod.inventory.bodega;
                            prod.inventory[destino] = (prod.inventory[destino] || 0) + cantidad;
                            prod.inventory.bodega -= cantidad;
                            transferidos += cantidad;
                            productosProcesados.push(prod.title + ' (' + cantidad + ')');
                          }
                        });
                        if (typeof saveProductsToStorage !== 'undefined') {
                          saveProductsToStorage(productsData);
                        } else {
                          localStorage.setItem('products_data', JSON.stringify(productsData));
                        }
                        renderInventoryStats();
                        renderInventoryTable();
                        if (productosProcesados.length > 0) {
                          alert('Transferidos: ' + productosProcesados.join(', ') + '\nUsuario: ' + usuario);
                        } else {
                          alert('No se encontró ningún producto con inventario en bodega para transferir.');
                        }
                        // Cerrar modal al finalizar
                        const modal = document.getElementById('transfer-modal');
                        if (modal) {
                          modal.setAttribute('aria-hidden', 'true');
                          modal.style.display = 'none';
                        }
                      });
                    }
                  });
            // Importar inventario desde CSV
            document.addEventListener('DOMContentLoaded', function() {
              const importBtn = document.getElementById('import-inventory-btn');
              const importFile = document.getElementById('import-inventory-file');
              if(importBtn && importFile) {
                importBtn.addEventListener('click', () => importFile.click());
                importFile.addEventListener('change', function(e) {
                  const file = e.target.files[0];
                  if(!file) return;
                  const reader = new FileReader();
                  reader.onload = function(evt) {
                    // Procesar el CSV y convertirlo a productos
                    const csvText = evt.target.result;
                    let rows = csvText.split(/\r?\n/).filter(r => r.trim().length > 0);
                    if (rows.length < 2) {
                      alert('El archivo CSV no contiene datos válidos.');
                      return;
                    }
                    // Detectar separador y columnas
                    let header, sep;
                    if (rows[0].includes(';')) {
                      sep = ';';
                      header = rows[0].split(';').map(h => h.replace(/\"/g, '').trim());
                    } else {
                      sep = ',';
                      header = rows[0].split(',').map(h => h.replace(/\"/g, '').trim());
                    }
                    // Formato alternativo: CODIGO;DESCRIPCION;PRESENTACION;EXISTENCIAS
                    const idxCodigo = header.findIndex(h => h.toLowerCase().includes('codigo'));
                    const idxDesc = header.findIndex(h => h.toLowerCase().includes('descripcion'));
                    const idxPres = header.findIndex(h => h.toLowerCase().includes('presentacion'));
                    const idxExist = header.findIndex(h => h.toLowerCase().includes('exist'));
                    // Formato original: Producto, Categoría, Tienda 1, Tienda 2, Tienda 3, Bodega
                    const idxTitle = header.findIndex(h => h.toLowerCase().includes('producto'));
                    const idxCategory = header.findIndex(h => h.toLowerCase().includes('categor'));
                    const idxT1 = header.findIndex(h => h.toLowerCase().includes('tienda 1'));
                    const idxT2 = header.findIndex(h => h.toLowerCase().includes('tienda 2'));
                    const idxT3 = header.findIndex(h => h.toLowerCase().includes('tienda 3'));
                    const idxBodega = header.findIndex(h => h.toLowerCase().includes('bodega'));
                    let importedCount = 0, updatedCount = 0;
                    for (let i = 1; i < rows.length; i++) {
                      const cols = rows[i].split(new RegExp(sep + '(?=(?:[^"]*"[^"]*")*[^"]*$)')).map(c => c.replace(/^\"|\"$/g, '').trim());
                      // Si es formato alternativo (CODIGO...)
                      if (idxCodigo !== -1 && idxDesc !== -1 && idxExist !== -1) {
                        const title = cols[idxDesc] || '';
                        const category = cols[idxPres] || 'otros';
                        const inventory = {
                          tienda1: 0,
                          tienda2: 0,
                          tienda3: 0,
                          bodega: parseInt(cols[idxExist]) || 0
                        };
                        if (!title) continue;
                        let prod = productsData.find(p => p.title === title && p.category === category);
                        if (prod) {
                          prod.inventory = { ...inventory };
                          updatedCount++;
                        } else {
                          const newId = Math.max(0, ...productsData.map(p => p.id)) + 1;
                          prod = {
                            id: newId,
                            title,
                            category,
                            price: 0,
                            desc: '',
                            img: '',
                            images: [],
                            gender: 'unisex',
                            barcode: (cols[idxCodigo] ? String(cols[idxCodigo]) : ('SOPHIE' + String(newId).padStart(6, '0'))),
                            outOfStock: false,
                            active: false,
                            inventory,
                            sold: 0
                          };
                          productsData.push(prod);
                          importedCount++;
                        }
                        continue;
                      }
                      // Si es formato original (Producto...)
                      if (idxTitle !== -1 && idxCategory !== -1 && idxBodega !== -1) {
                        if (!cols[idxTitle] || !cols[idxCategory]) continue;
                        const title = cols[idxTitle];
                        const category = cols[idxCategory];
                        const inventory = {
                          tienda1: parseInt(cols[idxT1]) || 0,
                          tienda2: parseInt(cols[idxT2]) || 0,
                          tienda3: parseInt(cols[idxT3]) || 0,
                          bodega: parseInt(cols[idxBodega]) || 0
                        };
                        let prod = productsData.find(p => p.title === title && p.category === category);
                        if (prod) {
                          prod.inventory = { ...inventory };
                          updatedCount++;
                        } else {
                          const newId = Math.max(0, ...productsData.map(p => p.id)) + 1;
                          prod = {
                            id: newId,
                            title,
                            category,
                            price: 0,
                            desc: '',
                            img: '',
                            images: [],
                            gender: 'unisex',
                            barcode: 'SOPHIE' + String(newId).padStart(6, '0'),
                            outOfStock: false,
                            active: false,
                            inventory,
                            sold: 0
                          };
                          productsData.push(prod);
                          importedCount++;
                        }
                        continue;
                      }
                    }
                    // Guardar en localStorage
                    if (typeof saveProductsToStorage !== 'undefined') {
                      saveProductsToStorage(productsData);
                    } else {
                      localStorage.setItem('products_data', JSON.stringify(productsData));
                    }
                    renderInventoryStats();
                    renderInventoryTable();
                    alert('Importación completada. ' + (importedCount ? ('Nuevos: ' + importedCount + '. ') : '') + (updatedCount ? ('Actualizados: ' + updatedCount + '.') : ''));
                  };
                  reader.readAsText(file);
                });
              }
            });
      // Función para abrir el tab de apartados
      function openApartadosTab() {
        window.location.href = 'pos.html';
      }

      // Verificar autenticación y tipo de usuario
      if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }
      
      // Redirigir vendedores a POS
      const userType = sessionStorage.getItem('userType');
      if (userType === 'vendedor') {
        window.location.href = 'pos.html';
      }
      
      let productsData = [];
      
      function openApartadosTab() {
        window.location.href = 'pos.html';
      }
      
      function checkAdminAccessAndNavigate(page) {
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
          alert('⛔ Acceso denegado.\nDebes estar autenticado como administrador para acceder a ' + (page === 'admin.html' ? 'Administración' : 'Inventario'));
          return;
        }
        window.location.href = page;
      }

      // Variable global para almacenar la imagen cargada en Base64
      let inventoryLoadedImage = null;

      function handleInventoryImageUpload(e) {
        const file = e.target.files[0];
        const previewContainer = document.getElementById('inv-image-preview');
        
        if (!file) {
          previewContainer.innerHTML = '<span style="color: #999;">📷 No hay imagen seleccionada</span>';
          previewContainer.classList.remove('has-image');
          inventoryLoadedImage = null;
          return;
        }

        // Validar tamaño (5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('La imagen es demasiado grande. Máximo 5MB.');
          e.target.value = '';
          previewContainer.innerHTML = '<span style="color: #999;">📷 No hay imagen seleccionada</span>';
          previewContainer.classList.remove('has-image');
          inventoryLoadedImage = null;
          return;
        }

        // Convertir a Base64
        const reader = new FileReader();
        reader.onload = (event) => {
          inventoryLoadedImage = event.target.result;
          previewContainer.innerHTML = `
            <span style="color: #4caf50; font-weight: 600;">✓ Imagen cargada</span>
            <img src="${inventoryLoadedImage}" alt="Preview">
          `;
          previewContainer.classList.add('has-image');
        };
        reader.readAsDataURL(file);
      }

      window.addEventListener('DOMContentLoaded', () => {
        if (typeof loadProductsFromStorage !== 'undefined') {
          productsData = loadProductsFromStorage();
        } else if (typeof products !== 'undefined') {
          productsData = [...products];
        }
        
        renderInventoryStats();
        renderInventoryTable();
        setupInventoryListeners();
      });

      function setupInventoryListeners() {
        const searchInput = document.getElementById('search-inventory');
        const filterCategory = document.getElementById('filter-category-inventory');
        const filterStock = document.getElementById('filter-stock');
        const exportBtn = document.getElementById('export-inventory');
        const addProductBtn = document.getElementById('btn-add-product-inventory');
        const invProductImgInput = document.getElementById('inv-product-img');

        if (searchInput) searchInput.addEventListener('input', filterInventory);
        if (filterCategory) filterCategory.addEventListener('change', filterInventory);
        if (filterStock) filterStock.addEventListener('change', filterInventory);
        if (exportBtn) exportBtn.addEventListener('click', exportInventory);

        // Event listener para previsualización de imagen
        if (invProductImgInput) {
          invProductImgInput.addEventListener('change', handleInventoryImageUpload);
        }

        // Modal para agregar producto
        const addProductModal = document.getElementById('add-product-modal');
        const addProductForm = document.getElementById('add-product-form-inventory');
        const btnCancelAddProduct = document.getElementById('btn-cancel-add-product');

        if (addProductBtn) {
          addProductBtn.addEventListener('click', () => {
            document.getElementById('inv-product-title').value = '';
            document.getElementById('inv-product-category').value = '';
            document.getElementById('inv-product-price').value = '';
            document.getElementById('inv-product-desc').value = '';
            document.getElementById('inv-product-img').value = '';
            document.getElementById('inv-product-barcode').value = '';
            document.getElementById('inv-inventory-tienda1').value = '0';
            document.getElementById('inv-inventory-tienda2').value = '0';
            document.getElementById('inv-inventory-tienda3').value = '0';
            document.getElementById('inv-inventory-bodega').value = '0';
            
            // Limpiar previsualización de imagen
            inventoryLoadedImage = null;
            const previewContainer = document.getElementById('inv-image-preview');
            if (previewContainer) {
              previewContainer.innerHTML = '<span style="color: #999;">📷 No hay imagen seleccionada</span>';
              previewContainer.classList.remove('has-image');
            }
            
            addProductModal.setAttribute('aria-hidden', 'false');
          });
        }

        if (btnCancelAddProduct) {
          btnCancelAddProduct.addEventListener('click', () => {
            addProductModal.setAttribute('aria-hidden', 'true');
          });
        }

        if (addProductModal) {
          addProductModal.addEventListener('click', (e) => {
            if (e.target === addProductModal) {
              addProductModal.setAttribute('aria-hidden', 'true');
            }
          });
        }

        if (addProductForm) {
          addProductForm.addEventListener('submit', handleAddProductSubmit);
        }

        // Modal ajustar inventario
        const modal = document.getElementById('adjust-modal');
        const btnCancel = document.getElementById('btn-cancel-adjust');
        const form = document.getElementById('adjust-form');

        if (btnCancel) {
          btnCancel.addEventListener('click', () => {
            modal.setAttribute('aria-hidden', 'true');
          });
        }

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.setAttribute('aria-hidden', 'true');
            }
          });
        }

        if (form) {
          form.addEventListener('submit', handleAdjustSubmit);
        }

        // Hamburger menu
        const hamburger = document.getElementById('hamburger');
        const navDrawer = document.getElementById('nav-drawer');
        const navOverlay = document.getElementById('nav-overlay');
        const closeNav = document.getElementById('close-nav');

        if (hamburger) {
          hamburger.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'false');
            navOverlay.setAttribute('aria-hidden', 'false');
          });
        }

        if (closeNav) {
          closeNav.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        if (navOverlay) {
          navOverlay.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        // Cerrar sesión
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            if (confirm('¿Deseas cerrar sesión?')) {
              sessionStorage.removeItem('adminLoggedIn');
              sessionStorage.removeItem('adminUsername');
              window.location.href = 'login.html';
            }
          });
        }
      }

      function renderInventoryStats() {
        let tienda1Total = 0, tienda2Total = 0, tienda3Total = 0, bodegaTotal = 0;

        productsData.forEach(product => {
          const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          tienda1Total += inv.tienda1 || 0;
          tienda2Total += inv.tienda2 || 0;
          tienda3Total += inv.tienda3 || 0;
          bodegaTotal += inv.bodega || 0;
        });

        const total = tienda1Total + tienda2Total + tienda3Total + bodegaTotal;

        document.getElementById('stat-tienda1').textContent = tienda1Total.toLocaleString();
        document.getElementById('stat-tienda2').textContent = tienda2Total.toLocaleString();
        document.getElementById('stat-tienda3').textContent = tienda3Total.toLocaleString();
        document.getElementById('stat-bodega').textContent = bodegaTotal.toLocaleString();
        document.getElementById('stat-total').textContent = total.toLocaleString();
      }

      function renderInventoryTable(filteredProducts = productsData) {
        const tbody = document.getElementById('inventory-tbody');
        if (!tbody) return;

        tbody.innerHTML = '';

        // Paginación
        const totalPages = Math.max(1, Math.ceil(filteredProducts.length / INVENTORY_PRODUCTS_PER_PAGE));
        if (inventoryCurrentPage > totalPages) inventoryCurrentPage = totalPages;
        const start = (inventoryCurrentPage - 1) * INVENTORY_PRODUCTS_PER_PAGE;
        const visible = filteredProducts.slice(start, start + INVENTORY_PRODUCTS_PER_PAGE);
        renderInventoryPagination(totalPages);

        if (visible.length === 0) {
          tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:40px;color:#999">No hay productos para mostrar</td></tr>';
          return;
        }

        visible.forEach(product => {
          // Calcular inventario total considerando variantes
          let inv = {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          let total = 0;
          
          if (product.variants && product.variants.options && product.variants.options.length > 0) {
            // Si tiene variantes, sumar el inventario de todas las opciones
            product.variants.options.forEach(option => {
              const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
              inv.tienda1 += (optInv.tienda1 || 0);
              inv.tienda2 += (optInv.tienda2 || 0);
              inv.tienda3 += (optInv.tienda3 || 0);
              inv.bodega += (optInv.bodega || 0);
            });
            total = inv.tienda1 + inv.tienda2 + inv.tienda3 + inv.bodega;
          } else {
            // Sin variantes, usar inventario directo
            inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            total = (inv.tienda1 || 0) + (inv.tienda2 || 0) + (inv.tienda3 || 0) + (inv.bodega || 0);
          }

          function getStockClass(qty) {
            if (qty <= 5) return 'stock-low';
            if (qty <= 15) return 'stock-medium';
            return 'stock-good';
          }

          // Determinar estado: disponible o agotado (verificar inventario y marca manual)
          const statusBadge = (total === 0 || product.outOfStock === true)
            ? '<span style="display:inline-block;background:#f44336;color:white;padding:4px 10px;border-radius:16px;font-weight:600;font-size:0.75rem;white-space:nowrap">Agotado</span>'
            : '<span style="display:inline-block;background:#4caf50;color:white;padding:4px 10px;border-radius:16px;font-weight:600;font-size:0.75rem;white-space:nowrap">Disponible</span>';

          const tr = document.createElement('tr');
          
          // Generar código de barras y proveedor display
          let barcodeDisplay = '';
          let supplierCodeDisplay = '';
          if (product.variants && product.variants.options && product.variants.options.length > 0) {
            barcodeDisplay = '<select style="font-family:monospace;font-size:0.75rem;color:#666;background:#f7f0f6;padding:4px 6px;border:1px solid #e0d0e0;border-radius:4px;width:100%">';
            supplierCodeDisplay = '<select style="font-family:monospace;font-size:0.75rem;color:#666;background:#f7f0f6;padding:4px 6px;border:1px solid #e0d0e0;border-radius:4px;width:100%">';
            product.variants.options.forEach(option => {
              const barcode = option.barcode || 'N/A';
              const supplierCode = option.supplier_code || '—';
              barcodeDisplay += `<option>${option.name}: ${barcode}</option>`;
              supplierCodeDisplay += `<option>${option.name}: ${supplierCode}</option>`;
            });
            barcodeDisplay += '</select>';
            supplierCodeDisplay += '</select>';
          } else {
            barcodeDisplay = `<div style="font-family:monospace;font-size:0.8rem;color:#666;background:#f7f0f6;padding:4px 8px;border-radius:4px;text-align:center">${product.barcode || 'N/A'}</div>`;
            supplierCodeDisplay = `<div style="font-family:monospace;font-size:0.8rem;color:#666;background:#f7f0f6;padding:4px 8px;border-radius:4px;text-align:center">${product.supplier_code || '—'}</div>`;
          }
          
          tr.innerHTML = `
            <td><img src="${product.img}" alt="${product.title}" class="product-img-small" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'60\\' height=\\'60\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'60\\' height=\\'60\\'/%3E%3C/svg%3E'"></td>
            <td><strong class="inventory-product-title" style="color:#5a2032;font-family:'CenturyGothic',Playfair Display,serif">${product.title}</strong></td>
            <td>${barcodeDisplay}</td>
            <td>${supplierCodeDisplay}</td>
            <td style="font-size:0.85rem;color:#666">${product.category}</td>
            <td class="stock-cell ${getStockClass(inv.tienda1 || 0)}">${inv.tienda1 || 0}</td>
            <td class="stock-cell ${getStockClass(inv.tienda2 || 0)}">${inv.tienda2 || 0}</td>
            <td class="stock-cell ${getStockClass(inv.tienda3 || 0)}">${inv.tienda3 || 0}</td>
            <td class="stock-cell ${getStockClass(inv.bodega || 0)}">${inv.bodega || 0}</td>
            <td class="stock-cell" style="font-weight:900;color:#5a2032;font-size:1.1rem">${total}</td>
            <td style="text-align:center">${statusBadge}</td>
            <td style="white-space:nowrap">
              <button class="btn-adjust" data-id="${product.id}">Ajustar</button>
              <button class="btn-delete-inv" data-id="${product.id}" style="margin-left:6px;background:#f44336;color:white;border:none;border-radius:6px;padding:6px 10px;font-weight:600;cursor:pointer;font-size:0.8rem">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('.btn-adjust').forEach(btn => {
          btn.addEventListener('click', () => openAdjustModal(parseInt(btn.dataset.id)));
        });

        tbody.querySelectorAll('.btn-delete-inv').forEach(btn => {
          btn.addEventListener('click', () => deleteProductFromInventory(parseInt(btn.dataset.id)));
        });
      }

      function filterInventory() {
        const searchTerm = document.getElementById('search-inventory').value.toLowerCase();
        const categoryFilter = document.getElementById('filter-category-inventory').value;
        const stockFilter = document.getElementById('filter-stock').value;

        const filtered = productsData.filter(product => {
          // Buscar en nombre del producto
          let matchesSearch = product.title.toLowerCase().includes(searchTerm);
          
          // Buscar en código de barras principal
          if (!matchesSearch && product.barcode) {
            matchesSearch = product.barcode.toLowerCase().includes(searchTerm);
          }
          
          // Buscar en código de proveedor
          if (!matchesSearch && product.supplier_code) {
            matchesSearch = product.supplier_code.toLowerCase().includes(searchTerm);
          }
          
          // Buscar en códigos de barras o proveedor de variantes
          if (!matchesSearch && product.variants && product.variants.options) {
            matchesSearch = product.variants.options.some(option =>
              (option.barcode && option.barcode.toLowerCase().includes(searchTerm)) ||
              (option.supplier_code && option.supplier_code.toLowerCase().includes(searchTerm))
            );
          }
          
          const matchesCategory = !categoryFilter || product.category === categoryFilter;
          
          let matchesStock = true;
          if (stockFilter) {
            // Calcular total considerando variantes
            let total = 0;
            if (product.variants && product.variants.options && product.variants.options.length > 0) {
              product.variants.options.forEach(option => {
                const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
                total += (optInv.tienda1 || 0) + (optInv.tienda2 || 0) + (optInv.tienda3 || 0) + (optInv.bodega || 0);
              });
            } else {
              const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
              total = (inv.tienda1 || 0) + (inv.tienda2 || 0) + (inv.tienda3 || 0) + (inv.bodega || 0);
            }
            
            if (stockFilter === 'low') matchesStock = total <= 5;
            else if (stockFilter === 'medium') matchesStock = total > 5 && total <= 15;
            else if (stockFilter === 'good') matchesStock = total > 15;
          }

          return matchesSearch && matchesCategory && matchesStock;
        });

        renderInventoryTable(filtered);
      }

      function openAdjustModal(productId) {
        const product = productsData.find(p => p.id === productId);
        if (!product) return;

        const modal = document.getElementById('adjust-modal');
        const productInfo = document.getElementById('adjust-product-info');
        const fieldsContainer = document.getElementById('adjust-inventory-fields');
        
        productInfo.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#f9f9f9;border-radius:8px;margin-bottom:20px">
            <img src="${product.img}" alt="${product.title}" style="width:60px;height:60px;object-fit:cover;border-radius:8px">
            <div>
              <h3 style="margin:0;color:#5a2032;font-family:'CenturyGothic',Playfair Display,serif">${product.title}</h3>
              <p style="margin:4px 0 0 0;color:#666">Categoría: ${product.category}</p>
            </div>
          </div>
        `;

        document.getElementById('adjust-product-id').value = product.id;
        
        // Verificar si tiene variantes
        if (product.variants && product.variants.options && product.variants.options.length > 0) {
          // Producto con variantes: crear campos para cada variante
          fieldsContainer.innerHTML = `
            <p style="color:#5a2032;font-weight:600;margin-bottom:12px">Ajustar inventario por variante:</p>
          `;
          
          product.variants.options.forEach((option, index) => {
            const inv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            fieldsContainer.innerHTML += `
              <div style="border:1px solid #e3cfe0;border-radius:8px;padding:12px;margin-bottom:12px;background:#fafafa">
                <h4 style="margin:0 0 8px 0;color:#5a2032;font-size:1rem">${option.name}</h4>
                <div style="margin-bottom:12px">
                  <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Código de Barras</label>
                  <input type="text" class="variant-barcode" data-variant-index="${index}" value="${option.barcode || ''}" placeholder="SOPHIE000000-1" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px;font-family:monospace">
                </div>
                <div style="margin-bottom:12px">
                  <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Código de Proveedor</label>
                  <input type="text" class="variant-supplier-code" data-variant-index="${index}" value="${option.supplier_code || ''}" placeholder="Código del proveedor" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px;font-family:monospace">
                </div>
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px">
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Sophie Store</label>
                    <input type="number" class="variant-tienda1" data-variant-index="${index}" min="0" value="${inv.tienda1 || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Sophie Mall</label>
                    <input type="number" class="variant-tienda2" data-variant-index="${index}" min="0" value="${inv.tienda2 || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Sophie's Ticados</label>
                    <input type="number" class="variant-tienda3" data-variant-index="${index}" min="0" value="${inv.tienda3 || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                  <div>
                    <label style="font-size:0.85rem;color:#666;display:block;margin-bottom:4px">Bodega</label>
                    <input type="number" class="variant-bodega" data-variant-index="${index}" min="0" value="${inv.bodega || 0}" style="width:100%;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  </div>
                </div>
              </div>
            `;
          });
        } else {
          // Producto simple: crear campos normales
          const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          fieldsContainer.innerHTML = `
            <div class="form-group">
              <label for="adjust-barcode">Código de Barras</label>
              <input type="text" id="adjust-barcode" value="${product.barcode || ''}" placeholder="SOPHIE000000" style="font-family:monospace">
            </div>
            <div class="form-group">
              <label for="adjust-supplier-code">Código de Proveedor</label>
              <input type="text" id="adjust-supplier-code" value="${product.supplier_code || ''}" placeholder="Código del proveedor" style="font-family:monospace">
            </div>
            <div class="form-group">
              <label for="adjust-tienda1">Sophie Store</label>
              <input type="number" id="adjust-tienda1" min="0" value="${inv.tienda1 || 0}">
            </div>
            <div class="form-group">
              <label for="adjust-tienda2">Sophie Mall</label>
              <input type="number" id="adjust-tienda2" min="0" value="${inv.tienda2 || 0}">
            </div>
            <div class="form-group">
              <label for="adjust-tienda3">Sophie's Ticados</label>
              <input type="number" id="adjust-tienda3" min="0" value="${inv.tienda3 || 0}">
            </div>
            <div class="form-group">
              <label for="adjust-bodega">Bodega</label>
              <input type="number" id="adjust-bodega" min="0" value="${inv.bodega || 0}">
            </div>
          `;
        }

        modal.setAttribute('aria-hidden', 'false');
      }

      function handleAdjustSubmit(e) {
        e.preventDefault();

        const productId = parseInt(document.getElementById('adjust-product-id').value);
        const product = productsData.find(p => p.id === productId);
        
        if (!product) return;

        const user = sessionStorage.getItem('adminUsername') || localStorage.getItem('loggedInUser') || 'Sin especificar';
        let cambios = [];

        // Verificar si tiene variantes
        if (product.variants && product.variants.options && product.variants.options.length > 0) {
          // Actualizar inventario y código de barras de cada variante
          product.variants.options.forEach((option, index) => {
            const tienda1Input = document.querySelector(`.variant-tienda1[data-variant-index="${index}"]`);
            const tienda2Input = document.querySelector(`.variant-tienda2[data-variant-index="${index}"]`);
            const tienda3Input = document.querySelector(`.variant-tienda3[data-variant-index="${index}"]`);
            const bodegaInput = document.querySelector(`.variant-bodega[data-variant-index="${index}"]`);
            const barcodeInput = document.querySelector(`.variant-barcode[data-variant-index="${index}"]`);
            const supplierCodeInput = document.querySelector(`.variant-supplier-code[data-variant-index="${index}"]`);
            
            if (tienda1Input && tienda2Input && tienda3Input && bodegaInput) {
              // Guardar valores antiguos
              const oldT1 = option.inventory?.tienda1 || 0;
              const oldT2 = option.inventory?.tienda2 || 0;
              const oldT3 = option.inventory?.tienda3 || 0;
              const oldBodega = option.inventory?.bodega || 0;
              
              const newT1 = parseInt(tienda1Input.value) || 0;
              const newT2 = parseInt(tienda2Input.value) || 0;
              const newT3 = parseInt(tienda3Input.value) || 0;
              const newBodega = parseInt(bodegaInput.value) || 0;
              
              option.inventory = {
                tienda1: newT1,
                tienda2: newT2,
                tienda3: newT3,
                bodega: newBodega
              };
              
              // Registrar cambio si hay diferencia
              if (oldT1 !== newT1 || oldT2 !== newT2 || oldT3 !== newT3 || oldBodega !== newBodega) {
                cambios.push(`${option.name}: Sophie Store ${oldT1}→${newT1}, Sophie Mall ${oldT2}→${newT2}, Sophie's Ticados ${oldT3}→${newT3}, Bodega ${oldBodega}→${newBodega}`);
              }
              
              // Actualizar código de barras
              if (barcodeInput) {
                option.barcode = barcodeInput.value.trim() || ('SOPHIE' + String(product.id).padStart(6, '0') + '-' + String(index + 1));
              }
              if (supplierCodeInput) {
                option.supplier_code = supplierCodeInput.value.trim() || '';
              }
            }
          });

          const supplierCodeInput = document.getElementById('adjust-supplier-code');
          if (supplierCodeInput) {
            product.supplier_code = supplierCodeInput.value.trim() || '';
          }
        } else {
          // Actualizar inventario y código de barras del producto simple
          const oldT1 = product.inventory?.tienda1 || 0;
          const oldT2 = product.inventory?.tienda2 || 0;
          const oldT3 = product.inventory?.tienda3 || 0;
          const oldBodega = product.inventory?.bodega || 0;
          
          const newT1 = parseInt(document.getElementById('adjust-tienda1').value) || 0;
          const newT2 = parseInt(document.getElementById('adjust-tienda2').value) || 0;
          const newT3 = parseInt(document.getElementById('adjust-tienda3').value) || 0;
          const newBodega = parseInt(document.getElementById('adjust-bodega').value) || 0;
          
          product.inventory = {
            tienda1: newT1,
            tienda2: newT2,
            tienda3: newT3,
            bodega: newBodega
          };
          
          // Registrar cambio si hay diferencia
          if (oldT1 !== newT1 || oldT2 !== newT2 || oldT3 !== newT3 || oldBodega !== newBodega) {
            cambios.push(`Sophie Store ${oldT1}→${newT1}, Sophie Mall ${oldT2}→${newT2}, Sophie's Ticados ${oldT3}→${newT3}, Bodega ${oldBodega}→${newBodega}`);
          }
          
          // Actualizar código de barras
          const barcodeInput = document.getElementById('adjust-barcode');
          if (barcodeInput) {
            product.barcode = barcodeInput.value.trim() || ('SOPHIE' + String(product.id).padStart(6, '0'));
          }
          
          // Actualizar código de proveedor
          const supplierCodeInput = document.getElementById('adjust-supplier-code');
          if (supplierCodeInput) {
            product.supplier_code = supplierCodeInput.value.trim() || '';
          }
        }

        // Guardar en localStorage
        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        } else {
          // Fallback si no está disponible saveProductsToStorage
          localStorage.setItem('products_data', JSON.stringify(productsData));
        }

        // Registrar en historial de transferencias si hay cambios
        if (cambios.length > 0) {
          const historyEntry = {
            id: Date.now(),
            fecha: new Date().toISOString(),
            usuario: user,
            productos: cambios.map(cambio => ({
              titulo: product.title + ' - ' + cambio,
              codigo: product.barcode || 'N/A',
              cantidad: '',
              destino: 'ajuste'
            }))
          };
          const history = JSON.parse(localStorage.getItem('transfer_history') || '[]');
          history.push(historyEntry);
          localStorage.setItem('transfer_history', JSON.stringify(history));
        }

        document.getElementById('adjust-modal').setAttribute('aria-hidden', 'true');
        renderInventoryStats();
        renderInventoryTable();
        alert('Inventario actualizado correctamente ✅');
      }

      function deleteProductFromInventory(id) {
        const product = productsData.find(p => p.id === id);
        if (!product) return;

        if (!confirm('¿Estás seguro de eliminar este producto del inventario?')) return;

        const index = productsData.findIndex(p => p.id === id);
        if (index === -1) return;

        productsData.splice(index, 1);

        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        } else {
          localStorage.setItem('products_data', JSON.stringify(productsData));
        }

        renderInventoryStats();
        renderInventoryTable();
        alert('Producto eliminado correctamente ✅');
      }

      function exportInventory() {
        let csv = 'Producto,Categoría,Tienda 1,Tienda 2,Tienda 3,Bodega,Total\n';

        productsData.forEach(product => {
          const inv = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          const total = (inv.tienda1 || 0) + (inv.tienda2 || 0) + (inv.tienda3 || 0) + (inv.bodega || 0);
          
          csv += `"${product.title}","${product.category}",${inv.tienda1 || 0},${inv.tienda2 || 0},${inv.tienda3 || 0},${inv.bodega || 0},${total}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `inventario_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function handleAddProductSubmit(e) {
        e.preventDefault();

        // Validar que se haya cargado una imagen
        if (!inventoryLoadedImage) {
          alert('Por favor carga una imagen del producto');
          return;
        }

        const newId = Math.max(0, ...productsData.map(p => p.id)) + 1;
        let barcode = document.getElementById('inv-product-barcode').value.trim();
        
        // Si no proporciona código de barras, generar uno automáticamente
        if (!barcode) {
          barcode = 'SOPHIE' + String(newId).padStart(6, '0');
        }

        const productData = {
          id: newId,
          title: document.getElementById('inv-product-title').value,
          category: document.getElementById('inv-product-category').value,
          price: parseFloat(document.getElementById('inv-product-price').value),
          desc: document.getElementById('inv-product-desc').value,
          img: inventoryLoadedImage,  // Usar la imagen en Base64
          images: [inventoryLoadedImage],  // Array con la imagen
          gender: 'unisex',
          barcode: barcode,  // ← NUEVO: Código de barras
          supplier_code: document.getElementById('inv-product-supplier-code').value.trim() || '',  // ← NUEVO: Código de proveedor
          outOfStock: false,
          active: false,  // ← PRODUCTOS AGREGADOS DESDE INVENTARIO SIEMPRE DESACTIVADOS
          inventory: {
            tienda1: parseInt(document.getElementById('inv-inventory-tienda1').value) || 0,
            tienda2: parseInt(document.getElementById('inv-inventory-tienda2').value) || 0,
            tienda3: parseInt(document.getElementById('inv-inventory-tienda3').value) || 0,
            bodega: parseInt(document.getElementById('inv-inventory-bodega').value) || 0
          },
          sold: 0
        };

        productsData.push(productData);

        // Guardar en localStorage
        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        } else {
          // Fallback si no está disponible saveProductsToStorage
          localStorage.setItem('products_data', JSON.stringify(productsData));
        }

        // Limpiar la imagen cargada
        inventoryLoadedImage = null;

        document.getElementById('add-product-modal').setAttribute('aria-hidden', 'true');
        renderInventoryStats();
        renderInventoryTable();
        alert('Producto agregado correctamente. Recuerda activarlo en el módulo de Administración para que sea visible en la tienda. ✅');
      }
    </script>
  </body>
</html>
