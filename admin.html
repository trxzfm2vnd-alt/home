  <!-- Pagination will be moved below the table -->
    <script>
    // Paginaci√≥n para administraci√≥n
    let adminCurrentPage = 1;
    const ADMIN_PRODUCTS_PER_PAGE = 20;
    function renderAdminPagination(totalPages) {
      const container = document.getElementById('admin-pagination');
      if (!container) return;
      if (totalPages <= 1) {
        container.innerHTML = '';
        container.style.display = 'none';
        return;
      }
      container.style.display = 'flex';
      container.innerHTML = `
        <button class="page-btn prev" ${adminCurrentPage===1 ? 'disabled aria-disabled="true"' : ''}>Anterior</button>
        <span class="page-info">P√°gina ${adminCurrentPage} de ${totalPages}</span>
        <button class="page-btn next" ${adminCurrentPage===totalPages ? 'disabled aria-disabled="true"' : ''}>Siguiente</button>
      `;
      const prev = container.querySelector('.page-btn.prev');
      const next = container.querySelector('.page-btn.next');
      if(prev) prev.addEventListener('click',()=>{ if(adminCurrentPage>1){ adminCurrentPage-=1; renderProductsTable(); } });
      if(next) next.addEventListener('click',()=>{ if(adminCurrentPage<totalPages){ adminCurrentPage+=1; renderProductsTable(); } });
    }
    </script>
<!doctype html>
<html lang="es">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Sophie</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .admin-tabs {
        max-width: 1400px;
        margin: 20px auto 0;
        padding: 0 20px;
        display: flex;
        gap: 4px;
        border-bottom: 2px solid #e3cfe0;
      }
      .admin-tab {
        padding: 14px 28px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #666;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: Montserrat, sans-serif;
        text-decoration: none;
        display: inline-block;
      }
      .admin-tab:hover {
        color: #5a2032;
        background: rgba(243, 229, 245, 0.3);
      }
      .admin-tab.active {
        color: #d946a6;
        border-bottom-color: #d946a6;
        background: rgba(243, 229, 245, 0.5);
      }
      .admin-container {
        max-width: 1400px;
        margin: 20px auto 40px;
        padding: 20px;
      }
      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--accent);
      }
      .admin-header h1 {
        font-family: Playfair Display, serif;
        color: #5a2032;
        margin: 0;
      }
      .btn-add {
        padding: 12px 24px;
        background: linear-gradient(135deg, #5a8dee, #3a70d6);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-add:hover {
        box-shadow: 0 4px 14px rgba(74, 144, 226, 0.5);
        transform: translateY(-2px);
      }
      .products-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(82, 44, 60, 0.1);
      }
      .products-table table {
        border-collapse: collapse;
      }
      .products-table th {
        background: linear-gradient(135deg, #f3e5f5, #fce4ec);
        padding: 16px;
        text-align: left;
        font-weight: 700;
        color: #5a2032;
        font-size: 0.95rem;
      }
      .products-table td {
        color: #3a2f33;
      }
      .products-table tr:hover {
        background: #fff8fb;
      }
      .product-img-small {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      .btn-edit, .btn-delete {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .btn-edit {
        background: #4caf50;
        color: white;
      }
      .btn-edit:hover {
        background: #45a049;
      }
      .btn-delete {
        background: #f44336;
        color: white;
      }
      .btn-delete:hover {
        background: #da190b;
      }
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        padding: 40px;
        border-radius: 16px;
        max-width: 800px;
        width: 95%;
        max-height: 95vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      }
      .modal-content h2 {
        margin-top: 0;
        margin-bottom: 30px;
        color: #5a2032;
        font-family: Playfair Display, serif;
        font-size: 1.8rem;
        border-bottom: 3px solid #e3cfe0;
        padding-bottom: 15px;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #5a2032;
        font-size: 0.95rem;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
        font-size: 0.95rem;
        transition: border-color 0.3s ease;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #c73b7f;
      }
      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }
      .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .image-item {
        position: relative;
        border: 2px solid #e3cfe0;
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1;
      }
      .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .image-item .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .image-item:hover .remove-btn {
        opacity: 1;
      }
      .image-item .remove-btn:hover {
        background: #da190b;
      }
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }
      .btn-cancel {
        padding: 10px 20px;
        background: #9e9e9e;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-cancel:hover {
        background: #757575;
      }
      .btn-save {
        padding: 10px 20px;
        background: linear-gradient(135deg, #5a8dee, #3a70d6);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn-save:hover {
        box-shadow: 0 4px 14px rgba(74, 144, 226, 0.5);
      }
      .search-filter {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .search-filter input,
      .search-filter select {
        padding: 10px;
        border: 1px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
      }
      .search-filter input {
        flex: 1;
        min-width: 250px;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <button id="hamburger" class="hamburger" aria-label="Abrir men√∫">‚ò∞</button>
        <a href="index.html" class="logo" style="text-decoration:none;cursor:pointer;display:flex;align-items:center;gap:10px">
          <span style="font-family:'Daily',Playfair Display,serif;font-size:2.5rem;font-weight:400;color:#2c4a8c">SophieWeb - Admin</span>
        </a>
        <a href="index.html" class="btn">‚Üê Volver a la tienda</a>
        <button id="logout-btn" class="btn" style="color:#f44336;font-weight:700">Cerrar Sesi√≥n</button>
      </div>
    </header>

    <div id="nav-overlay" class="nav-overlay" aria-hidden="true"></div>
    <aside id="nav-drawer" class="nav-drawer" aria-hidden="true">
      <div class="nav-drawer-inner">
        <button id="close-nav" class="close">‚úï</button>
        <nav class="nav-drawer-list">
          <a class="btn" href="index.html">Inicio</a>
          <a class="btn active" href="admin.html">Administraci√≥n</a>
        </nav>
      </div>
    </aside>

    <!-- Tabs de navegaci√≥n -->
    <div class="admin-tabs">
      <a href="pos.html" class="admin-tab">üí≥ Punto de Ventas</a>
      <a href="#" onclick="openApartadosTab(); return false;" class="admin-tab">üìã Apartados</a>
      <a href="#" onclick="openPedidosOnlineTab(); return false;" class="admin-tab">üì¶ Pedidos Online</a>
      <a href="admin.html" class="admin-tab active">üì¶ Administraci√≥n</a>
      <a href="#" onclick="checkAdminAccessAndNavigate('inventory.html'); return false;" class="admin-tab">üìä Inventario</a>
    </div>

    <main class="admin-container">
      <div class="admin-header">
        <h1>Administraci√≥n de Productos</h1>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn-add" id="btn-reset-sold" style="background:#ff9800">‚Ü∫ Reset vendidos</button>
          <p style="color:#999;font-size:0.9rem;margin:0;padding:10px;background:#f5f5f5;border-radius:6px">üí° Los productos se deben agregar desde el m√≥dulo de <strong>Inventario</strong></p>
        </div>
      </div>

      <div class="search-filter">
        <input type="text" id="search-input" placeholder="Buscar producto...">
        <select id="filter-category">
          <option value="">Todas las categor√≠as</option>
          <option value="peluches">Peluches</option>
          <option value="tazas">Tazas</option>
          <option value="vasos">Vasos</option>
          <option value="mochilas">Mochilas</option>
          <option value="papeleria">Papeler√≠a</option>
          <option value="decoracion">Decoraci√≥n</option>
          <option value="botellas">Botellas</option>
          <option value="belleza">Belleza</option>
          <option value="bloques">Bloques</option>
        </select>
      </div>

      <div class="products-table">
        <table>
          <thead>
            <tr>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Precio</th>
              <th>Variantes</th>
              <th>Vendidos</th>
              <th>Estado</th>
              <th>Activo</th>
              <th>Inventario</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="products-tbody">
            <!-- Productos se cargar√°n din√°micamente -->
          </tbody>
        </table>
        <div id="admin-pagination" class="pagination" style="margin:18px 0;display:flex;justify-content:center;gap:10px"></div>
      </div>
    </main>

    <!-- Modal para agregar/editar producto -->
    <div id="product-modal" class="modal">
      <div class="modal-content">
        <h2 id="modal-title">Agregar Producto</h2>
        <form id="product-form">
          <input type="hidden" id="product-id">
          
          <div class="form-group">
            <label for="product-title">Nombre del Producto *</label>
            <input type="text" id="product-title" required>
          </div>

          <div class="form-group">
            <label for="product-category">Categor√≠a *</label>
            <select id="product-category" required>
              <option value="">Seleccionar categor√≠a</option>
              <option value="peluches">Peluches</option>
              <option value="tazas">Tazas</option>
              <option value="vasos">Vasos</option>
              <option value="mochilas">Mochilas</option>
              <option value="papeleria">Papeler√≠a</option>
              <option value="decoracion">Decoraci√≥n</option>
              <option value="botellas">Botellas</option>
              <option value="belleza">Belleza</option>
              <option value="bloques">Bloques</option>
            </select>
          </div>

          <div class="form-group">
            <label for="product-price">Precio (‚Ç°) *</label>
            <input type="number" id="product-price" min="0" step="500" required>
          </div>

          <div class="form-group">
            <label for="product-desc">Descripci√≥n *</label>
            <textarea id="product-desc" required></textarea>
          </div>

          <div class="form-group">
            <label for="product-images">Im√°genes del Producto * (m√°x. 5)</label>
            <input type="file" id="product-images" accept="image/*" multiple required>
            <small style="color: #999; display: block; margin-top: 6px;">Formatos: JPG, PNG, WebP | M√°x. 5MB cada una | M√°ximo 5 im√°genes</small>
            <div id="images-preview" class="images-grid"></div>
          </div>

          <div class="form-group">
            <label for="product-gender">G√©nero</label>
            <select id="product-gender">
              <option value="unisex">Unisex</option>
              <option value="male">Masculino</option>
              <option value="female">Femenino</option>
            </select>
          </div>

          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="product-out-of-stock" style="width:auto;margin:0">
              <span>Producto agotado</span>
            </label>
          </div>

          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="product-active" checked style="width:auto;margin:0">
              <span>Producto activo (visible en la tienda)</span>
            </label>
          </div>



          <div class="form-group">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
              <input type="checkbox" id="has-variants" style="width:auto;margin:0;cursor:pointer">
              <label for="has-variants" style="cursor:pointer;margin:0">Este producto tiene variantes (colores, tama√±os, etc.)</label>
            </div>
            
            <div id="variants-section" style="display:none;border:1px solid #e3cfe0;border-radius:8px;padding:16px;background:#f9f9f9">
              <div class="form-group">
                <label for="variant-type">Tipo de variante *</label>
                <select id="variant-type">
                  <option value="">Seleccionar tipo</option>
                  <option value="color">Color</option>
                  <option value="tama√±o">Tama√±o</option>
                  <option value="personaje">Personaje</option>
                  <option value="casa">Casa</option>
                  <option value="otro">Otro</option>
                </select>
              </div>

              <div style="margin-bottom:12px">
                <label style="font-weight:600;color:#5a2032;margin-bottom:8px;display:block">Opciones de variante</label>
                <div id="variant-options-list"></div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input type="text" id="variant-option-name" placeholder="Nombre (ej: Rojo)" style="flex:1;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  <input type="number" id="variant-option-price" placeholder="Precio" style="width:120px;padding:8px;border:1px solid #e3cfe0;border-radius:6px">
                  <button type="button" id="add-variant-option" style="padding:8px 16px;background:#4caf50;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600">+ Agregar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" id="btn-cancel">Cancelar</button>
            <button type="submit" class="btn-save">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
      // Funci√≥n para abrir el tab de apartados
      function openApartadosTab() {
        window.location.href = 'pos.html';
      }

      // Variables globales para gestionar variantes
      let currentVariants = [];
      
      // Funciones para gestionar variantes
      function addVariantOption() {
        const name = document.getElementById('variant-option-name').value.trim();
        const price = parseFloat(document.getElementById('variant-option-price').value);
        
        if (!name || !price) {
          alert('Por favor completa el nombre y precio de la variante');
          return;
        }
        
        currentVariants.push({ name, price });
        renderVariantsList();
        
        // Limpiar campos
        document.getElementById('variant-option-name').value = '';
        document.getElementById('variant-option-price').value = '';
      }
      
      function renderVariantsList() {
        const list = document.getElementById('variant-options-list');
        if (!list) return;
        
        if (currentVariants.length === 0) {
          list.innerHTML = '<p style="color:#999;font-size:0.9rem;margin:0">No hay opciones agregadas</p>';
          return;
        }
        
        list.innerHTML = currentVariants.map((v, index) => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:white;border-radius:6px;margin-bottom:6px">
            <span><strong>${v.name}</strong> - ‚Ç°${v.price.toLocaleString()}</span>
            <button type="button" class="remove-variant-btn" data-index="${index}" style="padding:4px 8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85rem">Eliminar</button>
          </div>
        `).join('');
        
        // Agregar event listeners a los botones de eliminar
        list.querySelectorAll('.remove-variant-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.index);
            currentVariants.splice(index, 1);
            renderVariantsList();
          });
        });
      }
      
      // Toggle de secci√≥n de variantes - ejecutar cuando el DOM est√© listo
      function setupVariantsListeners() {
        const hasVariantsCheckbox = document.getElementById('has-variants');
        const variantsSection = document.getElementById('variants-section');
        const addVariantBtn = document.getElementById('add-variant-option');
        
        if (hasVariantsCheckbox && variantsSection) {
          hasVariantsCheckbox.addEventListener('change', (e) => {
            console.log('Checkbox cambiado:', e.target.checked);
            if (e.target.checked) {
              variantsSection.style.display = 'block';
            } else {
              variantsSection.style.display = 'none';
              currentVariants = [];
              renderVariantsList();
            }
          });
        } else {
          console.error('No se encontraron los elementos de variantes');
        }
        
        if (addVariantBtn) {
          addVariantBtn.addEventListener('click', addVariantOption);
        }
      }
    </script>

    <script>
      // Verificar autenticaci√≥n y tipo de usuario
      if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }
      
      // Redirigir vendedores a POS
      const userType = sessionStorage.getItem('userType');
      if (userType === 'vendedor') {
        window.location.href = 'pos.html';
      }

      // Copiar productos a una variable mutable
      let productsData = [];
      
      // Esperar a que el DOM y productos est√©n cargados
      
      function openApartadosTab() {
        window.location.href = 'pos.html';
      }
      
      function checkAdminAccessAndNavigate(page) {
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
          alert('‚õî Acceso denegado.\nDebes estar autenticado como administrador para acceder a ' + (page === 'admin.html' ? 'Administraci√≥n' : 'Inventario'));
          return;
        }
        window.location.href = page;
      }
      
      window.addEventListener('DOMContentLoaded', () => {
          // Configurar event listeners de variantes
          setupVariantsListeners();
        
        // Cargar productos desde localStorage o script.js
        if (typeof loadProductsFromStorage !== 'undefined') {
          productsData = loadProductsFromStorage();
        } else if (typeof products !== 'undefined') {
          productsData = [...products];
        } else {
          console.error('No se pudieron cargar los productos');
        }
        initializeAdmin();
      });

      function initializeAdmin() {
        renderProductsTable();
        setupEventListeners();
      }
      
      function renderProductsTable(filteredProducts = productsData) {
        const tbody = document.getElementById('products-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        // Paginaci√≥n
        const totalPages = Math.max(1, Math.ceil(filteredProducts.length / ADMIN_PRODUCTS_PER_PAGE));
        if (adminCurrentPage > totalPages) adminCurrentPage = totalPages;
        const start = (adminCurrentPage - 1) * ADMIN_PRODUCTS_PER_PAGE;
        const visible = filteredProducts.slice(start, start + ADMIN_PRODUCTS_PER_PAGE);
        renderAdminPagination(totalPages);

        if (visible.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#999">No hay productos para mostrar</td></tr>';
          return;
        }

        visible.forEach(product => {
          const hasVariants = product.variants && product.variants.options && product.variants.options.length > 0;
          const variantsDisplay = hasVariants 
            ? `<span style="display:inline-flex;align-items:center;gap:4px;color:#2196f3;font-weight:600">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0">
                   <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                 </svg>
                 ${product.variants.options.length} opciones
               </span>`
            : '<span style="color:#999">‚Äî</span>';
          
          // Calcular inventario total considerando variantes
          let inventory = {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          let totalInventory = 0;
          
          if (hasVariants) {
            // Si tiene variantes, sumar el inventario de todas las opciones
            product.variants.options.forEach(option => {
              const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
              inventory.tienda1 += (optInv.tienda1 || 0);
              inventory.tienda2 += (optInv.tienda2 || 0);
              inventory.tienda3 += (optInv.tienda3 || 0);
              inventory.bodega += (optInv.bodega || 0);
            });
            totalInventory = inventory.tienda1 + inventory.tienda2 + inventory.tienda3 + inventory.bodega;
          } else {
            // Sin variantes, usar inventario directo
            inventory = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            totalInventory = (inventory.tienda1 || 0) + (inventory.tienda2 || 0) + (inventory.tienda3 || 0) + (inventory.bodega || 0);
          }
          
          // Verificar si est√° agotado bas√°ndose en el stock total
          const isOutOfStock = totalInventory === 0;
          
          // Estado activo
          const isActive = product.active !== false;
          const activeBtn = isActive 
            ? '<button class="btn-toggle-active" data-id="' + product.id + '" style="padding:6px 12px;background:#4caf50;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.85rem">Activo</button>'
            : '<button class="btn-toggle-active" data-id="' + product.id + '" style="padding:6px 12px;background:#9e9e9e;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.85rem">Inactivo</button>';
          
          const inventoryDisplay = `<div style="font-size:0.85rem">
            <div><strong>Total:</strong> ${totalInventory}</div>
            <div style="color:#666;font-size:0.8rem">Sophie Store:${inventory.tienda1} | Sophie Mall:${inventory.tienda2} | Sophie's Ticados:${inventory.tienda3} | Bodega:${inventory.bodega}</div>
          </div>`;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><img src="${product.img}" alt="${product.title}" class="product-img-small" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'60\\' height=\\'60\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'60\\' height=\\'60\\'/%3E%3C/svg%3E'"></td>
            <td><strong>${product.title}</strong></td>
            <td>${product.category}</td>
            <td>‚Ç°${product.price.toLocaleString()}</td>
            <td>${variantsDisplay}</td>
            <td>${product.sold || 0}</td>
            <td>${isOutOfStock ? '<span style="color:#f44336">‚ùå Agotado</span>' : '<span style="color:#4caf50">‚úÖ Disponible</span>'}</td>
            <td>${activeBtn}</td>
            <td>${inventoryDisplay}</td>
            <td class="actions">
              <button class="btn-edit" data-id="${product.id}">Editar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        // Agregar event listeners a los botones
        tbody.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            console.log('Editar click', btn.dataset.id);
            editProduct(parseInt(btn.dataset.id));
          });
        });
        
        
        tbody.querySelectorAll('.btn-toggle-active').forEach(btn => {
          btn.addEventListener('click', () => toggleProductActive(parseInt(btn.dataset.id)));
        });
      }

      function openAddProductModal() {
        const modal = document.getElementById('product-modal');
        document.getElementById('modal-title').textContent = 'Agregar Producto';
        document.getElementById('product-id').value = '';
        document.getElementById('product-form').reset();
        
        // Limpiar im√°genes previas
        loadedImages = [];
        document.getElementById('images-preview').innerHTML = '';
        document.getElementById('product-images').value = '';
        
        // Mostrar modal
        modal.setAttribute('aria-hidden', 'false');
      }

      function setupEventListeners() {
        // Filtros y b√∫squeda
        const searchInput = document.getElementById('search-input');
        const filterCategory = document.getElementById('filter-category');
        const hasVariantsCheckbox = document.getElementById('has-variants');
        const addVariantBtn = document.getElementById('add-variant-option');
        const variantsSection = document.getElementById('variants-section');
        const variantType = document.getElementById('variant-type');
        const resetSoldBtn = document.getElementById('btn-reset-sold');
        const productImagesInput = document.getElementById('product-images');
        
        if (searchInput) searchInput.addEventListener('input', filterProducts);
        if (filterCategory) filterCategory.addEventListener('change', filterProducts);

        // Modal
        const modal = document.getElementById('product-modal');
        const btnCancel = document.getElementById('btn-cancel');
        const form = document.getElementById('product-form');


        if (btnCancel) {
          btnCancel.addEventListener('click', () => {
            modal.setAttribute('aria-hidden', 'true');
          });
        }

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.setAttribute('aria-hidden', 'true');
            }
          });
        }

        // Form submit
        if (form) {
          form.addEventListener('submit', handleFormSubmit);
        }

        // Manejo de m√∫ltiples im√°genes
        if (productImagesInput) {
          productImagesInput.addEventListener('change', handleImageUpload);
        }

        if (resetSoldBtn) {
          resetSoldBtn.addEventListener('click', () => {
            if(!confirm('¬øReiniciar el contador de vendidos a 0 para todos los productos?')) return;
            productsData = productsData.map(p => ({...p, sold: 0}));
            renderProductsTable();
            if (typeof saveProductsToStorage !== 'undefined') {
              saveProductsToStorage(productsData);
            }
            alert('Contador de vendidos reiniciado.');
          });
        }

        // Sincronizaci√≥n autom√°tica del inventario al cargar (sin bot√≥n)
        // Esto mantiene sincronizado el inventario desde defaultProducts
        if (typeof syncInventoryFromDefaults !== 'undefined') {
          syncInventoryFromDefaults();
        }

        // Variantes
        const toggleVariantsSection = (checked) => {
          if(!variantsSection) return;
          variantsSection.style.display = checked ? 'block' : 'none';
          if(!checked){
            currentVariants = [];
            if(variantType) variantType.value = '';
            renderVariantsList();
          }
        };

        if (hasVariantsCheckbox) {
          // Estado inicial
          toggleVariantsSection(hasVariantsCheckbox.checked);
          hasVariantsCheckbox.addEventListener('change', (e) => {
            toggleVariantsSection(e.target.checked);
          });
        }

        if (addVariantBtn) {
          addVariantBtn.addEventListener('click', addVariantOption);
        }
        


        // Hamburger menu
        const hamburger = document.getElementById('hamburger');
        const navDrawer = document.getElementById('nav-drawer');
        const navOverlay = document.getElementById('nav-overlay');
        const closeNav = document.getElementById('close-nav');

        if (hamburger) {
          hamburger.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'false');
            navOverlay.setAttribute('aria-hidden', 'false');
          });
        }

        if (closeNav) {
          closeNav.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        if (navOverlay) {
          navOverlay.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        // Cerrar sesi√≥n
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            if (confirm('¬øDeseas cerrar sesi√≥n?')) {
              sessionStorage.removeItem('adminLoggedIn');
              sessionStorage.removeItem('adminUsername');
              window.location.href = 'login.html';
            }
          });
        }
      }

      function filterProducts() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const categoryFilter = document.getElementById('filter-category').value;

        const filtered = productsData.filter(product => {
          let matchesSearch = product.title.toLowerCase().includes(searchTerm);
          if (!matchesSearch && product.supplier_code) {
            matchesSearch = product.supplier_code.toLowerCase().includes(searchTerm);
          }
          if (!matchesSearch && product.variants && product.variants.options) {
            matchesSearch = product.variants.options.some(option =>
              (option.supplier_code && option.supplier_code.toLowerCase().includes(searchTerm))
            );
          }
          const matchesCategory = !categoryFilter || product.category === categoryFilter;
          return matchesSearch && matchesCategory;
        });

        renderProductsTable(filtered);
      }

      // Variable global para almacenar las im√°genes cargadas
      let loadedImages = [];

      function handleImageUpload(e) {
        const files = Array.from(e.target.files);
        
        // Validar cantidad m√°xima de im√°genes (5) incluyendo las ya cargadas
        const totalImages = loadedImages.length + files.length;
        if (totalImages > 5) {
          alert(`M√°ximo 5 im√°genes permitidas. Ya tienes ${loadedImages.length} imagen(es) cargada(s). Solo puedes agregar ${5 - loadedImages.length} m√°s.`);
          e.target.value = '';
          return;
        }

        // Validar tama√±o de cada imagen (5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB
        for (let file of files) {
          if (file.size > maxSize) {
            alert(`La imagen "${file.name}" es demasiado grande. M√°ximo 5MB por imagen.`);
            e.target.value = '';
            return;
          }
        }

        const previewContainer = document.getElementById('images-preview');

        files.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const base64 = event.target.result;
            const newIndex = loadedImages.length;
            loadedImages.push(base64);

            // Crear elemento de previsualizaci√≥n
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.setAttribute('data-img-index', newIndex);
            imageItem.innerHTML = `
              <img src="${base64}" alt="Preview ${newIndex + 1}">
              <button type="button" class="remove-btn" data-index="${newIndex}">‚úï</button>
            `;

            previewContainer.appendChild(imageItem);

            // Event listener para eliminar imagen
            const removeBtn = imageItem.querySelector('.remove-btn');
            removeBtn.addEventListener('click', (e) => {
              e.preventDefault();
              const removeIndex = parseInt(e.target.getAttribute('data-index'));
              
              // Remover la imagen del array
              loadedImages.splice(removeIndex, 1);
              
              // Remover el elemento visual
              imageItem.remove();
              
              // Reindexar los botones restantes
              const remainingItems = previewContainer.querySelectorAll('.image-item');
              remainingItems.forEach((item, idx) => {
                item.setAttribute('data-img-index', idx);
                const btn = item.querySelector('.remove-btn');
                if (btn) btn.setAttribute('data-index', idx);
              });
              
              // Resetear input si no hay im√°genes
              if (loadedImages.length === 0) {
                document.getElementById('product-images').value = '';
              }
            });
          };
          reader.readAsDataURL(file);
        });
        
        // Limpiar el input despu√©s de procesar para permitir seleccionar m√°s archivos
        e.target.value = '';
      }

      function editProduct(id) {
        console.log('editProduct called with id:', id);
        const product = productsData.find(p => p.id === id);
        if (!product) return;

        const modal = document.getElementById('product-modal');
        document.getElementById('modal-title').textContent = 'Editar Producto';
        document.getElementById('product-id').value = product.id;
        document.getElementById('product-title').value = product.title;
        document.getElementById('product-category').value = product.category;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-desc').value = product.desc;
        document.getElementById('product-gender').value = product.gender || 'unisex';
        document.getElementById('product-out-of-stock').checked = product.outOfStock || false;
        document.getElementById('product-active').checked = product.active !== false;

        // Cargar im√°genes existentes
        loadedImages = [];
        const previewContainer = document.getElementById('images-preview');
        previewContainer.innerHTML = '';

        if (product.images && Array.isArray(product.images)) {
          product.images.forEach((imgData, index) => {
            // Si es una URL de Base64, cargarla directamente
            if (imgData.startsWith('data:')) {
              loadedImages.push(imgData);
              const imageItem = document.createElement('div');
              imageItem.className = 'image-item';
              imageItem.setAttribute('data-img-index', index);
              imageItem.innerHTML = `
                <img src="${imgData}" alt="Preview ${index + 1}">
                <button type="button" class="remove-btn" data-index="${index}">‚úï</button>
              `;
              previewContainer.appendChild(imageItem);

              const removeBtn = imageItem.querySelector('.remove-btn');
              removeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const removeIndex = parseInt(e.target.getAttribute('data-index'));
                
                // Remover la imagen del array
                loadedImages.splice(removeIndex, 1);
                
                // Remover el elemento visual
                imageItem.remove();
                
                // Reindexar los botones restantes
                const remainingItems = previewContainer.querySelectorAll('.image-item');
                remainingItems.forEach((item, idx) => {
                  item.setAttribute('data-img-index', idx);
                  const btn = item.querySelector('.remove-btn');
                  if (btn) btn.setAttribute('data-index', idx);
                });
              });
            }
          });
        } else if (product.img) {
          // Compatibilidad con productos antiguos que solo tienen img
          loadedImages = [product.img];
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          imageItem.setAttribute('data-img-index', 0);
          imageItem.innerHTML = `
            <img src="${product.img}" alt="Preview 1" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22%3E%3C/svg%3E'; this.style.display='none';">
            <button type="button" class="remove-btn" data-index="0">‚úï</button>
          `;
          previewContainer.appendChild(imageItem);

          const removeBtn = imageItem.querySelector('.remove-btn');
          removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadedImages = [];
            imageItem.remove();
          });
        }

        // Limpiar input de archivos
        document.getElementById('product-images').value = '';

        // Inventario solo se maneja desde la p√°gina de Inventarios
        // Cargar variantes si existen
        if (product.variants) {
          document.getElementById('has-variants').checked = true;
          document.getElementById('variants-section').style.display = 'block';
          document.getElementById('variant-type').value = product.variants.type || '';
          currentVariants = [...(product.variants.options || [])];
          renderVariantsList();
        } else {
          document.getElementById('has-variants').checked = false;
          document.getElementById('variants-section').style.display = 'none';
          currentVariants = [];
          renderVariantsList();
        }

        modal.setAttribute('aria-hidden', 'false');
        console.log('Modal aria-hidden set to false:', modal.getAttribute('aria-hidden'));
      }


      function handleFormSubmit(e) {
        e.preventDefault();
        
        const id = document.getElementById('product-id').value;
        const hasVariants = document.getElementById('has-variants').checked;
        
        // Validar que haya im√°genes cargadas
        if (loadedImages.length === 0) {
          alert('Por favor carga al menos una imagen');
          return;
        }
        
        const productData = {
          id: id ? parseInt(id) : (Math.max(0, ...productsData.map(p => p.id)) + 1),
          title: document.getElementById('product-title').value,
          category: document.getElementById('product-category').value,
          price: parseFloat(document.getElementById('product-price').value),
          desc: document.getElementById('product-desc').value,
          img: loadedImages[0], // Primera imagen como principal
          images: [...loadedImages], // Todas las im√°genes
          gender: document.getElementById('product-gender').value,
          outOfStock: document.getElementById('product-out-of-stock').checked,
          active: document.getElementById('product-active').checked,
          sold: 0
        };
        
        // Preservar el inventario existente (no se modifica desde admin)
        if (id) {
          const existingProduct = productsData.find(p => p.id === parseInt(id));
          if (existingProduct && existingProduct.inventory) {
            productData.inventory = existingProduct.inventory;
          }
          if (existingProduct && existingProduct.supplier_code) {
            productData.supplier_code = existingProduct.supplier_code;
          }
        }

        // Agregar variantes si est√°n habilitadas, de lo contrario removerlas
        if (hasVariants) {
          const variantType = document.getElementById('variant-type').value;
          if (currentVariants.length === 0) {
            alert('Agrega al menos una opci√≥n de variante o desactiva el checkbox.');
            return;
          }
          if (!variantType) {
            alert('Por favor selecciona un tipo de variante');
            return;
          }
          productData.variants = {
            type: variantType,
            options: currentVariants
          };
        } else {
          // Sin variantes
          delete productData.variants;
        }

        if (id) {
          // Actualizar producto existente
          const index = productsData.findIndex(p => p.id === parseInt(id));
          if (index !== -1) {
            const existing = { ...productsData[index], ...productData };
            if (!hasVariants) delete existing.variants;
            productsData[index] = existing;
            alert('Producto actualizado correctamente');
          }
        } else {
          // Agregar nuevo producto
          productsData.push(productData);
          alert('Producto agregado correctamente');
        }

        // Guardar en localStorage
        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        }

        // Limpiar variantes y im√°genes
        currentVariants = [];
        loadedImages = [];
        renderVariantsList();

        document.getElementById('product-modal').setAttribute('aria-hidden', 'true');
        renderProductsTable();
      }
      
      function toggleProductActive(id) {
        const product = productsData.find(p => p.id === id);
        if (!product) return;
        
        product.active = !product.active;
        
        // Guardar en localStorage
        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        }
        
        renderProductsTable();
      }
      

    </script>
  </body>
</html>
