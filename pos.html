<!doctype html>
<html lang="es">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Punto de Ventas - Sophie</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <script src="script.js"></script>
    <style>
      .admin-tabs {
        max-width: 1400px;
        margin: 20px auto 0;
        padding: 0 20px;
        display: flex;
        gap: 4px;
        border-bottom: 2px solid #e3cfe0;
      }
      .admin-tab {
        padding: 14px 28px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #666;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: Montserrat, sans-serif;
        text-decoration: none;
        display: inline-block;
      }
      .admin-tab:hover {
        color: #5a2032;
        background: rgba(243, 229, 245, 0.3);
      }
      .admin-tab.active {
        color: #d946a6;
        border-bottom-color: #d946a6;
        background: rgba(243, 229, 245, 0.5);
      }
      .pos-container {
        max-width: 1400px;
        margin: 20px auto 40px;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
      }
      .pos-header {
        grid-column: 1 / -1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--accent);
      }
      .pos-header h1 {
        font-family: Playfair Display, serif;
        color: #5a2032;
        margin: 0;
      }
      .store-selector {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .store-selector label {
        font-weight: 600;
        color: #5a2032;
      }
      .store-selector select {
        padding: 10px 16px;
        border: 2px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
        font-weight: 600;
        color: #5a2032;
        font-size: 1rem;
        cursor: pointer;
      }
      .products-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(82, 44, 60, 0.1);
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }
      .search-box {
        margin-bottom: 20px;
      }
      .search-box input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e3cfe0;
        border-radius: 8px;
        font-family: Montserrat, sans-serif;
        font-size: 1rem;
      }
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
      }
      .product-card {
        background: #fff;
        border: 2px solid #f0f0f0;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }
      .product-card:hover {
        border-color: #d946a6;
        box-shadow: 0 4px 12px rgba(217, 70, 166, 0.2);
        transform: translateY(-2px);
      }
      .product-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .product-card h4 {
        margin: 0 0 6px 0;
        font-size: 0.9rem;
        color: #5a2032;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        line-height: 1.2;
        min-height: 3.6em;
      }
      .product-card .price {
        font-weight: 700;
        color: #d946a6;
        font-size: 1rem;
      }
      .product-card .stock {
        font-size: 0.8rem;
        color: #666;
        margin-top: 4px;
      }
      .cart-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(82, 44, 60, 0.1);
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 200px);
      }
      .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f0f0f0;
      }
      .cart-header h2 {
        margin: 0;
        color: #5a2032;
        font-size: 1.4rem;
      }
      .cart-items {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 20px;
      }
      .cart-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .cart-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
      }
      .cart-item-details {
        flex: 1;
      }
      .cart-item-details h4 {
        margin: 0 0 4px 0;
        font-size: 0.95rem;
        color: #5a2032;
      }
      .cart-item-price {
        color: #d946a6;
        font-weight: 700;
      }
      .cart-item-qty {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 8px;
      }
      .cart-item-qty button {
        width: 28px;
        height: 28px;
        border: none;
        background: #d946a6;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
      }
      .cart-item-qty button:hover {
        background: #b93889;
      }
      .cart-item-qty span {
        min-width: 30px;
        text-align: center;
        font-weight: 700;
      }
      .cart-item-remove {
        background: #f44336;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .cart-totals {
        border-top: 2px solid #f0f0f0;
        padding-top: 16px;
        margin-bottom: 16px;
      }
      .cart-total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }
      .cart-total-row.grand {
        font-size: 1.4rem;
        font-weight: 700;
        color: #5a2032;
        padding-top: 10px;
        border-top: 2px solid #e3cfe0;
      }
      .cart-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .btn-checkout {
        padding: 16px;
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .btn-checkout:hover {
        box-shadow: 0 4px 14px rgba(76, 175, 80, 0.5);
        transform: translateY(-2px);
      }
      .btn-clear {
        padding: 12px;
        background: #9e9e9e;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-clear:hover {
        background: #757575;
      }
      .empty-cart {
        text-align: center;
        color: #999;
        padding: 40px 20px;
      }
      .empty-cart svg {
        width: 80px;
        height: 80px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      @media (max-width: 968px) {
        .pos-container {
          grid-template-columns: 1fr;
        }
      }
      /* POS grid fallback styles to ensure visible rendering */
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
      }
      .product-card img { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; background: #f7f0f6; }
      .product-card h4 { margin: 6px 0; color: #5a2032; font-size: 1rem; }
      .product-card .price { color: #5a2a57; font-weight: 700; }
      .product-card .stock { color: #6b2840; font-size: 0.9rem; }
    </style>
  </head>
  <style>
    @media print {
      .site-header, .admin-tabs, .nav-overlay, .nav-drawer, .cart-section, .products-section, .pos-header {
        display: none !important;
      }
      body {
        background: white !important;
      }
    }
  </style>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <button id="hamburger" class="hamburger" aria-label="Abrir men√∫">‚ò∞</button>
        <a href="index.html" class="logo" style="text-decoration:none;cursor:pointer;display:flex;align-items:center;gap:10px">
          <span style="font-family:'Daily',Playfair Display,serif;font-size:2.5rem;font-weight:400;color:#2c4a8c">SophieWeb - POS</span>
        </a>
        <a href="index.html" class="btn">‚Üê Volver a la tienda</a>
        <button id="logout-btn" class="btn" style="color:#f44336;font-weight:700">Cerrar Sesi√≥n</button>
      </div>
    </header>

    <div id="nav-overlay" class="nav-overlay" aria-hidden="true"></div>
    <aside id="nav-drawer" class="nav-drawer" aria-hidden="true">
      <div class="nav-drawer-inner">
        <button id="close-nav" class="close">‚úï</button>
        <nav class="nav-drawer-list">
          <a class="btn" href="index.html">Inicio</a>
          <a class="btn" href="admin.html">Administraci√≥n</a>
          <a class="btn active" href="pos.html">Punto de Ventas</a>
          <a class="btn" href="inventory.html">Inventario</a>
        </nav>
      </div>
    </aside>

    <!-- Tabs de navegaci√≥n -->
    <div class="admin-tabs">
      <a href="pos.html" class="admin-tab active">üí≥ Punto de Ventas</a>
      <a href="#" onclick="openApartadosTab(); return false;" class="admin-tab">üìã Apartados</a>
      <a href="#" onclick="openPedidosOnlineTab(); return false;" class="admin-tab">üì¶ Pedidos Online</a>
      <a id="tab-admin" href="#" onclick="checkAdminAccessAndNavigate('admin.html'); return false;" class="admin-tab" style="display:none;">üì¶ Administraci√≥n</a>
      <a id="tab-inventory" href="#" onclick="checkAdminAccessAndNavigate('inventory.html'); return false;" class="admin-tab" style="display:none;">üìä Inventario</a>
    </div>

    <main class="pos-container">
      <div class="pos-header">
        <h1>Punto de Ventas</h1>
        <div class="store-selector">
          <label for="current-store">Tienda:</label>
          <select id="current-store">
            <option value="tienda1">Sophie Store</option>
            <option value="tienda2">Sophie Mall</option>
            <option value="tienda3">Sophie's Ticados</option>
          </select>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn" onclick="openInvoiceHistoryModal()" style="background:#5a2032;color:white;padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:600">üìã Historial de Facturas</button>
          <button id="btn-daily-report" class="btn" onclick="openDailyReportModal()" style="background:#1976d2;color:white;padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:600">üìä Reporte del D√≠a</button>
        </div>
      </div>

      <!-- Secci√≥n de productos -->
      <div class="products-section">
        <div class="search-box">
          <input type="text" id="pos-search" placeholder="üîç Buscar producto o escanear c√≥digo de barras (Enter)...">
        </div>
        <div class="products-grid" id="pos-products-grid"></div>
        <div id="pos-products-pagination" class="pagination" style="margin-top:18px;display:flex;justify-content:center;gap:10px"></div>
      </div>

      <!-- Carrito de compra -->
      <div class="cart-section">
        <div class="cart-header">
          <h2>Carrito</h2>
          <button class="btn-clear" id="clear-pos-cart">Limpiar</button>
        </div>
        <div class="cart-items" id="pos-cart-items">
          <div class="empty-cart">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
            <p>El carrito est√° vac√≠o</p>
          </div>
        </div>
        <div class="cart-totals">
          <div class="cart-total-row">
            <span>Subtotal:</span>
            <span id="pos-subtotal">‚Ç°0.00</span>
          </div>
          <div class="cart-total-row grand">
            <span>Total:</span>
            <span id="pos-total">‚Ç°0.00</span>
          </div>
        </div>
        <div class="cart-actions">
          <button class="btn-checkout" id="complete-sale">Completar Venta</button>
          <button class="btn-checkout" style="background:#ff9800" id="create-apartado">üì¶ Apartado</button>
        </div>
      </div>
    </main>

    <!-- Modal de M√©todos de Pago -->
    <div id="payment-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;flex-direction:column">
      <div style="background:white;border-radius:12px;padding:30px;width:90%;max-width:500px;max-height:60vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);position:relative">
        <button type="button" onclick="closePaymentModal()" aria-label="Cerrar" style="position:absolute;top:10px;right:10px;background:transparent;border:none;font-size:1.4rem;cursor:pointer;color:#666;line-height:1">√ó</button>
        <h2 style="color:#5a2032;margin-bottom:20px;text-align:center" id="payment-title">M√©todos de Pago</h2>
        
        <!-- Informaci√≥n del apartado si aplica -->
        <div id="apartado-payment-info" style="display:none;margin-bottom:20px;padding:15px;background:#fff3e0;border-left:4px solid #ff9800;border-radius:8px">
          <div style="font-weight:600;color:#ff9800;margin-bottom:8px">üìã COMPLETAR APARTADO</div>
          <div style="font-size:0.9rem;color:#333;margin-bottom:5px"><strong>Cliente:</strong> <span id="apartado-client-name"></span></div>
          <div style="font-size:0.9rem;color:#333;margin-bottom:8px"><strong>Total Apartado:</strong> ‚Ç°<span id="apartado-total-amount"></span></div>
          <div style="font-size:0.9rem;color:#4caf50;margin-bottom:5px"><strong>Se√±a Recibida:</strong> ‚Ç°<span id="apartado-se√±a-amount"></span> <span id="apartado-payment-method-display" style="font-size:0.85rem;color:#666"></span></div>
          <div style="font-size:0.9rem;color:#ff9800;font-weight:600;padding-top:8px;border-top:1px solid #ffb74d;margin-top:8px"><strong>Saldo a Pagar:</strong> ‚Ç°<span id="apartado-saldo-amount"></span></div>
        </div>
        
        <div style="margin-bottom:20px">
          <label style="display:block;color:#5a2032;font-weight:600;margin-bottom:8px">Cajero:</label>
          <select id="cashier-select" style="width:100%;padding:10px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:0.95rem">
            <option value="">Seleccione un cajero</option>
            <optgroup label="Vendedores">
              <option value="Tamica">Tamica</option>
              <option value="Valerie">Valerie</option>
              <option value="Jesenia">Jesenia</option>
            </optgroup>
            <optgroup label="‚îÅ‚îÅ‚îÅ ENCARGADOS ‚îÅ‚îÅ‚îÅ">
              <option value="Darlyn" style="color:#2196f3;font-weight:600">üëë Darlyn (Encargado)</option>
              <option value="Rebeca" style="color:#2196f3;font-weight:600">üëë Rebeca (Encargado)</option>
              <option value="Elizabeth" style="color:#2196f3;font-weight:600">üëë Elizabeth (Encargado)</option>
            </optgroup>
            <optgroup label="‚îÅ‚îÅ‚îÅ ADMINISTRADORES ‚îÅ‚îÅ‚îÅ">
              <option value="Moni (Admin)" style="color:red;font-weight:bold">üî¥ Moni (Admin)</option>
              <option value="Hernan (Admin)" style="color:red;font-weight:bold">üî¥ Hernan (Admin)</option>
              <option value="David (Admin)" style="color:red;font-weight:bold">üî¥ David (Admin)</option>
              <option value="Esteban (Admin)" style="color:red;font-weight:bold">üî¥ Esteban (Admin)</option>
            </optgroup>
          </select>
        </div>
        
        <div style="margin-bottom:20px">
          <label style="display:block;color:#5a2032;font-weight:600;margin-bottom:8px">Tipo de Factura:</label>
          <select id="tax-type-select" onchange="updateTaxDisplay()" style="width:100%;padding:10px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:0.95rem">
            <option value="simple">üìÑ Simple (Sin desglose de IVA)</option>
            <option value="coniva">üìã Con IVA (Muestra desglose)</option>
            <option value="exonerado">üèõÔ∏è Exonerado (Diplom√°ticos - Sin IVA)</option>
          </select>
          <div id="tax-description" style="margin-top:8px;padding:8px;background:#e3f2fd;border-radius:4px;font-size:0.85rem;color:#1565c0"></div>
        </div>
        
        <div style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px;text-align:center" id="total-breakdown-section">
          <div id="tax-breakdown-display"></div>
        </div>

        <div id="payment-methods-list" style="margin-bottom:20px"></div>

        <div style="margin-bottom:20px;padding:15px;background:#e8f5e9;border-radius:8px">
          <div style="font-size:0.95rem;color:#2e7d32;margin-bottom:10px">Desglose de pago:</div>
          <div id="payment-breakdown" style="font-size:0.9rem;color:#333"></div>
        </div>

        <div id="change-info" style="display:none;margin-bottom:20px;padding:15px;background:#fff3e0;border-radius:8px">
          <div style="font-size:0.95rem;color:#e65100;margin-bottom:5px">Monto a pagar:</div>
          <div style="font-size:1.5rem;font-weight:700;color:#e65100" id="change-amount">‚Ç°0.00</div>
          <div style="font-size:0.9rem;color:#f57c00;margin-top:5px">Vuelto: <strong id="change-value">‚Ç°0.00</strong></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:20px">
          <button style="flex:1;padding:12px;background:#9e9e9e;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem" onclick="closePaymentModal()">Cancelar</button>
          <button style="flex:1;padding:12px;background:#4caf50;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem" onclick="confirmPayment()">Confirmar Venta</button>
        </div>
      </div>
    </div>

    <script>
      // Verificar autenticaci√≥n
      if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }

      // Mostrar/ocultar tabs seg√∫n tipo de usuario
      const userType = sessionStorage.getItem('userType');
      if (userType === 'encargado' || userType === 'admin') {
        // Mostrar tabs de administraci√≥n para encargados y admins
        document.getElementById('tab-admin').style.display = '';
        document.getElementById('tab-inventory').style.display = '';
      } else if (userType === 'vendedor') {
        // Ocultar bot√≥n de Reporte del D√≠a para vendedores
        document.getElementById('btn-daily-report').style.display = 'none';
      }
      // Los vendedores solo ven POS y Apartados (que est√°n siempre visibles)

      let posCart = [];
      let productsData = [];
      let currentApartadoInProgress = null; // Almacena el apartado que se est√° completando
      let currentStore = 'tienda1';
      let posPaymentMethods = [];
      let currentTaxType = 'simple'; // simple, coniva, exonerado

      function adaptProductForPOS(apiProduct) {
        return {
          id: apiProduct.id,
          title: apiProduct.titulo,
          price: Number(apiProduct.precio_base),
          img: apiProduct.url_imagen || '',
          barcode: apiProduct.codigo_externo,
          inventory: {},

          variants: {
            options: (apiProduct.variants || []).map(v => ({
              name: v.name,
              barcode: v.barcode,
              supplier_code: '',
              inventory: v.inventory || {},
              variant_id: v.variant_id   // üî• ESTO ES CLAVE
            }))
          }
        };
      }

      
      // Funci√≥n para redondear a la denominaci√≥n m√°s cercana (m√∫ltiplos de 5 colones)
      function roundToCostaRicaCoins(amount) {
        // Costa Rica usa monedas de 10, 25, 50, 100 colones (todos m√∫ltiplos de 5)
        // Redondeamos al m√∫ltiplo de 5 m√°s cercano
        return Math.round(amount / 5) * 5;
      }
      
      // Funci√≥n para calcular IVA (Costa Rica usa 13%)
      function calculateIVA(subtotal, taxType) {
        const IVA_RATE = 0.13;
        
        if (taxType === 'simple') {
          // Factura simple: mantener precio original
          return {
            subtotal: subtotal,
            iva: 0,
            total: subtotal,
            baseImponible: 0,
            originalTotal: subtotal,
            roundingAdjustment: 0
          };
        } else if (taxType === 'coniva') {
          // Con IVA: el precio ya incluye IVA, mostrar desglose
          // Precio = Base + IVA
          // Precio = Base * 1.13
          // Base = Precio / 1.13
          const baseImponible = subtotal / 1.13;
          const iva = baseImponible * IVA_RATE;
          return {
            subtotal: subtotal,
            iva: iva,
            total: subtotal,
            baseImponible: baseImponible,
            originalTotal: subtotal,
            roundingAdjustment: 0
          };
        } else if (taxType === 'exonerado') {
          // Exonerado: remover el IVA del precio y redondear a denominaciones v√°lidas
          const baseImponible = subtotal / 1.13;
          const roundedTotal = roundToCostaRicaCoins(baseImponible);
          const roundingAdjustment = roundedTotal - baseImponible;
          
          return {
            subtotal: baseImponible,
            iva: 0,
            total: roundedTotal,
            baseImponible: baseImponible,
            originalTotal: baseImponible,
            roundingAdjustment: roundingAdjustment
          };
        }
        
        return {
          subtotal: subtotal,
          iva: 0,
          total: subtotal,
          baseImponible: 0,
          originalTotal: subtotal,
          roundingAdjustment: 0
        };
      }

      // Esperar a que script.js cargue y luego inicializar POS
      function initPOS() {
        console.log('=== INICIANDO POS ===');
        
        // Corregir fechas UTC a fechas locales en facturas existentes
        fixUTCDatesInInvoices();
        
        // Sincronizar apartados: eliminar del historial los que ya no existen
        syncApartadosWithHistory();
        
        // Cargar productos: localStorage -> global products -> defaults
        if (typeof loadProductsFromStorage === 'function') {
          productsData = loadProductsFromStorage();
          console.log('‚úÖ Productos cargados desde localStorage:', productsData.length);
        } else if (typeof products !== 'undefined' && Array.isArray(products)) {
          productsData = [...products];
          console.log('‚úÖ Productos cargados desde variable global:', productsData.length);
        } else if (typeof defaultProducts !== 'undefined' && Array.isArray(defaultProducts)) {
          productsData = [...defaultProducts];
          console.log('‚úÖ Productos cargados desde defaults:', productsData.length);
        } else {
          console.error('‚ùå No se pudo cargar ninguna fuente de productos');
          productsData = [];
        }
        
        // Obtener tienda inicial
        const storeEl = document.getElementById('current-store');
        if (storeEl) {
          currentStore = storeEl.value;
        }
        
        // Renderizar
        renderPOSProducts();
        renderPOSCart();
        setupPOSListeners();
      }

      // Iniciar cuando el DOM est√° listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTimeout(initPOS, 300));
      } else {
        setTimeout(initPOS, 300);
      }


      async function ensureProductsLoaded() {
        const res = await fetch("http://localhost:3000/products");
        const data = await res.json();
        productsData = data.map(adaptProductForPOS);
        console.log("Productos adaptados POS:", productsData);
      }


      // Recargar datos y re-renderizar (usado por eventos de storage)
      function refreshPOSData() {
        const prevLen = Array.isArray(productsData) ? productsData.length : 0;
        if (typeof loadProductsFromStorage === 'function') {
          productsData = loadProductsFromStorage();
        } else if (typeof products !== 'undefined' && Array.isArray(products)) {
          productsData = [...products];
        } else if (typeof defaultProducts !== 'undefined' && Array.isArray(defaultProducts)) {
          productsData = [...defaultProducts];
        } else {
          productsData = [];
        }
        console.log('üîÑ POS datos actualizados:', prevLen, '‚Üí', productsData.length);
        renderPOSProducts();
        renderPOSCart();
      }

      function setupPOSListeners() {
        const storeSelector = document.getElementById('current-store');
        const searchInput = document.getElementById('pos-search');
        const clearBtn = document.getElementById('clear-pos-cart');
        const completeBtn = document.getElementById('complete-sale');

        if (storeSelector) {
          storeSelector.addEventListener('change', (e) => {
            currentStore = e.target.value;
            renderPOSProducts();
          });
        }

        if (searchInput) {
          searchInput.addEventListener('input', renderPOSProducts);
          
          // Detectar Enter para buscar y agregar producto por c√≥digo de barras
          searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              const searchTerm = searchInput.value.trim();
              
              if (searchTerm) {
                // Buscar producto por c√≥digo de barras exacto o c√≥digo de proveedor
                let foundProduct = null;
                let foundVariant = null;
                
                for (let product of productsData) {
                  // Buscar en c√≥digo de barras principal
                  if (product.barcode && product.barcode.toLowerCase() === searchTerm.toLowerCase()) {
                    foundProduct = product;
                    break;
                  }
                  
                  // Buscar en c√≥digo de proveedor
                  if (product.supplier_code && product.supplier_code.toLowerCase() === searchTerm.toLowerCase()) {
                    foundProduct = product;
                    break;
                  }
                  
                  // Buscar en c√≥digos de barras o proveedor de variantes
                  if (product.variants && product.variants.options) {
                    for (let option of product.variants.options) {
                      if ((option.barcode && option.barcode.toLowerCase() === searchTerm.toLowerCase()) ||
                          (option.supplier_code && option.supplier_code.toLowerCase() === searchTerm.toLowerCase())) {
                        foundProduct = product;
                        foundVariant = option;
                        break;
                      }
                    }
                    if (foundVariant) break;
                  }
                }
                
                if (foundProduct) {
                  // Verificar stock en la tienda actual
                  let stockAvailable = 0;
                  let priceToUse = foundProduct.price;
                  let titleToUse = foundProduct.title;
                  let barcodeToUse = foundProduct.barcode || ('SOPHIE' + String(foundProduct.id).padStart(6, '0'));
                  
                  if (foundVariant) {
                    // Producto con variante espec√≠fica
                    const inv = foundVariant.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
                    stockAvailable = inv[currentStore] || 0;
                    priceToUse = foundVariant.price || foundProduct.price;
                    titleToUse = foundProduct.title + ' - ' + foundVariant.name;
                    barcodeToUse = foundVariant.barcode;
                    
                    if (stockAvailable > 0) {
                      // Agregar variante espec√≠fica al carrito
                      const variantId = foundProduct.id + '-' + foundVariant.name;
                      const existingItem = posCart.find(item => item.variantId === variantId);
                      
                      if (existingItem) {
                        if (existingItem.qty < stockAvailable) {
                          existingItem.qty++;
                        } else {
                          alert('‚ùå No hay m√°s stock de esta variante en ' + currentStore);
                        }
                      } else {
                        posCart.push({
                          id: foundProduct.id,
                          variantId: variantId,
                          variantName: foundVariant.name,
                          title: titleToUse,
                          price: priceToUse,
                          img: foundProduct.img,
                          barcode: barcodeToUse,
                          qty: 1,
                          maxStock: stockAvailable
                        });
                      }
                      
                      renderPOSCart();
                      searchInput.value = '';
                      renderPOSProducts();
                      
                      searchInput.style.background = '#d4edda';
                      setTimeout(() => {
                        searchInput.style.background = '';
                      }, 300);
                    } else {
                      alert('‚ùå Producto sin stock en ' + currentStore);
                      searchInput.value = '';
                      renderPOSProducts();
                    }
                  } else {
                    // Producto simple sin variantes
                    const inv = foundProduct.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
                    stockAvailable = inv[currentStore] || 0;
                    
                    if (stockAvailable > 0) {
                      addToPOSCart(foundProduct);
                      searchInput.value = '';
                      renderPOSProducts();
                      
                      searchInput.style.background = '#d4edda';
                      setTimeout(() => {
                        searchInput.style.background = '';
                      }, 300);
                    } else {
                      alert('‚ùå Producto sin stock en ' + currentStore);
                      searchInput.value = '';
                      renderPOSProducts();
                    }
                  }
                } else {
                  alert('‚ùå C√≥digo de barras no encontrado');
                  searchInput.value = '';
                  renderPOSProducts();
                }
              }
            }
          });
        }


        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            if (confirm('¬øLimpiar el carrito?')) {
              posCart = [];
              renderPOSCart();
            }
          });
        }

        if (completeBtn) {
          completeBtn.addEventListener('click', completeSale);
        }

        const apartadoBtn = document.getElementById('create-apartado');
        if (apartadoBtn) {
          apartadoBtn.addEventListener('click', createApartado);
        }

        // Hamburger menu
        const hamburger = document.getElementById('hamburger');
        const navDrawer = document.getElementById('nav-drawer');
        const navOverlay = document.getElementById('nav-overlay');
        const closeNav = document.getElementById('close-nav');

        if (hamburger) {
          hamburger.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'false');
            navOverlay.setAttribute('aria-hidden', 'false');
          });
        }

        if (closeNav) {
          closeNav.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        if (navOverlay) {
          navOverlay.addEventListener('click', () => {
            navDrawer.setAttribute('aria-hidden', 'true');
            navOverlay.setAttribute('aria-hidden', 'true');
          });
        }

        // Cerrar sesi√≥n
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            if (confirm('¬øDeseas cerrar sesi√≥n?')) {
              sessionStorage.removeItem('adminLoggedIn');
              sessionStorage.removeItem('adminUsername');
              window.location.href = 'login.html';
            }
          });
        }

        // Escuchar cambios en localStorage desde otras pesta√±as/ventanas
        window.addEventListener('storage', (e) => {
          if (e && e.key === 'products_data') {
            console.log('üì¶ Cambio detectado en products_data; recargando POS');
            refreshPOSData();
          }
        });
      }

      // Nota: Se elimin√≥ el bot√≥n de restablecer datos; POS carga siempre desde los datos sincronizados.

      function checkAdminAccessAndNavigate(page) {
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
          alert('‚õî Acceso denegado.\nDebes estar autenticado como administrador para acceder a ' + (page === 'admin.html' ? 'Administraci√≥n' : 'Inventario'));
          return;
        }
        window.location.href = page;
      }

      // Paginaci√≥n POS
      let posCurrentPage = 1;
      const POS_PRODUCTS_PER_PAGE = 20;

      function renderPOSPagination(totalPages) {
        const container = document.getElementById('pos-products-pagination');
        if (!container) return;
        if (totalPages <= 1) {
          container.innerHTML = '';
          container.style.display = 'none';
          return;
        }
        container.style.display = 'flex';
        container.innerHTML = `
          <button class="page-btn prev" ${posCurrentPage===1 ? 'disabled aria-disabled="true"' : ''}>Anterior</button>
          <span class="page-info">P√°gina ${posCurrentPage} de ${totalPages}</span>
          <button class="page-btn next" ${posCurrentPage===totalPages ? 'disabled aria-disabled="true"' : ''}>Siguiente</button>
        `;
        const prev = container.querySelector('.page-btn.prev');
        const next = container.querySelector('.page-btn.next');
        if(prev) prev.addEventListener('click',()=>{ if(posCurrentPage>1){ posCurrentPage-=1; renderPOSProducts(); } });
        if(next) next.addEventListener('click',()=>{ if(posCurrentPage<totalPages){ posCurrentPage+=1; renderPOSProducts(); } });
      }

      function renderPOSProducts(page) {
        if (typeof page === 'number') posCurrentPage = page;
        ensureProductsLoaded();
        const grid = document.getElementById('pos-products-grid');
        const searchEl = document.getElementById('pos-search');
        const searchTerm = (searchEl && typeof searchEl.value === 'string') ? searchEl.value.toLowerCase() : '';
        
        console.log('=== RENDERIZAR PRODUCTOS POS ===');
        console.log('Grid encontrado:', !!grid);
        console.log('Total productos disponibles:', productsData.length);
        console.log('Tienda actual:', currentStore);
        console.log('T√©rmino de b√∫squeda:', searchTerm);
        
        if (!grid) {
          console.error('ERROR: No se encontr√≥ el elemento #pos-products-grid');
          return;
        }
        grid.innerHTML = '';
        const debugInfo = document.getElementById('pos-debug-info');

        let storeTotal = 0;
        let filtered = productsData.filter(p => {
          // Calcular stock total considerando variantes
          let totalStock = 0;
          if (p.variants && p.variants.options && p.variants.options.length > 0) {
            // Tiene variantes: sumar stock de todas las opciones
            p.variants.options.forEach(option => {
              const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
              totalStock += (optInv[currentStore] || 0);
            });
          } else {
            // Sin variantes: usar inventario directo
            const inventory = p.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            totalStock = (inventory[currentStore] || 0);
          }
          
          // Filtrar por stock: ocultar productos agotados en la tienda actual
          if (totalStock <= 0) {
            return false;
          }
          storeTotal += totalStock;
          
          // B√∫squeda por nombre o c√≥digo de barras o c√≥digo de proveedor
          if (searchTerm) {
            let matchesSearch = p.title.toLowerCase().includes(searchTerm);
            
            // Buscar en c√≥digo de barras principal
            if (!matchesSearch && p.barcode) {
              matchesSearch = p.barcode.toLowerCase().includes(searchTerm);
            }
            
            // Buscar en c√≥digo de proveedor
            if (!matchesSearch && p.supplier_code) {
              matchesSearch = p.supplier_code.toLowerCase().includes(searchTerm);
            }
            
            // Buscar en c√≥digos de barras o proveedor de variantes
            if (!matchesSearch && p.variants && p.variants.options) {
              matchesSearch = p.variants.options.some(option =>
                (option.barcode && option.barcode.toLowerCase().includes(searchTerm)) ||
                (option.supplier_code && option.supplier_code.toLowerCase().includes(searchTerm))
              );
            }
            
            if (!matchesSearch) {
              return false;
            }
          }
          
          return true;
        });
        const totalPages = Math.max(1, Math.ceil(filtered.length / POS_PRODUCTS_PER_PAGE));
        if (posCurrentPage > totalPages) posCurrentPage = totalPages;
        const start = (posCurrentPage - 1) * POS_PRODUCTS_PER_PAGE;
        const visible = filtered.slice(start, start + POS_PRODUCTS_PER_PAGE);
        renderPOSPagination(totalPages);
        
        console.log('Productos filtrados:', filtered.length);
        if (debugInfo) {
          debugInfo.textContent = `Tienda: ${currentStore} | Productos: ${productsData.length} | Filtrados: ${filtered.length} | Stock tienda: ${storeTotal}`;
        }
        
        if (filtered.length === 0) {
          console.warn('ADVERTENCIA: No hay productos para mostrar');
          console.log('Verificar:');
          console.log('- ¬øHay stock disponible en la tienda ' + currentStore + '?');
          grid.innerHTML = '<p style="text-align:center;color:#999;padding:40px">‚ùå No hay productos disponibles en ' + currentStore + '</p>';
          return;
        }

        visible.forEach(product => {
          // Calcular stock total considerando variantes
          let totalStock = 0;
          if (product.variants && product.variants.options && product.variants.options.length > 0) {
            product.variants.options.forEach(option => {
              const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
              totalStock += (optInv[currentStore] || 0);
            });
          } else {
            const inventory = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            totalStock = (inventory[currentStore] || 0);
          }
          
          const card = document.createElement('div');
          card.className = 'product-card';
          card.setAttribute('style', 'border:1px solid #e3cfe0;border-radius:8px;padding:10px;box-shadow:0 2px 8px rgba(82,44,60,0.08);display:flex;flex-direction:column;gap:8px;background:#fff;position:relative;');
          
          // Generar display de c√≥digo de barras
          let barcodeDisplay = '';
          let optionsHTML = '';
          if (product.variants && product.variants.options && product.variants.options.length > 0) {
            barcodeDisplay = '<select class="variant-selector" data-product-id="' + product.id + '" style="font-size:0.7rem;color:#666;font-family:monospace;padding:4px;background:#f7f0f6;border:1px solid #e0d0e0;border-radius:4px;width:100%;cursor:pointer">';
            barcodeDisplay += '<option value="">-- Selecciona una opci√≥n --</option>';
            product.variants.options.forEach((option, idx) => {
              const barcode = option.barcode || 'N/A';
              barcodeDisplay += '<option value="' + idx + '">' + option.name + ': ' + barcode + '</option>';
            });
            barcodeDisplay += '</select>';
          } else {
            const barcode = product.barcode || ('SOPHIE' + String(product.id).padStart(6, '0'));
            barcodeDisplay = '<div style="font-size:0.75rem;color:#999;font-family:monospace;text-align:center;padding:4px;background:#f7f0f6;border-radius:4px;word-break:break-all;">' + barcode + '</div>';
          }
          
          card.innerHTML = `
            <img src="${product.img}" alt="${product.title}" style="width:100%;height:160px;object-fit:cover;border-radius:6px;background:#f7f0f6">
            <h4 style="margin:0;color:#5a2032;font-family:'CenturyGothic',Playfair Display,serif">${product.title}</h4>
            <div class="price" style="color:#5a2a57;font-weight:700">‚Ç°${product.price.toLocaleString()}</div>
            <div class="stock" style="color:#6b2840;font-size:0.9rem">Stock: ${totalStock}</div>
            ${barcodeDisplay}
          `;
          
          // Si tiene variantes, agregar evento al select en lugar de al card
          if (product.variants && product.variants.options && product.variants.options.length > 0) {
            const selectElement = card.querySelector('.variant-selector');
            selectElement.addEventListener('change', (e) => {
              e.stopPropagation();
              if (e.target.value !== '') {
                const optionIndex = parseInt(e.target.value);
                addVariantToPOSCart(product, optionIndex);
                e.target.value = '';
              }
            });
            selectElement.addEventListener('click', (e) => e.stopPropagation());
          } else {
            card.addEventListener('click', () => addToPOSCart(product));
          }
          
          grid.appendChild(card);
        });
      }

      function addToPOSCart(product) {
        // Calcular stock disponible considerando variantes
        let availableStock = 0;
        if (product.variants && product.variants.options && product.variants.options.length > 0) {
          product.variants.options.forEach(option => {
            const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
            availableStock += (optInv[currentStore] || 0);
          });
        } else {
          const inventory = product.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
          availableStock = (inventory[currentStore] || 0);
        }
        
        const existingItem = posCart.find(item => item.id === product.id);
        const currentQty = existingItem ? existingItem.qty : 0;
        
        if (currentQty >= availableStock) {
          alert(`No hay m√°s stock disponible en ${currentStore}`);
          return;
        }
        
        if (existingItem) {
          existingItem.qty++;
        } else {
          var barcode = product.barcode || ('SOPHIE' + String(product.id).padStart(6, '0'));
          posCart.push({
            id: product.id,
            title: product.title,
            price: product.price,
            img: product.img,
            barcode: barcode,
            qty: 1,
            maxStock: availableStock
          });
        }
        
        renderPOSCart();
      }

      function renderPOSCart() {
        const container = document.getElementById('pos-cart-items');
        const subtotalNode = document.getElementById('pos-subtotal');
        const totalNode = document.getElementById('pos-total');
        
        if (!container) return;
        
        if (posCart.length === 0) {
          container.innerHTML = `
            <div class="empty-cart">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
              </svg>
              <p>El carrito est√° vac√≠o</p>
            </div>
          `;
          if (subtotalNode) subtotalNode.textContent = '‚Ç°0.00';
          if (totalNode) totalNode.textContent = '‚Ç°0.00';
          return;
        }
        
        container.innerHTML = '';
        let total = 0;
        
        posCart.forEach((item, index) => {
          // Calcular descuento
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage'; // 'percentage' o 'amount'
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          const itemTotal = priceAfterDiscount * item.qty;
          total += itemTotal;
          
          const itemEl = document.createElement('div');
          itemEl.className = 'cart-item';
          
          // Mostrar nombre del producto con variante si existe
          let displayTitle = item.title;
          if (item.variantName) {
            displayTitle = item.title + ' - ' + item.variantName;
          }
          
          itemEl.innerHTML = `
            <img src="${item.img}" alt="${item.title}">
            <div class="cart-item-details">
              <h4>${displayTitle}</h4>
              <div class="cart-item-price">
                ${discount > 0 ? '<span style="text-decoration:line-through;color:#999;font-size:0.85rem">‚Ç°' + item.price.toLocaleString() + '</span> ' : ''}
                <span style="color:#5a2032;font-weight:700">‚Ç°${priceAfterDiscount.toLocaleString()}</span>
              </div>
              <div class="cart-item-qty">
                <button class="qty-decrease" data-index="${index}">-</button>
                <span>${item.qty}</span>
                <button class="qty-increase" data-index="${index}">+</button>
                <span style="color:#666;font-size:0.85rem;margin-left:8px">(Max: ${item.maxStock})</span>
              </div>
              <div style="display:flex;gap:5px;align-items:center;margin-top:8px;flex-wrap:wrap">
                <select class="discount-type" data-index="${index}" style="padding:4px;border:1px solid #e3cfe0;border-radius:4px;font-size:0.8rem">
                  <option value="percentage" ${discountType === 'percentage' ? 'selected' : ''}>%</option>
                  <option value="amount" ${discountType === 'amount' ? 'selected' : ''}>‚Ç°</option>
                </select>
                <input type="number" class="discount-input" data-index="${index}" value="${discount}" min="0" placeholder="Desc." style="width:60px;padding:4px;border:1px solid #e3cfe0;border-radius:4px;font-size:0.8rem">
                <button class="apply-discount" data-index="${index}" style="padding:4px 8px;background:#4caf50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.75rem;font-weight:600">Aplicar</button>
              </div>
            </div>
            <button class="cart-item-remove" data-index="${index}">‚úï</button>
          `;
          container.appendChild(itemEl);
        });
        
        // Event listeners
        container.querySelectorAll('.qty-decrease').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            changeCartQtyByIndex(index, -1);
          });
        });
        
        container.querySelectorAll('.qty-increase').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            changeCartQtyByIndex(index, 1);
          });
        });
        
        container.querySelectorAll('.cart-item-remove').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            removeFromCartByIndex(index);
          });
        });
        
        container.querySelectorAll('.apply-discount').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            const discountInput = container.querySelector(`.discount-input[data-index="${index}"]`);
            const discountType = container.querySelector(`.discount-type[data-index="${index}"]`);
            
            if (discountInput && discountType) {
              applyDiscount(index, parseFloat(discountInput.value) || 0, discountType.value);
            }
          });
        });
        
        if (subtotalNode) subtotalNode.textContent = `‚Ç°${total.toLocaleString('es-CR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        if (totalNode) totalNode.textContent = `‚Ç°${total.toLocaleString('es-CR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      }

      function applyDiscount(index, discount, discountType) {
        if (!posCart[index]) return;
        
        // Validar descuento
        if (discountType === 'percentage' && discount > 100) {
          alert('El descuento no puede ser mayor a 100%');
          return;
        }
        
        if (discountType === 'amount' && discount > posCart[index].price) {
          alert('El descuento no puede ser mayor al precio del producto');
          return;
        }
        
        posCart[index].discount = discount;
        posCart[index].discountType = discountType;
        renderPOSCart();
      }

      function changeCartQtyByIndex(index, delta) {
        if (!posCart[index]) return;
        
        const newQty = posCart[index].qty + delta;
        
        if (newQty <= 0) {
          removeFromCartByIndex(index);
          return;
        }
        
        if (newQty > posCart[index].maxStock) {
          alert(`No hay m√°s stock disponible (M√°ximo: ${posCart[index].maxStock})`);
          return;
        }
        
        posCart[index].qty = newQty;
        renderPOSCart();
      }

      function removeFromCartByIndex(index) {
        if (index >= 0 && index < posCart.length) {
          posCart.splice(index, 1);
          renderPOSCart();
        }
      }

      function addVariantToPOSCart(product, optionIndex) {
        const option = product.variants.options[optionIndex];
        if (!option) return;
        
        const optInv = option.inventory || {tienda1:0, tienda2:0, tienda3:0, bodega:0};
        const availableStock = optInv[currentStore] || 0;
        
        if (availableStock <= 0) {
          alert(`No hay stock disponible de "${option.name}" en ${currentStore}`);
          return;
        }

        const variantId = product.id + '-' + optionIndex;
        const existingItem = posCart.find(item => item.variantId === variantId);

        if (existingItem) {
          if (existingItem.qty >= availableStock) {
            alert(`No hay m√°s stock de "${option.name}" disponible en ${currentStore}`);
            return;
          }
          existingItem.qty++;
        } else {
          posCart.push({
            id: product.id,
            variantId: variantId,
            variantIndex: optionIndex,   // ‚≠ê ESTA ES LA CLAVE
            title: product.title,
            variantName: option.name,
            price: option.price || product.price,
            img: product.img,
            barcode: option.barcode,
            qty: 1,
            maxStock: availableStock
          });
        }
        
        renderPOSCart();
      }


      function completeSale() {
        if (posCart.length === 0) {
          alert('El carrito est√° vac√≠o');
          return;
        }
        
        // Reiniciar m√©todos de pago
        posPaymentMethods = [];
        
        // Mostrar modal de m√©todos de pago
        renderPaymentModal();
        document.getElementById('payment-modal').style.display = 'flex';
      }

      function createApartado() {
        if (posCart.length === 0) {
          alert('El carrito est√° vac√≠o');
          return;
        }
        
        // Crear modal para apartado
        var modal = document.createElement('div');
        modal.id = 'apartado-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
        
        var content = '<div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;max-height:60vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);">';
        content += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #ff9800;padding-bottom:15px;">';
        content += '<h2 style="margin:0;color:#ff9800">Crear Apartado</h2>';
        content += '<button onclick="document.getElementById(\'apartado-modal\').remove();" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Cajero:</label>';
        content += '<select id="apartado-cashier" style="width:100%;padding:10px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:0.95rem;margin-bottom:10px">';
        content += '<option value="">Seleccione un cajero</option>';
        content += '<optgroup label="Vendedores">';
        content += '<option value="Tamica">Tamica</option>';
        content += '<option value="Valerie">Valerie</option>';
        content += '<option value="Jesenia">Jesenia</option>';
        content += '</optgroup>';
        content += '<optgroup label="‚îÅ‚îÅ‚îÅ ENCARGADOS ‚îÅ‚îÅ‚îÅ">';
        content += '<option value="Darlyn" style="color:#2196f3;font-weight:600">üëë Darlyn (Encargado)</option>';
        content += '<option value="Rebeca" style="color:#2196f3;font-weight:600">üëë Rebeca (Encargado)</option>';
        content += '<option value="Elizabeth" style="color:#2196f3;font-weight:600">üëë Elizabeth (Encargado)</option>';
        content += '</optgroup>';
        content += '<optgroup label="‚îÅ‚îÅ‚îÅ ADMINISTRADORES ‚îÅ‚îÅ‚îÅ">';
        content += '<option value="Moni (Admin)" style="color:red">üî¥ Moni (Admin)</option>';
        content += '<option value="Hernan (Admin)" style="color:red">üî¥ Hernan (Admin)</option>';
        content += '<option value="David (Admin)" style="color:red">üî¥ David (Admin)</option>';
        content += '<option value="Esteban (Admin)" style="color:red">üî¥ Esteban (Admin)</option>';
        content += '</optgroup>';
        content += '</select>';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Nombre del cliente:</label>';
        content += '<input type="text" id="apartado-client" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" placeholder="Nombre completo">';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Tel√©fono (opcional):</label>';
        content += '<input type="tel" id="apartado-phone" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" placeholder="8888-8888">';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Correo electr√≥nico (opcional):</label>';
        content += '<input type="email" id="apartado-email" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" placeholder="correo@ejemplo.com">';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Dinero de apartado (se√±a):</label>';
        content += '<div style="position:relative">';
        content += '<span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#666;font-weight:600">‚Ç°</span>';
        content += '<input type="number" id="apartado-money" style="width:100%;padding:10px 10px 10px 35px;border:2px solid #ff9800;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" placeholder="0.00" min="0" step="0.01">';
        content += '</div>';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">M√©todo de pago de la se√±a:</label>';
        content += '<select id="apartado-payment-method" style="width:100%;padding:10px;border:2px solid #ff9800;border-radius:8px;font-family:Montserrat,sans-serif;font-size:0.95rem;">';
        content += '<option value="efectivo">üíµ Efectivo</option>';
        content += '<option value="tarjeta">üí≥ Tarjeta</option>';
        content += '<option value="sinpe">üì± Sinpe M√≥vil</option>';
        content += '<option value="otro">üìã Otro</option>';
        content += '</select>';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Descripci√≥n/Notas:</label>';
        content += '<textarea id="apartado-notes" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;min-height:100px;" placeholder="Notas adicionales"></textarea>';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;padding:15px;background:#fff3e0;border-radius:8px;border-left:4px solid #ff9800">';
        content += '<div style="font-size:0.9rem;color:#e65100;margin-bottom:5px">Total apartado:</div>';
        content += '<div style="font-size:1.8rem;font-weight:bold;color:#ff9800" id="apartado-total">‚Ç°0.00</div>';
        content += '</div>';
        
        content += '<div style="display:flex;gap:10px;">';
        content += '<button style="flex:1;padding:12px;background:#9e9e9e;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem" onclick="document.getElementById(\'apartado-modal\').remove()">Cancelar</button>';
        content += '<button style="flex:1;padding:12px;background:#ff9800;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem" onclick="saveApartado()">Guardar Apartado</button>';
        content += '</div>';
        content += '</div>';
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
        
        // Calcular y mostrar total del apartado
        var total = posCart.reduce((sum, item) => {
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage';
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          return sum + (priceAfterDiscount * item.qty);
        }, 0);
        
        document.getElementById('apartado-total').textContent = '‚Ç°' + total.toLocaleString('es-CR', {minimumFractionDigits: 2});
      }

      function saveApartado() {
        var cashier = document.getElementById('apartado-cashier').value;
        if (!cashier) {
          alert('Debe seleccionar un cajero');
          return;
        }
        
        var clientName = document.getElementById('apartado-client').value.trim();
        if (!clientName) {
          alert('Por favor ingresa el nombre del cliente');
          return;
        }
        
        var phone = document.getElementById('apartado-phone').value.trim();
        var email = document.getElementById('apartado-email').value.trim();
        var moneyApartado = parseFloat(document.getElementById('apartado-money').value || 0);
        
        if (moneyApartado <= 0) {
          alert('Debe ingresar una se√±a mayor a ‚Ç°0');
          return;
        }
        
        var paymentMethod = document.getElementById('apartado-payment-method').value;
        var notes = document.getElementById('apartado-notes').value.trim();
        
        console.log('üí∞ Se√±a ingresada:', moneyApartado, 'Tipo:', typeof moneyApartado);
        
        // Calcular total
        var total = posCart.reduce((sum, item) => {
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage';
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          return sum + (priceAfterDiscount * item.qty);
        }, 0);
        
        // Crear objeto de apartado
        var apartado = {
          id: 'APT-' + new Date().getTime(),
          date: getLocalISODateTime(),
          expiresAt: (function() {
            var futureDate = new Date(new Date().getTime() + 30 * 24 * 60 * 60 * 1000);
            var year = futureDate.getFullYear();
            var month = String(futureDate.getMonth() + 1).padStart(2, '0');
            var day = String(futureDate.getDate()).padStart(2, '0');
            var hour = String(futureDate.getHours()).padStart(2, '0');
            var minute = String(futureDate.getMinutes()).padStart(2, '0');
            var second = String(futureDate.getSeconds()).padStart(2, '0');
            return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':' + second;
          })(),
          cashier: cashier,
          clientName: clientName,
          phone: phone,
          email: email,
          moneyApartado: moneyApartado,
          paymentMethod: paymentMethod,
          notes: notes,
          store: currentStore,
          items: JSON.parse(JSON.stringify(posCart)),
          total: total,
          balance: total - moneyApartado,
          status: 'activo'
        };
        
        // Guardar en localStorage
        try {
          console.log('üîµ INICIANDO GUARDADO DE APARTADO:');
          console.log('   ID:', apartado.id);
          console.log('   Cliente:', apartado.clientName);
          console.log('   Se√±a:', apartado.moneyApartado, 'Tipo:', typeof apartado.moneyApartado);
          console.log('   Total:', apartado.total);
          console.log('   Balance:', apartado.balance);
          
          // Limpiar apartados vencidos primero
          cleanExpiredApartados();
          console.log('‚úì Apartados vencidos limpiados');
          
          var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
          apartados.push(apartado);
          localStorage.setItem('apartados', JSON.stringify(apartados));
          console.log('‚úì Apartado guardado en "apartados" storage:', apartados.length, 'apartados totales');
          
          // Generar factura de apartado
          console.log('üîµ Llamando printApartadoInvoice()');
          printApartadoInvoice(apartado);
          console.log('‚úì Factura generada');
          
          // Guardar en historial de facturas tambi√©n
          console.log('üîµ Llamando saveApartadoToHistory()');
          saveApartadoToHistory(apartado);
          console.log('‚úì saveApartadoToHistory() completado');
          
          var balanceText = apartado.balance > 0 ? '\nSaldo pendiente: ‚Ç°' + apartado.balance.toLocaleString('es-CR', {minimumFractionDigits: 2}) : '\n‚úÖ Apartado pagado en su totalidad';
          var expiresDate = new Date(apartado.expiresAt).toLocaleDateString('es-CR');
          alert('‚úÖ Apartado creado exitosamente\nID: ' + apartado.id + '\nCliente: ' + clientName + '\nCajero: ' + cashier + '\nSe√±a recibida: ‚Ç°' + moneyApartado.toLocaleString('es-CR', {minimumFractionDigits: 2}) + balanceText + '\nExpira: ' + expiresDate);
          
          // Restar inventario por los productos apartados
          for (var i = 0; i < posCart.length; i++) {
            var cartItem = posCart[i];
            var product = productsData.find(function(p) { return p.id === cartItem.id; });
            if (product) {
              // Si el producto tiene variantes
              if (cartItem.variantName && product.variants && product.variants.options) {
                var variantOption = product.variants.options.find(function(opt) { return opt.name === cartItem.variantName; });
                if (variantOption && variantOption.inventory) {
                  variantOption.inventory[currentStore] = Math.max(0, (variantOption.inventory[currentStore] || 0) - cartItem.qty);
                }
              } else if (product.inventory) {
                // Si no es variante, actualizar inventario ra√≠z
                product.inventory[currentStore] = Math.max(0, (product.inventory[currentStore] || 0) - cartItem.qty);
              }
            }
          }
          
          // Guardar cambios de inventario
          if (typeof saveProductsToStorage !== 'undefined') {
            saveProductsToStorage(productsData);
          }
          
          // Recargar datos de productos para refrescar inventario
          if (typeof refreshPOSData === 'function') {
            refreshPOSData();
          }
          
          // Limpiar carrito
          posCart = [];
          renderPOSCart();
          
          // Cerrar modal
          document.getElementById('apartado-modal').remove();
        } catch (err) {
          console.error('Error al guardar apartado:', err);
          alert('Error al guardar el apartado');
        }
      }

      function printApartadoInvoice(apartado) {
        // Eliminar modal anterior si existe
        const existingModal = document.getElementById('apartado-invoice-modal');
        if (existingModal) {
          existingModal.remove();
        }
        
        var now = new Date();
        var storeName = getStoreName(apartado.store);
        var subtotal = apartado.total;
        var expiresDate = new Date(apartado.expiresAt);
        
        var html = '<div id="apartado-invoice-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:3000;display:flex;align-items:center;justify-content:center;padding:20px;">';
        html += '<div style="background:white;width:100%;max-width:500px;padding:30px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto;" class="apartado-invoice-content">';
        
        // Encabezado
        html += '<div style="text-align:center;margin-bottom:20px;border-bottom:2px solid #ff9800;padding-bottom:15px">';
        html += '<h2 style="margin:0 0 5px 0;font-family:\'Daily\',Playfair Display,serif;color:#2c4a8c;font-size:1.8rem">' + storeName + '</h2>';
        html += '<p style="margin:5px 0 0 0;color:#666;font-size:0.9rem">APARTADO REGISTRADO</p>';
        html += '<p style="margin:0;color:#666;font-size:0.9rem">APARTADO REGISTRADO</p>';
        html += '</div>';
        
        // Informaci√≥n del apartado
        html += '<div style="margin-bottom:15px;font-size:0.9rem">';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-weight:600">ID Apartado:</span><span>' + apartado.id + '</span></div>';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-weight:600">Fecha:</span><span>' + now.toLocaleDateString('es-CR') + ' ' + now.toLocaleTimeString('es-CR') + '</span></div>';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-weight:600">Cajero:</span><span>' + apartado.cashier + '</span></div>';
        html += '</div>';
        
        // Informaci√≥n del cliente
        html += '<div style="margin-bottom:15px;border-top:1px solid #ddd;padding-top:10px;font-size:0.9rem">';
        html += '<div style="font-weight:600;margin-bottom:8px">DATOS DEL CLIENTE</div>';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>Nombre:</span><span>' + apartado.clientName + '</span></div>';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>Tel√©fono:</span><span>' + (apartado.phone || '-') + '</span></div>';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>Email:</span><span style="font-size:0.8rem">' + (apartado.email || '-') + '</span></div>';
        html += '</div>';
        
        // Art√≠culos
        html += '<div style="margin-bottom:15px;border-top:1px solid #ddd;padding-top:10px">';
        html += '<div style="font-weight:600;margin-bottom:8px;font-size:0.9rem">ART√çCULOS</div>';
        
        for (var i = 0; i < apartado.items.length; i++) {
          var item = apartado.items[i];
          var itemTotal = (item.priceAfterDiscount || item.price) * item.qty;
          var displayTitle = item.title + (item.variantName ? ' - ' + item.variantName : '');
          
          html += '<div style="font-size:0.85rem;margin-bottom:5px;padding-bottom:5px;border-bottom:1px dotted #eee">';
          html += '<div style="display:flex;justify-content:space-between;margin-bottom:2px">';
          html += '<span>' + displayTitle + '</span>';
          html += '<span style="font-weight:600">‚Ç°' + itemTotal.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</span>';
          html += '</div>';
          html += '<div style="display:flex;justify-content:space-between;font-size:0.75rem;color:#666">';
          html += '<span>‚Ç°' + (item.priceAfterDiscount || item.price).toLocaleString('es-CR', {minimumFractionDigits: 2}) + ' x ' + item.qty + '</span>';
          if (item.discount > 0) {
            var discText = item.discountType === 'percentage' ? item.discount + '%' : '‚Ç°' + item.discount.toLocaleString('es-CR', {minimumFractionDigits: 2});
            html += '<span>Desc: ' + discText + '</span>';
          }
          html += '</div>';
          html += '</div>';
        }
        html += '</div>';
        
        // Totales
        html += '<div style="border-top:2px solid #ff9800;border-bottom:2px solid #ff9800;padding:10px 0;margin-bottom:15px">';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.95rem">';
        html += '<span style="font-weight:600">TOTAL:</span>';
        html += '<span style="font-weight:700;color:#1976d2">‚Ç°' + apartado.total.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</span>';
        html += '</div>';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.95rem;color:#4caf50">';
        html += '<span style="font-weight:600">SE√ëA RECIBIDA:</span>';
        html += '<span style="font-weight:700">‚Ç°' + apartado.moneyApartado.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</span>';
        html += '</div>';
        
        if (apartado.balance > 0) {
          html += '<div style="display:flex;justify-content:space-between;font-size:0.95rem;color:#ff9800">';
          html += '<span style="font-weight:600">SALDO PENDIENTE:</span>';
          html += '<span style="font-weight:700">‚Ç°' + apartado.balance.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</span>';
          html += '</div>';
        }
        html += '</div>';
        
        // Informaci√≥n de expiraci√≥n
        html += '<div style="background:#fff3cd;border:1px solid #ffc107;border-radius:4px;padding:10px;margin-bottom:15px;font-size:0.85rem;text-align:center">';
        html += '<div style="font-weight:600;margin-bottom:3px">‚è∞ V√ÅLIDO POR 30 D√çAS NATURALES</div>';
        html += '<div>Expira: ' + expiresDate.toLocaleDateString('es-CR') + '</div>';
        html += '</div>';
        
        // Notas si existen
        if (apartado.notes) {
          html += '<div style="background:#f5f5f5;border-radius:4px;padding:8px;margin-bottom:15px;font-size:0.85rem">';
          html += '<div style="font-weight:600;margin-bottom:3px">NOTAS:</div>';
          html += '<div>' + apartado.notes + '</div>';
          html += '</div>';
        }
        
        // Botones
        html += '<div style="display:flex;gap:10px;margin-top:20px">';
        html += '<button onclick="window.print()" style="flex:1;padding:10px;background:#1976d2;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600">üñ®Ô∏è Imprimir</button>';
        html += '<button onclick="document.getElementById(\'apartado-invoice-modal\').remove()" style="flex:1;padding:10px;background:#999;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600">‚úï Cerrar</button>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        
        var modal = document.createElement('div');
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        // Estilos de impresi√≥n para apartado
        var existingStyle = document.getElementById('apartado-print-style');
        if (existingStyle) {
          existingStyle.remove();
        }
        var style = document.createElement('style');
        style.id = 'apartado-print-style';
        style.textContent = `
          @media print {
            * { margin:0 !important; padding:0 !important; }
            body { margin:0 !important; padding:0 !important; background:white !important; }
            html { margin:0 !important; padding:0 !important; }
            @page { size:A4; margin:0.5cm; }
            .pos-container { display:none !important; }
            .admin-tabs { display:none !important; }
            main { display:none !important; }
            #apartado-invoice-modal { 
              display:block !important; 
              position:static !important; 
              background:white !important; 
              z-index:auto !important;
              width:100% !important;
              height:100% !important;
              top:0 !important;
              left:0 !important;
            }
            .apartado-invoice-content { 
              display:block !important;
              box-shadow:none !important; 
              page-break-after:avoid !important; 
              max-height:none !important; 
              overflow:visible !important;
              padding:15px !important;
              width:100% !important;
              font-family:Arial, sans-serif !important;
              border-radius:0 !important;
              max-width:none !important;
            }
            button { display:none !important; }
            h2 { font-size:1.2rem !important; margin:3px 0 !important; }
            p { margin:3px 0 !important; font-size:0.85rem !important; }
            div { page-break-inside:avoid !important; }
            details { page-break-inside:avoid !important; }
          }
        `;
        document.head.appendChild(style);
      }

      function saveApartadoToHistory(apartado) {
        console.log('üìù saveApartadoToHistory() INICIADO para apartado:', apartado.id);
        var now = new Date();
        var invoiceId = 'APT-FAC-' + now.getTime();
        var subtotal = apartado.total;
        
        console.log('- invoiceId generado:', invoiceId);
        console.log('- subtotal:', subtotal);
        console.log('- items a guardar:', apartado.items.length);
        console.log('- fecha del apartado:', apartado.date);
        
        // Crear copias de los items
        var itemsCopy = [];
        for (var i = 0; i < apartado.items.length; i++) {
          var item = apartado.items[i];
          itemsCopy.push({
            id: item.id,
            variantId: item.variantId,
            variantName: item.variantName,
            title: item.title,
            price: item.price,
            discount: item.discount || 0,
            discountType: item.discountType || 'percentage',
            priceAfterDiscount: item.priceAfterDiscount || item.price,
            img: item.img,
            barcode: item.barcode,
            qty: item.qty,
            maxStock: item.maxStock
          });
        }
        
        var invoice = {
          id: invoiceId,
          date: apartado.date,
          store: apartado.store,
          cashier: apartado.cashier,
          items: itemsCopy,
          paymentMethods: [{method: apartado.paymentMethod || 'efectivo', amount: parseFloat(apartado.moneyApartado) || 0}],
          subtotal: subtotal,
          dateString: now.toLocaleDateString('es-CR'),
          apartadoInfo: {
            apartadoId: apartado.id,
            apartadoStatus: 'creado',
            clientName: apartado.clientName,
            phone: apartado.phone,
            email: apartado.email,
            moneyApartado: parseFloat(apartado.moneyApartado) || 0,
            paymentMethod: apartado.paymentMethod || 'efectivo',
            balance: parseFloat(apartado.balance) || 0,
            expiresAt: apartado.expiresAt,
            notes: apartado.notes
          }
        };
        
        console.log('üì¶ Invoice creado con apartadoInfo:', invoice.apartadoInfo);
        console.log('üì¶ Se√±a a guardar:', invoice.apartadoInfo.moneyApartado, 'Tipo:', typeof invoice.apartadoInfo.moneyApartado);
        console.log('üì¶ Invoice con fecha:', invoice.date);
        
        try {
          var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
          console.log('- Facturas antes de agregar:', invoices.length);
          invoices.push(invoice);
          console.log('- Facturas despu√©s de agregar:', invoices.length);
          
          // Verificar que el apartado est√© en el array
          var apartadosEnArray = invoices.filter(function(inv) { return inv.apartadoInfo; });
          console.log('- Apartados en el array:', apartadosEnArray.length);
          
          localStorage.setItem('invoiceHistory', JSON.stringify(invoices));
          console.log('‚úì Guardado en localStorage exitoso');
          
          // Verificar que se guard√≥ correctamente
          var verificacion = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
          var apartadosVerif = verificacion.filter(function(inv) { return inv.apartadoInfo; });
          console.log('‚úì‚úì VERIFICACI√ìN FINAL - Apartados en storage:', apartadosVerif.length);
          console.log('‚úì Apartado guardado en historial de facturas:', invoiceId);
        } catch (err) {
          console.error('‚ùå Error al guardar apartado en historial:', err);
        }
      }

      function cleanExpiredApartados() {
        try {
          var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
          var now = new Date();
          
          // Identificar apartados que han expirado
          var expiredApartados = apartados.filter(function(apt) {
            var expiresAt = new Date(apt.expiresAt);
            return expiresAt <= now;
          });
          
          // Restaurar inventario de apartados expirados
          for (var i = 0; i < expiredApartados.length; i++) {
            var expiredApt = expiredApartados[i];
            // Restaurar cada producto del apartado expirado
            for (var j = 0; j < expiredApt.items.length; j++) {
              var item = expiredApt.items[j];
              var product = productsData.find(function(p) { return p.id === item.id; });
              if (product) {
                // Si tiene variante
                if (item.variantName && product.variants && product.variants.options) {
                  var variantOption = product.variants.options.find(function(opt) { return opt.name === item.variantName; });
                  if (variantOption && variantOption.inventory) {
                    variantOption.inventory[expiredApt.store] = (variantOption.inventory[expiredApt.store] || 0) + item.qty;
                  }
                } else if (product.inventory) {
                  // Sin variante, restaurar inventario ra√≠z
                  product.inventory[expiredApt.store] = (product.inventory[expiredApt.store] || 0) + item.qty;
                }
              }
            }
          }
          
          // Guardar cambios de inventario si hay apartados expirados
          if (expiredApartados.length > 0 && typeof saveProductsToStorage !== 'undefined') {
            saveProductsToStorage(productsData);
            // Recargar datos de productos para refrescar inventario
            if (typeof refreshPOSData === 'function') {
              refreshPOSData();
            }
          }
          
          // Eliminar apartados expirados del historial de facturas tambi√©n
          if (expiredApartados.length > 0) {
            try {
              var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
              var expiredIds = expiredApartados.map(function(apt) { return apt.id; });
              invoices = invoices.filter(function(invoice) {
                return !invoice.apartadoInfo || expiredIds.indexOf(invoice.apartadoInfo.apartadoId) === -1;
              });
              localStorage.setItem('invoiceHistory', JSON.stringify(invoices));
              console.log('‚úì ' + expiredApartados.length + ' apartado(s) expirado(s) eliminado(s) del historial');
            } catch (err) {
              console.error('Error al eliminar apartados expirados del historial:', err);
            }
          }
          
          // Filtrar apartados que no han expirado
          var activeApartados = apartados.filter(function(apt) {
            var expiresAt = new Date(apt.expiresAt);
            return expiresAt > now;
          });
          
          // Guardar solo los activos
          if (activeApartados.length < apartados.length) {
            localStorage.setItem('apartados', JSON.stringify(activeApartados));
          }
        } catch (err) {
          console.error('Error al limpiar apartados vencidos:', err);
        }
      }

      function openApartadosTab() {
        // Limpiar apartados vencidos
        cleanExpiredApartados();
        
        var modal = document.createElement('div');
        modal.id = 'apartados-list-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
        
        var content = '<div style="background:white;padding:30px;border-radius:12px;max-width:1000px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);">';
        
        // Header
        content += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:3px solid #ff9800;padding-bottom:15px;">';
        content += '<h2 style="margin:0;color:#ff9800">Apartados Activos</h2>';
        content += '<button onclick="document.getElementById(\'apartados-list-modal\').remove();" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>';
        content += '</div>';
        
        // Filtros
        content += '<div style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap">';
        content += '<div style="flex:1;min-width:200px">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:5px">Tienda:</label>';
        content += '<select id="apartados-filter-store" onchange="filterApartadosDisplay()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">';
        content += '<option value="">Todas las tiendas</option>';
        content += '<option value="tienda1">Sophie Store</option>';
        content += '<option value="tienda2">Sophie Mall</option>';
        content += '<option value="tienda3">Sophie\'s Ticados</option>';
        content += '</select>';
        content += '</div>';
        content += '<div style="flex:1;min-width:200px">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:5px">Cajero:</label>';
        content += '<input type="text" id="apartados-filter-cashier" onchange="filterApartadosDisplay()" placeholder="Buscar cajero" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">';
        content += '</div>';
        content += '<div style="flex:1;min-width:200px">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:5px">Cliente:</label>';
        content += '<input type="text" id="apartados-filter-client" onchange="filterApartadosDisplay()" placeholder="Buscar cliente" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">';
        content += '</div>';
        content += '</div>';
        
        // Contenedor de apartados
        content += '<div id="apartados-list-container" style="margin-top:20px"></div>';
        
        content += '</div>';
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
        
        // Mostrar apartados
        displayApartados();
      }

      function displayApartados() {
        try {
          var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
          var container = document.getElementById('apartados-list-container');
          
          if (apartados.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No hay apartados registrados</p>';
            return;
          }
          
          var html = '';
          for (var i = apartados.length - 1; i >= 0; i--) {
            var apt = apartados[i];
            var createdDate = new Date(apt.date);
            var expiresDate = new Date(apt.expiresAt);
            var now = new Date();
            var daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
            
            var statusColor = daysLeft > 7 ? '#4caf50' : daysLeft > 0 ? '#ff9800' : '#f44336';
            var statusText = daysLeft > 0 ? daysLeft + ' d√≠a(s)' : 'VENCIDO';
            
            var storeName = apt.store === 'tienda1' ? 'Sophie Store' : apt.store === 'tienda2' ? 'Sophie Mall' : 'Sophie\'s Ticados';
            
            html += '<div style="border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:15px;background:#f9f9f9">';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">';
            
            html += '<div>';
            html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">ID Apartado</div>';
            html += '<div style="font-size:1.1rem;font-weight:bold;color:#333">' + apt.id + '</div>';
            html += '</div>';
            
            html += '<div>';
            html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">Cliente</div>';
            html += '<div style="font-size:1.1rem;font-weight:bold;color:#333">' + apt.clientName + '</div>';
            html += '</div>';
            
            html += '<div>';
            html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">Cajero</div>';
            html += '<div style="font-size:1rem;font-weight:bold;color:' + (apt.cashier.includes('Admin') ? '#f44336' : '#333') + '">' + apt.cashier + '</div>';
            html += '</div>';
            
            html += '<div>';
            html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">Tienda</div>';
            html += '<div style="font-size:1rem;font-weight:bold;color:#333">' + storeName + '</div>';
            html += '</div>';
            
            html += '</div>';
            
            html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:15px">';
            
            html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
            html += '<div style="font-size:0.8rem;color:#666">Total</div>';
            html += '<div style="font-size:1.2rem;font-weight:bold;color:#1976d2">‚Ç°' + apt.total.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</div>';
            html += '</div>';
            
            html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
            html += '<div style="font-size:0.8rem;color:#666">Se√±a</div>';
            html += '<div style="font-size:1.2rem;font-weight:bold;color:#4caf50">‚Ç°' + apt.moneyApartado.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</div>';
            html += '</div>';
            
            html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
            html += '<div style="font-size:0.8rem;color:#666">Saldo</div>';
            html += '<div style="font-size:1.2rem;font-weight:bold;color:' + (apt.balance > 0 ? '#ff9800' : '#4caf50') + '">‚Ç°' + apt.balance.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</div>';
            html += '</div>';
            
            html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
            html += '<div style="font-size:0.8rem;color:#666">Expira en</div>';
            html += '<div style="font-size:1.2rem;font-weight:bold;color:' + statusColor + '">' + statusText + '</div>';
            html += '</div>';
            
            html += '</div>';
            
            html += '<div style="margin-bottom:10px">';
            html += '<details>';
            html += '<summary style="cursor:pointer;color:#1976d2;font-weight:600;user-select:none">Ver art√≠culos (' + apt.items.length + ')</summary>';
            html += '<div style="padding:10px;margin-top:10px;background:white;border-radius:4px">';
            
            var itemsTotal = 0;
            for (var j = 0; j < apt.items.length; j++) {
              var item = apt.items[j];
              var itemTotal = (item.priceAfterDiscount || item.price) * item.qty;
              itemsTotal += itemTotal;
              
              var displayTitle = item.title + (item.variantName ? ' - ' + item.variantName : '');
              html += '<div style="padding:5px 0;border-bottom:1px solid #eee;font-size:0.9rem">';
              html += '<div style="display:flex;justify-content:space-between">';
              html += '<span>' + displayTitle + ' x' + item.qty + '</span>';
              html += '<span style="font-weight:600">‚Ç°' + itemTotal.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</span>';
              html += '</div>';
              html += '</div>';
            }
            
            html += '</div>';
            html += '</details>';
            html += '</div>';
            
            html += '<div style="display:flex;gap:10px;border-top:1px solid #ddd;padding-top:10px">';
            if (apt.balance > 0) {
              html += '<button onclick="openApartadoAbono(' + i + ')" style="flex:1;padding:8px;background:#ff9800;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:0.9rem">üí≥ Abonar</button>';
            }
            html += '<button onclick="completeApartado(' + i + ')" style="flex:1;padding:8px;background:#4caf50;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:0.9rem">‚úÖ Completar Venta</button>';
            html += '<button onclick="deleteApartado(' + i + ')" style="flex:1;padding:8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:0.9rem">üóëÔ∏è Eliminar</button>';
            html += '</div>';
            
            html += '</div>';
          }
          
          container.innerHTML = html;
        } catch (err) {
          console.error('Error al mostrar apartados:', err);
          document.getElementById('apartados-list-container').innerHTML = '<p style="color:#f44336">Error al cargar apartados</p>';
        }
      }

      function filterApartadosDisplay() {
        var storeFilter = document.getElementById('apartados-filter-store').value;
        var cashierFilter = document.getElementById('apartados-filter-cashier').value.toLowerCase();
        var clientFilter = document.getElementById('apartados-filter-client').value.toLowerCase();
        
        var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
        var filtered = apartados.filter(function(apt) {
          var storeMatch = !storeFilter || apt.store === storeFilter;
          var cashierMatch = !cashierFilter || apt.cashier.toLowerCase().includes(cashierFilter);
          var clientMatch = !clientFilter || apt.clientName.toLowerCase().includes(clientFilter);
          return storeMatch && cashierMatch && clientMatch;
        });
        
        var container = document.getElementById('apartados-list-container');
        if (filtered.length === 0) {
          container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No hay apartados que coincidan con los filtros</p>';
          return;
        }
        
        // Guardar temporalmente en una variable global para mostrar filtrados
        var html = '';
        for (var i = filtered.length - 1; i >= 0; i--) {
          var apt = filtered[i];
          var createdDate = new Date(apt.date);
          var expiresDate = new Date(apt.expiresAt);
          var now = new Date();
          var daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
          
          var statusColor = daysLeft > 7 ? '#4caf50' : daysLeft > 0 ? '#ff9800' : '#f44336';
          var statusText = daysLeft > 0 ? daysLeft + ' d√≠a(s)' : 'VENCIDO';
          
          var storeName = apt.store === 'tienda1' ? 'Sophie Store' : apt.store === 'tienda2' ? 'Sophie Mall' : 'Sophie\'s Ticados';
          
          // Encontrar el √≠ndice original para los botones
          var originalIndex = apartados.indexOf(apt);
          
          html += '<div style="border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:15px;background:#f9f9f9">';
          html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">';
          
          html += '<div>';
          html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">ID Apartado</div>';
          html += '<div style="font-size:1.1rem;font-weight:bold;color:#333">' + apt.id + '</div>';
          html += '</div>';
          
          html += '<div>';
          html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">Cliente</div>';
          html += '<div style="font-size:1.1rem;font-weight:bold;color:#333">' + apt.clientName + '</div>';
          html += '</div>';
          
          html += '<div>';
          html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">Cajero</div>';
          html += '<div style="font-size:1rem;font-weight:bold;color:' + (apt.cashier.includes('Admin') ? '#f44336' : '#333') + '">' + apt.cashier + '</div>';
          html += '</div>';
          
          html += '<div>';
          html += '<div style="font-size:0.9rem;color:#666;margin-bottom:2px">Tienda</div>';
          html += '<div style="font-size:1rem;font-weight:bold;color:#333">' + storeName + '</div>';
          html += '</div>';
          
          html += '</div>';
          
          html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:15px">';
          
          html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
          html += '<div style="font-size:0.8rem;color:#666">Total</div>';
          html += '<div style="font-size:1.2rem;font-weight:bold;color:#1976d2">‚Ç°' + apt.total.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</div>';
          html += '</div>';
          
          html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
          html += '<div style="font-size:0.8rem;color:#666">Se√±a</div>';
          html += '<div style="font-size:1.2rem;font-weight:bold;color:#4caf50">‚Ç°' + apt.moneyApartado.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</div>';
          html += '</div>';
          
          html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
          html += '<div style="font-size:0.8rem;color:#666">Saldo</div>';
          html += '<div style="font-size:1.2rem;font-weight:bold;color:' + (apt.balance > 0 ? '#ff9800' : '#4caf50') + '">‚Ç°' + apt.balance.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</div>';
          html += '</div>';
          
          html += '<div style="background:white;padding:10px;border-radius:4px;text-align:center">';
          html += '<div style="font-size:0.8rem;color:#666">Expira en</div>';
          html += '<div style="font-size:1.2rem;font-weight:bold;color:' + statusColor + '">' + statusText + '</div>';
          html += '</div>';
          
          html += '</div>';
          
          html += '<div style="margin-bottom:10px">';
          html += '<details>';
          html += '<summary style="cursor:pointer;color:#1976d2;font-weight:600;user-select:none">Ver art√≠culos (' + apt.items.length + ')</summary>';
          html += '<div style="padding:10px;margin-top:10px;background:white;border-radius:4px">';
          
          var itemsTotal = 0;
          for (var j = 0; j < apt.items.length; j++) {
            var item = apt.items[j];
            var itemTotal = (item.priceAfterDiscount || item.price) * item.qty;
            itemsTotal += itemTotal;
            
            var displayTitle = item.title + (item.variantName ? ' - ' + item.variantName : '');
            html += '<div style="padding:5px 0;border-bottom:1px solid #eee;font-size:0.9rem">';
            html += '<div style="display:flex;justify-content:space-between">';
            html += '<span>' + displayTitle + ' x' + item.qty + '</span>';
            html += '<span style="font-weight:600">‚Ç°' + itemTotal.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '</span>';
            html += '</div>';
            html += '</div>';
          }
          
          html += '</div>';
          html += '</details>';
          html += '</div>';
          
          html += '<div style="display:flex;gap:10px;border-top:1px solid #ddd;padding-top:10px">';
          if (apt.balance > 0) {
            html += '<button onclick="openApartadoAbono(' + originalIndex + ')" style="flex:1;padding:8px;background:#ff9800;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:0.9rem">üí≥ Abonar</button>';
          }
          html += '<button onclick="completeApartado(' + originalIndex + ')" style="flex:1;padding:8px;background:#4caf50;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:0.9rem">‚úÖ Completar Venta</button>';
          html += '<button onclick="deleteApartado(' + originalIndex + ')" style="flex:1;padding:8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:0.9rem">üóëÔ∏è Eliminar</button>';
          html += '</div>';
          
          html += '</div>';
        }
        
        container.innerHTML = html;
      }

      function completeApartado(index) {
        var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
        var apt = apartados[index];
        
        if (confirm('¬øConvertir apartado de ' + apt.clientName + ' a venta completa?')) {
          // Cargar items en el carrito
          posCart = JSON.parse(JSON.stringify(apt.items));
          currentStore = apt.store;
          
          // Almacenar el apartado en proceso para calcular saldo en el checkout
          currentApartadoInProgress = {
            id: apt.id,
            clientName: apt.clientName,
            se√±aPagada: apt.moneyApartado,
            totalApartado: apt.total,
            phoneNumber: apt.phoneNumber,
            email: apt.email,
            paymentMethod: apt.paymentMethod,
            notes: apt.notes
          };
          
          // Actualizar selector de tienda
          document.getElementById('current-store').value = apt.store;
          
          // Cerrar modal
          document.getElementById('apartados-list-modal').remove();
          
          // Renderizar carrito
          renderPOSCart();
          renderPOSProducts();
          
          // Mostrar modal de pago autom√°ticamente
          posPaymentMethods = [];
          renderPaymentModal();
          document.getElementById('payment-modal').style.display = 'flex';
        }
      }

      function openApartadoAbono(index) {
        var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
        var apt = apartados[index];
        if (!apt) return;
        if (apt.balance <= 0) {
          alert('Este apartado ya est√° pagado.');
          return;
        }

        var modal = document.createElement('div');
        modal.id = 'apartado-abono-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2500;display:flex;align-items:center;justify-content:center;';

        var content = '';
        content += '<div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;max-height:70vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);">';
        content += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #ff9800;padding-bottom:15px;">';
        content += '<h2 style="margin:0;color:#ff9800">Registrar Abono</h2>';
        content += '<button onclick="document.getElementById(\'apartado-abono-modal\').remove();" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>';
        content += '</div>';

        content += '<div style="margin-bottom:15px;font-size:0.95rem;color:#333">';
        content += '<div><strong>Cliente:</strong> ' + apt.clientName + '</div>';
        content += '<div><strong>Saldo actual:</strong> ‚Ç°' + apt.balance.toLocaleString('es-CR', {minimumFractionDigits:2}) + '</div>';
        content += '</div>';

        content += '<div style="margin-bottom:15px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Cajero:</label>';
        content += '<select id="abono-cashier" style="width:100%;padding:10px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:0.95rem">';
        content += '<option value="">Seleccione un cajero</option>';
        content += '<optgroup label="Vendedores">';
        content += '<option value="Tamica">Tamica</option>';
        content += '<option value="Valerie">Valerie</option>';
        content += '<option value="Jesenia">Jesenia</option>';
        content += '</optgroup>';
        content += '<optgroup label="‚îÅ‚îÅ‚îÅ ENCARGADOS ‚îÅ‚îÅ‚îÅ">';
        content += '<option value="Darlyn">üëë Darlyn (Encargado)</option>';
        content += '<option value="Rebeca">üëë Rebeca (Encargado)</option>';
        content += '<option value="Elizabeth">üëë Elizabeth (Encargado)</option>';
        content += '</optgroup>';
        content += '<optgroup label="‚îÅ‚îÅ‚îÅ ADMINISTRADORES ‚îÅ‚îÅ‚îÅ">';
        content += '<option value="Moni">üî¥ Moni (Admin)</option>';
        content += '<option value="Hernan">üî¥ Hernan (Admin)</option>';
        content += '<option value="David">üî¥ David (Admin)</option>';
        content += '<option value="Esteban">üî¥ Esteban (Admin)</option>';
        content += '</optgroup>';
        content += '</select>';
        content += '</div>';

        content += '<div style="margin-bottom:15px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">M√©todo de pago:</label>';
        content += '<select id="abono-method" style="width:100%;padding:10px;border:2px solid #ff9800;border-radius:8px;font-family:Montserrat,sans-serif;font-size:0.95rem">';
        content += '<option value="efectivo">üíµ Efectivo</option>';
        content += '<option value="tarjeta">üí≥ Tarjeta</option>';
        content += '<option value="sinpe">üì± Sinpe M√≥vil</option>';
        content += '<option value="otro">üìã Otro</option>';
        content += '</select>';
        content += '</div>';

        content += '<div style="margin-bottom:15px;">';
        content += '<label style="display:block;color:#333;font-weight:600;margin-bottom:8px">Monto del abono:</label>';
        content += '<div style="position:relative">';
        content += '<span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#666;font-weight:600">‚Ç°</span>';
        content += '<input type="number" id="abono-amount" style="width:100%;padding:10px 10px 10px 35px;border:2px solid #ff9800;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" placeholder="0.00" min="0" step="0.01">';
        content += '</div>';
        content += '</div>';

        content += '<div style="display:flex;gap:10px;">';
        content += '<button style="flex:1;padding:12px;background:#9e9e9e;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem" onclick="document.getElementById(\'apartado-abono-modal\').remove()">Cancelar</button>';
        content += '<button style="flex:1;padding:12px;background:#ff9800;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem" onclick="saveApartadoAbono(' + index + ')">Guardar Abono</button>';
        content += '</div>';
        content += '</div>';

        modal.innerHTML = content;
        document.body.appendChild(modal);
      }

      function saveApartadoAbono(index) {
        var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
        var apt = apartados[index];
        if (!apt) return;

        var cashier = document.getElementById('abono-cashier').value;
        if (!cashier) {
          alert('Debe seleccionar un cajero');
          return;
        }

        var method = document.getElementById('abono-method').value || 'efectivo';
        var amount = parseFloat(document.getElementById('abono-amount').value || 0);

        if (amount <= 0) {
          alert('El abono debe ser mayor a ‚Ç°0');
          return;
        }
        if (amount > apt.balance) {
          alert('El abono no puede ser mayor al saldo pendiente');
          return;
        }

        // Registrar abono
        apt.abonos = Array.isArray(apt.abonos) ? apt.abonos : [];
        apt.abonos.unshift({
          date: getLocalISODateTime(),
          amount: amount,
          method: method,
          cashier: cashier
        });

        apt.balance = Math.max(0, apt.balance - amount);

        // Extender 15 d√≠as
        var currentExpiry = apt.expiresAt ? new Date(apt.expiresAt) : new Date();
        var extended = new Date(currentExpiry.getTime() + 15 * 24 * 60 * 60 * 1000);
        apt.expiresAt = extended.toISOString();

        if (apt.balance === 0) {
          apt.status = 'pagado';
        }

        apartados[index] = apt;
        localStorage.setItem('apartados', JSON.stringify(apartados));

        // Guardar en historial de facturas (abono)
        try {
          var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
          invoices.push({
            id: 'ABN-' + new Date().getTime(),
            date: getLocalISODateTime(),
            store: apt.store,
            cashier: cashier,
            items: apt.items || [],
            paymentMethods: [{ method: method, amount: amount }],
            subtotal: amount,
            dateString: new Date().toLocaleDateString('es-CR'),
            taxType: 'simple',
            taxInfo: { subtotal: amount, iva: 0, total: amount, baseImponible: 0 },
            apartadoInfo: {
              apartadoId: apt.id,
              apartadoStatus: 'abono',
              clientName: apt.clientName,
              moneyApartado: apt.moneyApartado,
              abonoAmount: amount,
              balance: apt.balance,
              notes: apt.notes
            }
          });
          localStorage.setItem('invoiceHistory', JSON.stringify(invoices));
        } catch (err) {
          console.error('Error al guardar abono en historial:', err);
        }

        // Actualizar UI
        displayApartados();
        document.getElementById('apartado-abono-modal').remove();
        alert('‚úÖ Abono registrado y apartado extendido 15 d√≠as');
      }

      function deleteApartado(index) {
        var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
        var apt = apartados[index];
        
        if (confirm('¬øEliminar apartado de ' + apt.clientName + ' (' + apt.id + ')?\n\nSe restaurar√° el inventario')) {
          // Restaurar inventario
          for (var i = 0; i < apt.items.length; i++) {
            var item = apt.items[i];
            var product = productsData.find(function(p) { return p.id === item.id; });
            if (product) {
              // Si tiene variante
              if (item.variantName && product.variants && product.variants.options) {
                var variantOption = product.variants.options.find(function(opt) { return opt.name === item.variantName; });
                if (variantOption && variantOption.inventory) {
                  variantOption.inventory[apt.store] = (variantOption.inventory[apt.store] || 0) + item.qty;
                }
              } else if (product.inventory) {
                // Sin variante, restaurar inventario ra√≠z
                product.inventory[apt.store] = (product.inventory[apt.store] || 0) + item.qty;
              }
            }
          }
          
          // Guardar cambios de inventario
          if (typeof saveProductsToStorage !== 'undefined') {
            saveProductsToStorage(productsData);
          }
          
          // Recargar datos de productos para refrescar inventario
          if (typeof refreshPOSData === 'function') {
            refreshPOSData();
          }
          
          apartados.splice(index, 1);
          localStorage.setItem('apartados', JSON.stringify(apartados));
          
          // Tambi√©n eliminar del historial de facturas
          try {
            var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
            var initialCount = invoices.length;
            invoices = invoices.filter(function(invoice) {
              return !invoice.apartadoInfo || invoice.apartadoInfo.apartadoId !== apt.id;
            });
            if (invoices.length < initialCount) {
              localStorage.setItem('invoiceHistory', JSON.stringify(invoices));
              console.log('‚úì Factura del apartado eliminada del historial:', apt.id);
            }
          } catch (err) {
            console.error('Error al eliminar apartado del historial:', err);
          }
          
          // Actualizar display
          displayApartados();
          
          alert('‚úÖ Apartado eliminado e inventario restaurado');
        }
      }

      function updateTaxDisplay() {
        const taxSelect = document.getElementById('tax-type-select');
        if (!taxSelect) return;
        
        currentTaxType = taxSelect.value;
        const descriptionDiv = document.getElementById('tax-description');
        
        if (currentTaxType === 'simple') {
          descriptionDiv.innerHTML = 'üí° Factura est√°ndar sin desglose de impuestos.';
          descriptionDiv.style.background = '#e3f2fd';
          descriptionDiv.style.color = '#1565c0';
        } else if (currentTaxType === 'coniva') {
          descriptionDiv.innerHTML = 'üìä Se mostrar√° el desglose del IVA (13%). El precio ya incluye IVA.';
          descriptionDiv.style.background = '#fff3e0';
          descriptionDiv.style.color = '#e65100';
        } else if (currentTaxType === 'exonerado') {
          descriptionDiv.innerHTML = 'üèõÔ∏è Factura para diplom√°ticos. Se descontar√° el 13% de IVA del total.';
          descriptionDiv.style.background = '#e8f5e9';
          descriptionDiv.style.color = '#2e7d32';
        }
        
        // Actualizar desglose de totales
        renderTaxBreakdown();
        updatePaymentBreakdown();
      }
      
      function renderTaxBreakdown() {
        const total = posCart.reduce((sum, item) => {
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage';
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          return sum + (priceAfterDiscount * item.qty);
        }, 0);
        
        // Si hay apartado, calcular sobre el total original
        const taxCalc = calculateIVA(total, currentTaxType);
        
        // Ajustar por apartado si existe
        let displayTotal = taxCalc.total;
        if (currentApartadoInProgress) {
          displayTotal = Math.max(0, taxCalc.total - currentApartadoInProgress.se√±aPagada);
        }
        
        const breakdownDiv = document.getElementById('tax-breakdown-display');
        let html = '';
        
        if (currentTaxType === 'simple') {
          html += '<div style="font-size:0.95rem;color:#666;margin-bottom:5px">Total a pagar:</div>';
          html += '<div style="font-size:2rem;font-weight:700;color:#5a2032">' + formatMoney(displayTotal) + '</div>';
        } else if (currentTaxType === 'coniva') {
          html += '<div style="font-size:0.85rem;color:#666;margin-bottom:3px">Base imponible:</div>';
          html += '<div style="font-size:1.1rem;font-weight:600;color:#333;margin-bottom:8px">' + formatMoney(taxCalc.baseImponible) + '</div>';
          html += '<div style="font-size:0.85rem;color:#666;margin-bottom:3px">IVA (13%):</div>';
          html += '<div style="font-size:1.1rem;font-weight:600;color:#ff9800;margin-bottom:8px">' + formatMoney(taxCalc.iva) + '</div>';
          html += '<div style="border-top:2px solid #5a2032;padding-top:8px;margin-top:8px">';
          html += '<div style="font-size:0.95rem;color:#666;margin-bottom:5px">Total a pagar:</div>';
          html += '<div style="font-size:2rem;font-weight:700;color:#5a2032">' + formatMoney(displayTotal) + '</div>';
          html += '</div>';
        } else if (currentTaxType === 'exonerado') {
          html += '<div style="font-size:0.85rem;color:#2e7d32;margin-bottom:3px">‚úì Exonerado de IVA (Diplom√°ticos)</div>';
          html += '<div style="font-size:0.85rem;color:#666;margin-bottom:3px;text-decoration:line-through">Precio con IVA: ' + formatMoney(total) + '</div>';
          html += '<div style="font-size:0.85rem;color:#2e7d32;margin-bottom:3px">Descuento IVA (13%): -' + formatMoney(total - taxCalc.originalTotal) + '</div>';
          
          // Mostrar ajuste de redondeo si existe
          if (taxCalc.roundingAdjustment !== 0) {
            const roundingText = taxCalc.roundingAdjustment > 0 ? 'Redondeo' : 'Ajuste';
            const roundingColor = taxCalc.roundingAdjustment > 0 ? '#ff9800' : '#4caf50';
            html += '<div style="font-size:0.8rem;color:' + roundingColor + ';margin-bottom:8px">';
            html += roundingText + ' (denominaci√≥n): ' + (taxCalc.roundingAdjustment >= 0 ? '+' : '') + formatMoney(Math.abs(taxCalc.roundingAdjustment));
            html += '</div>';
          } else {
            html += '<div style="margin-bottom:8px"></div>';
          }
          
          html += '<div style="border-top:2px solid #2e7d32;padding-top:8px;margin-top:8px">';
          html += '<div style="font-size:0.95rem;color:#666;margin-bottom:5px">Total a pagar (sin IVA):</div>';
          html += '<div style="font-size:2rem;font-weight:700;color:#2e7d32">' + formatMoney(displayTotal) + '</div>';
          html += '</div>';
        }
        
        breakdownDiv.innerHTML = html;
      }
      
      function renderPaymentModal() {
        const total = posCart.reduce((sum, item) => {
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage';
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          return sum + (priceAfterDiscount * item.qty);
        }, 0);
        
        // Si hay un apartado en proceso, calcular solo el saldo pendiente
        var displayTotal = total;
        if (currentApartadoInProgress) {
          displayTotal = Math.max(0, total - currentApartadoInProgress.se√±aPagada);
          
          // Obtener el nombre del m√©todo de pago
          var methodNames = {
            'efectivo': '(üíµ Efectivo)',
            'tarjeta': '(üí≥ Tarjeta)',
            'sinpe': '(üì± Sinpe)',
            'otro': '(üìã Otro)'
          };
          var paymentMethodText = currentApartadoInProgress.paymentMethod ? methodNames[currentApartadoInProgress.paymentMethod] || '' : '';
          
          // Mostrar informaci√≥n del apartado
          document.getElementById('payment-title').textContent = 'üí≥ Completar Apartado';
          document.getElementById('apartado-payment-info').style.display = 'block';
          document.getElementById('apartado-client-name').textContent = currentApartadoInProgress.clientName;
          document.getElementById('apartado-total-amount').textContent = currentApartadoInProgress.totalApartado.toLocaleString('es-CR', {minimumFractionDigits: 2});
          document.getElementById('apartado-se√±a-amount').textContent = currentApartadoInProgress.se√±aPagada.toLocaleString('es-CR', {minimumFractionDigits: 2});
          document.getElementById('apartado-payment-method-display').textContent = paymentMethodText;
          document.getElementById('apartado-saldo-amount').textContent = displayTotal.toLocaleString('es-CR', {minimumFractionDigits: 2});
        } else {
          document.getElementById('payment-title').textContent = 'M√©todos de Pago';
          document.getElementById('apartado-payment-info').style.display = 'none';
        }
        
        // Inicializar tipo de impuesto
        const taxSelect = document.getElementById('tax-type-select');
        if (taxSelect) {
          taxSelect.value = 'simple';
          currentTaxType = 'simple';
        }
        updateTaxDisplay();
        
        const methodsList = document.getElementById('payment-methods-list');
        methodsList.innerHTML = `
          <div style="margin-bottom:15px">
            <label style="display:block;font-weight:600;color:#5a2032;margin-bottom:8px">Agregar m√©todo de pago:</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px">
              <button type="button" onclick="addPaymentMethod('efectivo')" style="padding:12px;background:#fff3e0;color:#e65100;border:2px solid #ffb74d;border-radius:8px;font-weight:600;cursor:pointer">üíµ Efectivo</button>
              <button type="button" onclick="addPaymentMethod('tarjeta')" style="padding:12px;background:#e3f2fd;color:#1565c0;border:2px solid #64b5f6;border-radius:8px;font-weight:600;cursor:pointer">üí≥ Tarjeta</button>
              <button type="button" onclick="addPaymentMethod('sinpe')" style="padding:12px;background:#f3e5f5;color:#7b1fa2;border:2px solid #ba68c8;border-radius:8px;font-weight:600;cursor:pointer">üì± Sinpe M√≥vil</button>
              <button type="button" onclick="addPaymentMethod('otro')" style="padding:12px;background:#ede7f6;color:#4527a0;border:2px solid #9575cd;border-radius:8px;font-weight:600;cursor:pointer">üìã Otro</button>
            </div>
          </div>
          <div id="payment-items-list" style="border-top:2px solid #e0e0e0;padding-top:15px"></div>
        `;
        
        updatePaymentBreakdown();
        renderPaymentItems();
      }

      function addPaymentMethod(method) {
        const total = posCart.reduce((sum, item) => {
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage';
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          return sum + (priceAfterDiscount * item.qty);
        }, 0);
        
        // Aplicar c√°lculo de impuestos
        const taxCalc = calculateIVA(total, currentTaxType);
        
        // Si hay un apartado en proceso, calcular solo el saldo pendiente
        var payableTotal = taxCalc.total;
        if (currentApartadoInProgress) {
          payableTotal = Math.max(0, taxCalc.total - currentApartadoInProgress.se√±aPagada);
        }
        
        const paid = posPaymentMethods.reduce((sum, p) => sum + p.amount, 0);
        const remaining = Math.max(0, payableTotal - paid);
        
        if (remaining === 0) {
          alert('La venta ya est√° pagada completamente');
          return;
        }

        let amount = remaining;
        if (method === 'efectivo') {
          const input = prompt('Monto recibido en efectivo:\n\n(M√≠nimo: ‚Ç°0.00, Pendiente: ‚Ç°' + remaining.toLocaleString('es-CR', {minimumFractionDigits: 2}) + ')', remaining.toString());
          if (input === null) return;
          amount = parseFloat(input) || 0;
          if (amount <= 0) {
            alert('El monto debe ser mayor a 0');
            return;
          }
        } else {
          amount = remaining;
        }
        
        posPaymentMethods.push({
          method: method,
          amount: amount
        });
        
        renderPaymentItems();
        updatePaymentBreakdown();
      }

      function renderPaymentItems() {
        const total = posCart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const paid = posPaymentMethods.reduce((sum, p) => sum + p.amount, 0);
        
        const methodNames = {
          'efectivo': 'üíµ Efectivo',
          'tarjeta': 'üí≥ Tarjeta',
          'sinpe': 'üì± Sinpe M√≥vil',
          'otro': 'üìã Otro'
        };
        
        const itemsList = document.getElementById('payment-items-list');
        if (posPaymentMethods.length === 0) {
          itemsList.innerHTML = '<p style="color:#999;font-style:italic;text-align:center">Sin m√©todos de pago seleccionados</p>';
          return;
        }
        
        itemsList.innerHTML = posPaymentMethods.map((p, idx) => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f5f5f5;border-radius:6px;margin-bottom:8px">
            <div>
              <div style="font-weight:600;color:#5a2032">${methodNames[p.method] || p.method}</div>
              <div style="font-size:0.9rem;color:#666">‚Ç°${p.amount.toLocaleString('es-CR', {minimumFractionDigits: 2})}</div>
            </div>
            <button onclick="removePaymentMethod(${idx})" style="padding:6px 12px;background:#f44336;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600">‚úï</button>
          </div>
        `).join('');
        
        // Mostrar informaci√≥n de vuelto si hay efectivo
        const efectivoPayment = posPaymentMethods.find(p => p.method === 'efectivo');
        if (efectivoPayment) {
          const change = efectivoPayment.amount - (total - posPaymentMethods.filter(p => p.method !== 'efectivo').reduce((sum, p) => sum + p.amount, 0));
          document.getElementById('change-info').style.display = 'block';
          document.getElementById('change-amount').textContent = '‚Ç°' + efectivoPayment.amount.toLocaleString('es-CR', {minimumFractionDigits: 2});
          document.getElementById('change-value').textContent = '‚Ç°' + Math.max(0, change).toLocaleString('es-CR', {minimumFractionDigits: 2});
        } else {
          document.getElementById('change-info').style.display = 'none';
        }
      }

      function removePaymentMethod(idx) {
        posPaymentMethods.splice(idx, 1);
        renderPaymentItems();
        updatePaymentBreakdown();
      }

      function updatePaymentBreakdown() {
        const total = posCart.reduce((sum, item) => {
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage';
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          return sum + (priceAfterDiscount * item.qty);
        }, 0);
        
        // Aplicar c√°lculo de impuestos
        const taxCalc = calculateIVA(total, currentTaxType);
        
        // Si hay un apartado en proceso, calcular solo el saldo pendiente
        var payableTotal = taxCalc.total;
        if (currentApartadoInProgress) {
          payableTotal = Math.max(0, taxCalc.total - currentApartadoInProgress.se√±aPagada);
        }
        
        const paid = posPaymentMethods.reduce((sum, p) => sum + p.amount, 0);
        const remaining = Math.max(0, payableTotal - paid);
        
        const methodNames = {
          'efectivo': 'üíµ Efectivo',
          'tarjeta': 'üí≥ Tarjeta',
          'sinpe': 'üì± Sinpe M√≥vil',
          'otro': 'üìã Otro'
        };
        
        let breakdown = '';
        posPaymentMethods.forEach(p => {
          breakdown += `<div>${methodNames[p.method]}: ‚Ç°${p.amount.toLocaleString('es-CR', {minimumFractionDigits: 2})}</div>`;
        });
        breakdown += `<div style="border-top:1px solid #4caf50;padding-top:8px;margin-top:8px;font-weight:600;color:#2e7d32">Total pagado: ‚Ç°${paid.toLocaleString('es-CR', {minimumFractionDigits: 2})}</div>`;
        if (remaining > 0) {
          breakdown += `<div style="color:#d32f2f;font-weight:600">Falta: ‚Ç°${remaining.toLocaleString('es-CR', {minimumFractionDigits: 2})}</div>`;
        } else if (remaining < 0) {
          breakdown += `<div style="color:#2e7d32;font-weight:600">Cambio total: ‚Ç°${Math.abs(remaining).toLocaleString('es-CR', {minimumFractionDigits: 2})}</div>`;
        }
        
        document.getElementById('payment-breakdown').innerHTML = breakdown;
      }

      function closePaymentModal() {
        document.getElementById('payment-modal').style.display = 'none';
      }

      function confirmPayment() {
        // Validar que se haya seleccionado un cajero
        const cashierSelect = document.getElementById('cashier-select');
        const cashier = cashierSelect.value;
        
        if (!cashier) {
          alert('Debe seleccionar un cajero antes de confirmar la venta');
          return;
        }
        
        const total = posCart.reduce((sum, item) => {
          const discount = item.discount || 0;
          const discountType = item.discountType || 'percentage';
          let discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          const priceAfterDiscount = Math.max(0, item.price - discountAmount);
          return sum + (priceAfterDiscount * item.qty);
        }, 0);
        
        // Aplicar c√°lculo de impuestos
        const taxCalc = calculateIVA(total, currentTaxType);
        
        // Si hay un apartado en proceso, el monto a validar es solo el saldo pendiente
        var amountToValidate = taxCalc.total;
        if (currentApartadoInProgress) {
          amountToValidate = Math.max(0, taxCalc.total - currentApartadoInProgress.se√±aPagada);
        }
        
        const paid = posPaymentMethods.reduce((sum, p) => sum + p.amount, 0);
        
        if (paid < amountToValidate) {
          alert('El monto pagado es insuficiente. Falta ‚Ç°' + (amountToValidate - paid).toLocaleString('es-CR', {minimumFractionDigits: 2}));
          return;
        }
        
        if (posPaymentMethods.length === 0) {
          alert('Debe seleccionar al menos un m√©todo de pago');
          return;
        }
        
        const methodNames = {
          'efectivo': 'üíµ Efectivo',
          'tarjeta': 'üí≥ Tarjeta',
          'sinpe': 'üì± Sinpe M√≥vil',
          'otro': 'üìã Otro'
        };
        
        let paymentSummary = 'M√©todos de pago:\n';
        posPaymentMethods.forEach(p => {
          paymentSummary += methodNames[p.method] + ': ‚Ç°' + p.amount.toLocaleString('es-CR', {minimumFractionDigits: 2}) + '\n';
        });
        
        let taxTypeName = currentTaxType === 'simple' ? 'Simple' : currentTaxType === 'coniva' ? 'Con IVA' : 'Exonerado';
        let confirmMsg = '¬øConfirmar venta?\n\nTipo: ' + taxTypeName + '\nTotal: ‚Ç°' + taxCalc.total.toLocaleString('es-CR', {minimumFractionDigits: 2});
        if (currentTaxType === 'coniva') {
          confirmMsg += '\n(Base: ‚Ç°' + taxCalc.baseImponible.toLocaleString('es-CR', {minimumFractionDigits: 2}) + ' + IVA: ‚Ç°' + taxCalc.iva.toLocaleString('es-CR', {minimumFractionDigits: 2}) + ')';
        } else if (currentTaxType === 'exonerado') {
          confirmMsg += '\n(Precio original: ‚Ç°' + total.toLocaleString('es-CR', {minimumFractionDigits: 2}) + ' - IVA exonerado)';
        }
        confirmMsg += '\n\n' + paymentSummary;
        
        if (!confirm(confirmMsg)) {
          return;
        }
        
        // Actualizar inventario
        // Actualizar inventario
        posCart.forEach(item => {
          const product = productsData.find(p => p.id === item.id);
          if (!product) return;

          // ‚≠ê SI ES VARIANTE -> usar el √≠ndice guardado
          if (
            item.variantIndex !== undefined &&
            product.variants &&
            product.variants.options &&
            product.variants.options[item.variantIndex]
          ) {

            const variantOption = product.variants.options[item.variantIndex];

            if (variantOption.inventory) {
              variantOption.inventory[currentStore] =
                Math.max(0, (variantOption.inventory[currentStore] || 0) - item.qty);
            }

          }
          // ‚≠ê SI ES PRODUCTO NORMAL
          else if (product.inventory) {

            product.inventory[currentStore] =
              Math.max(0, (product.inventory[currentStore] || 0) - item.qty);

          }

          product.sold = (product.sold || 0) + item.qty;
        });   // ‚≠ê‚≠ê‚≠ê ESTE ES EL CIERRE DEL FOREACH ‚≠ê‚≠ê‚≠ê
        
        // Guardar cambios
        if (typeof saveProductsToStorage !== 'undefined') {
          saveProductsToStorage(productsData);
        }
        
        // Crear fecha/hora para la factura
        var invoiceDateTime = getLocalISODateTime();
        
        // Generar e imprimir factura
        try {
          printInvoice(posCart, posPaymentMethods, currentStore, cashier, currentTaxType, taxCalc);
        } catch (err) {
          console.error('Error al imprimir la factura', err);
          alert('Error al generar factura: ' + err.message);
        }
        
        // Guardar factura en historial
        try {
          saveInvoiceToHistory(posCart, posPaymentMethods, currentStore, cashier, currentTaxType, taxCalc);
        } catch (err) {
          console.error('Error al guardar factura en historial:', err);
          alert('Error al guardar factura: ' + err.message);
        }
        
        // Si es un apartado, marcarlo como completado y eliminarlo
        try {
          if (currentApartadoInProgress) {
            var apartadoId = currentApartadoInProgress.id;
            var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
            apartados = apartados.filter(apt => apt.id !== apartadoId);
            localStorage.setItem('apartados', JSON.stringify(apartados));
            console.log('‚úì Apartado ' + apartadoId + ' marcado como completado y eliminado');
          }
        } catch (err) {
          console.error('Error al eliminar apartado:', err);
          alert('Error al eliminar apartado: ' + err.message);
        }

        // Limpiar carrito y cerrar modal
        posCart = [];
        posPaymentMethods = [];
        currentApartadoInProgress = null; // Limpiar apartado despu√©s de completar la venta
        renderPOSCart();
        renderPOSProducts();
        closePaymentModal();
        alert('¬°Venta completada exitosamente!');
      }
      
      function saveInvoiceToHistory(cartItems, paymentMethods, storeKey, cashier, taxType, taxCalc) {
        var now = new Date();
        var invoiceId = 'FAC-' + now.getTime();
        var invoiceDateTime = getLocalISODateTime();
        var subtotal = 0;
        
        // Crear copias de los items para evitar referencias
        var itemsCopy = [];
        for (var i = 0; i < cartItems.length; i++) {
          var item = cartItems[i];
          
          // Calcular precio con descuento
          var discount = item.discount || 0;
          var discountType = item.discountType || 'percentage';
          var discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          var priceAfterDiscount = Math.max(0, item.price - discountAmount);
          
          itemsCopy.push({
            id: item.id,
            variantId: item.variantId,
            variantName: item.variantName,
            title: item.title,
            price: item.price,
            discount: discount,
            discountType: discountType,
            priceAfterDiscount: priceAfterDiscount,
            img: item.img,
            barcode: item.barcode,
            qty: item.qty,
            maxStock: item.maxStock
          });
          subtotal += priceAfterDiscount * item.qty;
        }
        
        // Crear copias de los m√©todos de pago
        var paymentsCopy = [];
        for (var i = 0; i < paymentMethods.length; i++) {
          var p = paymentMethods[i];
          paymentsCopy.push({
            method: p.method,
            amount: p.amount
          });
        }
        
        var invoice = {
          id: invoiceId,
          date: invoiceDateTime,
          store: storeKey,
          cashier: cashier,
          items: itemsCopy,
          paymentMethods: paymentsCopy,
          subtotal: subtotal,
          dateString: now.toLocaleDateString('es-CR'),
          taxType: taxType || 'simple',
          taxInfo: taxCalc || {
            subtotal: subtotal,
            iva: 0,
            total: subtotal,
            baseImponible: 0
          }
        };
        
        // Si esto es una finalizaci√≥n de apartado, agregar info del apartado
        if (currentApartadoInProgress) {
          invoice.apartadoInfo = {
            apartadoId: currentApartadoInProgress.id,
            apartadoStatus: 'completado',
            clientName: currentApartadoInProgress.clientName,
            phone: currentApartadoInProgress.phoneNumber,
            email: currentApartadoInProgress.email,
            moneyApartado: currentApartadoInProgress.se√±aPagada,
            balance: subtotal - currentApartadoInProgress.se√±aPagada,
            completedDate: invoiceDateTime,
            notes: currentApartadoInProgress.notes
          };
          console.log('‚úì Apartado completado:', invoice.apartadoInfo);
        }
        
        try {
          var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
          invoices.push(invoice);
          localStorage.setItem('invoiceHistory', JSON.stringify(invoices));
          console.log('‚úì Factura guardada en historial:', invoiceId);
        } catch (err) {
          console.error('Error al guardar factura en historial:', err);
        }
      }

      function closePaymentModal() {
        document.getElementById('payment-modal').style.display = 'none';
      }

      function formatMoney(amount) {
        return '‚Ç°' + (amount || 0).toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      // Obtener fecha y hora actual en zona horaria local (Costa Rica)
      function getLocalISODateTime() {
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var day = String(now.getDate()).padStart(2, '0');
        var hour = String(now.getHours()).padStart(2, '0');
        var minute = String(now.getMinutes()).padStart(2, '0');
        var second = String(now.getSeconds()).padStart(2, '0');
        // Formato: YYYY-MM-DDTHH:mm:ss (sin Z al final, es local)
        return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':' + second;
      }

      // Obtener solo la fecha local en formato YYYY-MM-DD
      function getLocalDateString() {
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var day = String(now.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
      }

      // Funci√≥n para convertir fecha ISO UTC a hora local
      function convertUTCToLocal(utcDateString) {
        // Si es formato YYYY-MM-DDTHH:mm:ssZ (UTC), convertir a local
        if (utcDateString && utcDateString.includes('Z')) {
          var date = new Date(utcDateString);
          var year = date.getFullYear();
          var month = String(date.getMonth() + 1).padStart(2, '0');
          var day = String(date.getDate()).padStart(2, '0');
          var hour = String(date.getHours()).padStart(2, '0');
          var minute = String(date.getMinutes()).padStart(2, '0');
          var second = String(date.getSeconds()).padStart(2, '0');
          return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':' + second;
        }
        // Si ya est√° en formato local, devolverlo sin cambios
        return utcDateString;
      }

      // Corregir fechas UTC existentes a fechas locales
      function fixUTCDatesInInvoices() {
        try {
          var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
          var modified = false;
          
          for (var i = 0; i < invoices.length; i++) {
            if (invoices[i].date && invoices[i].date.includes('Z')) {
              invoices[i].date = convertUTCToLocal(invoices[i].date);
              modified = true;
              console.log('‚úì Fecha corregida para factura:', invoices[i].id);
            }
          }
          
          if (modified) {
            localStorage.setItem('invoiceHistory', JSON.stringify(invoices));
            console.log('‚úì Facturas con fechas UTC corregidas a tiempo local');
          }
        } catch (err) {
          console.error('Error al corregir fechas:', err);
        }
      }

      // Sincronizar apartados del historial con los que existen en storage
      // Elimina del historial cualquier apartado que ya fue eliminado
      function syncApartadosWithHistory() {
        try {
          var apartados = JSON.parse(localStorage.getItem('apartados') || '[]');
          var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
          
          console.log('üîÑ SINCRONIZANDO APARTADOS:');
          console.log('   Apartados en array:', apartados.length);
          console.log('   Facturas en historial:', invoices.length);
          
          // Crear un set de IDs de apartados existentes para b√∫squeda r√°pida
          var apartadoIds = {};
          for (var i = 0; i < apartados.length; i++) {
            apartadoIds[apartados[i].id] = true;
          }
          
          var deletedApartados = [];
          
          // Filtrar: SOLO eliminar apartados que fueron eliminados ANTES de ser completados
          // Los apartados "creados" son permanentes en el historial
          // Los apartados "completados" tambi√©n son permanentes
          invoices = invoices.filter(function(invoice) {
            // Si no tiene apartadoInfo, mantenerla (es una venta normal)
            if (!invoice.apartadoInfo) {
              return true;
            }
            
            // LOS APARTADOS CREADOS SIEMPRE SE MANTIENEN EN EL HISTORIAL
            // No deben depender de si existen en el array "apartados"
            if (invoice.apartadoInfo.apartadoStatus === 'creado') {
              return true;
            }
            
            // Si es un apartado completado (ya fue retirado), mantenerlo en el historial
            if (invoice.apartadoInfo.apartadoStatus === 'completado') {
              return true;
            }
            
            // Por defecto, mantener si tiene apartadoInfo
            return true;
          });
          
          // Guardar (aunque no se hayan eliminado, asegura consistencia)
          localStorage.setItem('invoiceHistory', JSON.stringify(invoices));
          console.log('‚úì Sincronizaci√≥n completa - Apartados en historial preservados');
        } catch (err) {
          console.error('Error al sincronizar apartados:', err);
        }
      }

      function debugLocalStorage() {
        console.log('=== DEBUG LOCALSTORAGE ===');
        
        // Tama√±o de cada key
        var keys = ['invoiceHistory', 'apartados', 'products', 'stores', 'settings'];
        var totalSize = 0;
        
        for (var i = 0; i < keys.length; i++) {
          var key = keys[i];
          var value = localStorage.getItem(key) || '';
          var sizeBytes = new Blob([value]).size;
          var sizeKB = (sizeBytes / 1024).toFixed(2);
          console.log('- ' + key + ': ' + sizeKB + ' KB (' + sizeBytes + ' bytes)');
          totalSize += sizeBytes;
        }
        
        console.log('TOTAL: ' + (totalSize / 1024).toFixed(2) + ' KB');
        
        // Verificar apartados
        console.log('=== APARTADOS ===');
        var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
        var apartadosList = invoices.filter(function(inv) { return inv.apartadoInfo; });
        console.log('Total apartados en invoiceHistory:', apartadosList.length);
        for (var i = 0; i < apartadosList.length; i++) {
          var apt = apartadosList[i];
          console.log('  - ' + apt.id + ' | Cliente: ' + apt.apartadoInfo.clientName + ' | Se√±a: ' + apt.apartadoInfo.moneyApartado);
        }
        
        // Verificar apartados en storage separado
        var apartadosStorage = JSON.parse(localStorage.getItem('apartados') || '[]');
        console.log('Total apartados en "apartados" storage:', apartadosStorage.length);
        
        console.log('=== FIN DEBUG ===');
      }

      function getStoreName(storeKey) {
        if (storeKey === 'tienda1') return 'Sophie Store';
        if (storeKey === 'tienda2') return 'Sophie Mall';
        if (storeKey === 'tienda3') return 'Sophie\'s Ticados';
        if (storeKey === 'tienda_virtual') return 'Tienda Virtual';
        if (storeKey === 'general') return 'Todas las tiendas';
        return storeKey || 'Tienda';
      }

      function printInvoice(cartItems, paymentMethods, storeKey, cashier, taxType, taxCalc) {
        // Eliminar modal anterior si existe
        const existingModal = document.getElementById('invoice-modal');
        if (existingModal) {
          existingModal.remove();
        }
        
        taxType = taxType || 'simple';
        
        var now = new Date();
        var invoiceId = 'FAC-' + now.getTime();
        var invoiceDateTime = getLocalISODateTime();
        var storeName = getStoreName(storeKey);
        
        var subtotal = 0;
        for (var i = 0; i < cartItems.length; i++) {
          var item = cartItems[i];
          var discount = item.discount || 0;
          var discountType = item.discountType || 'percentage';
          var discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          var priceAfterDiscount = Math.max(0, item.price - discountAmount);
          subtotal += priceAfterDiscount * item.qty;
        }
        var paid = 0;
        for (var i = 0; i < paymentMethods.length; i++) {
          paid += paymentMethods[i].amount;
        }
        var change = Math.max(0, paid - subtotal);
        
        var modal = document.createElement('div');
        modal.id = 'invoice-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
        
        var itemsRows = '';
        for (var i = 0; i < cartItems.length; i++) {
          var item = cartItems[i];
          var displayTitle = item.title;
          if (item.variantName) {
            displayTitle = item.title + ' - ' + item.variantName;
          }
          
          // Calcular descuento
          var discount = item.discount || 0;
          var discountType = item.discountType || 'percentage';
          var discountAmount = 0;
          
          if (discountType === 'percentage') {
            discountAmount = (item.price * discount) / 100;
          } else {
            discountAmount = discount;
          }
          
          var priceAfterDiscount = Math.max(0, item.price - discountAmount);
          var lineTotal = priceAfterDiscount * item.qty;
          
          // Mostrar precio y descuento
          var priceDisplay = '';
          if (discount > 0) {
            priceDisplay = '<span style="text-decoration:line-through;font-size:7px">' + formatMoney(item.price) + '</span><br>' + formatMoney(priceAfterDiscount);
            if (discountType === 'percentage') {
              priceDisplay += '<br><span style="font-size:7px">(-' + discount + '%)</span>';
            } else {
              priceDisplay += '<br><span style="font-size:7px">(-' + formatMoney(discount) + ')</span>';
            }
          } else {
            priceDisplay = formatMoney(item.price);
          }
          
          itemsRows += '<tr style="border-bottom:1px dashed #000;"><td style="padding:3px 2px;text-align:left;">' + displayTitle + '</td><td style="padding:3px 2px;text-align:center;width:30px;">' + item.qty + '</td><td style="padding:3px 2px;text-align:right;width:55px;">' + priceDisplay + '</td><td style="padding:3px 2px;text-align:right;width:60px;font-weight:bold;">' + formatMoney(lineTotal) + '</td></tr>';
        }
        
        var paymentRows = '';
        for (var i = 0; i < paymentMethods.length; i++) {
          var p = paymentMethods[i];
          var methodName = p.method === 'efectivo' ? 'Efectivo' : p.method === 'tarjeta' ? 'Tarjeta de Cr√©dito' : p.method === 'sinpe' ? 'Sinpe M√≥vil' : 'Otro';
          paymentRows += '<tr><td style="padding:3px;">' + methodName + '</td><td style="padding:3px;text-align:right;">' + formatMoney(p.amount) + '</td></tr>';
        }
        
        var content = '<div style="background:white;padding:8px;border-radius:6px;max-width:300px;max-height:80vh;overflow-y:auto;font-family:\'Courier New\',monospace;font-size:9px;box-shadow:0 4px 20px rgba(0,0,0,0.2);">';
        
        // Header
        content += '<div style="text-align:center;border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px;">';
        content += '<div style="margin:0;font-size:11px;font-weight:bold;color:#000">' + storeName + '</div>';
        content += '<div style="margin:3px 0;font-size:8px;">Tienda de Regalos y Accesorios</div>';
        content += '</div>';
        
        // Informaci√≥n del apartado si aplica
        if (currentApartadoInProgress) {
          content += '<div style="margin-bottom:8px;padding:8px;background:#f0f0f0;border:1px dashed #000;">';
          content += '<div style="font-weight:bold;margin-bottom:5px;font-size:9px;">COMPLETACI√ìN DE APARTADO</div>';
          content += '<div style="font-size:8px;margin-bottom:3px;"><strong>Apartado ID:</strong> ' + currentApartadoInProgress.id + '</div>';
          content += '<div style="font-size:8px;margin-bottom:3px;"><strong>Cliente:</strong> ' + currentApartadoInProgress.clientName + '</div>';
          if (currentApartadoInProgress.phoneNumber) {
            content += '<div style="font-size:8px;margin-bottom:3px;"><strong>Tel:</strong> ' + currentApartadoInProgress.phoneNumber + '</div>';
          }
          if (currentApartadoInProgress.email) {
            content += '<div style="font-size:8px;margin-bottom:5px;">' + currentApartadoInProgress.email + '</div>';
          }
          content += '<div style="font-size:8px;font-weight:bold;margin-bottom:3px;"><strong>Se√±a Recibida:</strong> ' + formatMoney(currentApartadoInProgress.se√±aPagada) + '</div>';
          var saldoPendiente = subtotal - currentApartadoInProgress.se√±aPagada;
          content += '<div style="font-size:8px;font-weight:bold;border-top:1px dashed #000;padding-top:5px;margin-top:5px;"><strong>Saldo a Pagar:</strong> ' + formatMoney(saldoPendiente) + '</div>';
          content += '</div>';
        }
        
        // Invoice Info
        content += '<div style="margin-bottom:8px;font-size:8px;border-bottom:1px dashed #000;padding-bottom:6px;">';
        content += '<div><strong>No. Factura:</strong> ' + invoiceId + '</div>';
        content += '<div><strong>Fecha:</strong> ' + now.toLocaleDateString() + ' ' + now.toLocaleTimeString() + '</div>';
        content += '<div><strong>Ubicaci√≥n:</strong> ' + storeName + '</div>';
        content += '<div><strong>Cajero:</strong> ' + cashier + '</div>';
        content += '</div>';
        
        // Items Table
        content += '<table style="width:100%;border-collapse:collapse;margin:8px 0;border-top:1px dashed #000;border-bottom:1px dashed #000;font-size:8px;">';
        content += '<tr style="background:#f0f0f0;border-bottom:1px dashed #000;"><th style="padding:3px 2px;text-align:left;font-weight:bold;">Descripci√≥n</th><th style="padding:3px 2px;text-align:center;width:30px;font-weight:bold;">Cant.</th><th style="padding:3px 2px;text-align:right;width:55px;font-weight:bold;">Precio</th><th style="padding:3px 2px;text-align:right;width:60px;font-weight:bold;">Subtotal</th></tr>';
        content += itemsRows;
        content += '</table>';
        
        // Totals con desglose de IVA
        content += '<div style="margin:8px 0;padding:6px;background:#f0f0f0;border:1px dashed #000;font-size:8px;">';
        
        if (taxType === 'simple') {
          content += '<div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:8px;"><span>Subtotal:</span><span>' + formatMoney(subtotal) + '</span></div>';
          content += '<div style="display:flex;justify-content:space-between;font-size:9px;font-weight:bold;border-top:1px dashed #000;padding-top:4px;"><span>TOTAL:</span><span>' + formatMoney(subtotal) + '</span></div>';
        } else if (taxType === 'coniva') {
          content += '<div style="padding:6px;background:#f9f9f9;margin-bottom:6px;border:1px dashed #000;">';
          content += '<div style="text-align:center;font-weight:bold;margin-bottom:4px;font-size:8px;">DESGLOSE DE IMPUESTOS</div>';
          content += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:8px;"><span>Base Imponible:</span><span>' + formatMoney(taxCalc.baseImponible) + '</span></div>';
          content += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:8px;"><span>IVA (13%):</span><span>' + formatMoney(taxCalc.iva) + '</span></div>';
          content += '</div>';
          content += '<div style="display:flex;justify-content:space-between;font-size:9px;font-weight:bold;border-top:1px dashed #000;padding-top:4px;"><span>TOTAL:</span><span>' + formatMoney(taxCalc.total) + '</span></div>';
        } else if (taxType === 'exonerado') {
          content += '<div style="padding:6px;background:#f0f0f0;margin-bottom:6px;border:1px dashed #000;">';
          content += '<div style="text-align:center;font-weight:bold;margin-bottom:4px;font-size:8px;">FACTURA EXONERADA DE IVA</div>';
          content += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:7px;text-decoration:line-through;"><span>Precio con IVA:</span><span>' + formatMoney(subtotal) + '</span></div>';
          content += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:8px;"><span>Descuento IVA (13%):</span><span>-' + formatMoney(subtotal - taxCalc.originalTotal) + '</span></div>';
          
          // Mostrar ajuste de redondeo si existe
          if (taxCalc.roundingAdjustment && taxCalc.roundingAdjustment !== 0) {
            const roundingText = taxCalc.roundingAdjustment > 0 ? 'Redondeo' : 'Ajuste';
            content += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:8px;"><span>' + roundingText + ' (monedas CR):</span><span>' + (taxCalc.roundingAdjustment >= 0 ? '+' : '') + formatMoney(Math.abs(taxCalc.roundingAdjustment)) + '</span></div>';
          }
          
          content += '<div style="text-align:center;font-size:7px;margin-top:3px;font-style:italic;">Cliente diplom√°tico exonerado de impuestos</div>';
          content += '</div>';
          content += '<div style="display:flex;justify-content:space-between;font-size:9px;font-weight:bold;border-top:1px dashed #000;padding-top:4px;"><span>TOTAL (SIN IVA):</span><span>' + formatMoney(taxCalc.total) + '</span></div>';
        }
        
        content += '</div>';
        
        // Payment Details
        content += '<div style="margin:8px 0;">';
        content += '<div style="font-size:9px;font-weight:bold;margin-bottom:4px;border-bottom:1px dashed #000;padding-bottom:3px;">FORMAS DE PAGO</div>';
        content += '<table style="width:100%;border-collapse:collapse;font-size:8px;">';
        content += '<tr style="background:#f0f0f0;"><th style="padding:3px;text-align:left;font-weight:bold;">M√©todo</th><th style="padding:3px;text-align:right;font-weight:bold;">Monto</th></tr>';
        content += paymentRows;
        content += '<tr style="border-top:1px dashed #000;font-weight:bold;"><td style="padding:3px;">Total Pagado</td><td style="padding:3px;text-align:right;">' + formatMoney(paid) + '</td></tr>';
        if (change > 0) {
          content += '<tr style="background:#f0f0f0;"><td style="padding:3px;font-weight:bold;">Cambio</td><td style="padding:3px;text-align:right;font-weight:bold;">' + formatMoney(change) + '</td></tr>';
        }
        content += '</table>';
        content += '</div>';
        
        // Footer
        content += '<div style="text-align:center;margin-top:8px;padding-top:6px;border-top:1px dashed #000;font-size:8px;">';
        content += '<div style="margin:3px 0;">Gracias por su compra</div>';
        content += '<div style="margin:3px 0;">www.sophieshop.com</div>';
        content += '</div>';
        
        // Buttons
        content += '<div style="display:flex;gap:6px;margin-top:8px;padding-top:6px;border-top:1px dashed #000;">';
        content += '<button onclick="window.print();" style="flex:1;padding:6px;background:#333;color:white;border:none;cursor:pointer;border-radius:3px;font-weight:bold;font-size:8px;">Imprimir</button>';
        content += '<button onclick="document.getElementById(\'invoice-modal\').remove();" style="flex:1;padding:6px;background:#666;color:white;border:none;cursor:pointer;border-radius:3px;font-weight:bold;font-size:8px;">Cerrar</button>';
        content += '</div>';
        
        content += '</div>';
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
        
        // Estilos de impresi√≥n - eliminar estilos anteriores primero
        var existingStyle = document.getElementById('invoice-print-style');
        if (existingStyle) {
          existingStyle.remove();
        }
        var style = document.createElement('style');
        style.id = 'invoice-print-style';
        style.textContent = `
          @media print {
            * { margin:0 !important; padding:0 !important; }
            body { margin:0 !important; padding:0 !important; background:white !important; }
            html { margin:0 !important; padding:0 !important; }
            @page { size:80mm auto; margin:0; }
            .pos-container { display:none !important; }
            .admin-tabs { display:none !important; }
            main { display:none !important; }
            #invoice-modal { 
              display:block !important; 
              position:static !important; 
              background:white !important; 
              z-index:auto !important;
              width:80mm !important;
              height:auto !important;
              top:0 !important;
              left:0 !important;
            }
            #invoice-modal > div { 
              display:block !important;
              box-shadow:none !important; 
              padding:8px !important; 
              max-height:none !important; 
              overflow:visible !important; 
              page-break-after:avoid !important;
              width:80mm !important;
              font-family:Arial, sans-serif !important;
              border-radius:0 !important;
              max-width:none !important;
            }
            button { display:none !important; }
            table { page-break-inside:avoid !important; width:100% !important; font-size:0.7rem !important; }
            tr { page-break-inside:avoid !important; }
            h1 { font-size:1rem !important; margin:3px 0 !important; }
            h3 { font-size:0.8rem !important; margin:4px 0 !important; }
            p { margin:3px 0 !important; font-size:0.75rem !important; }
            td, th { padding:4px !important; }
          }
        `;
        document.head.appendChild(style);
      }

      function openInvoiceHistoryModal() {
        var modal = document.createElement('div');
        modal.id = 'history-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
        
        var content = '<div style="background:white;padding:30px;border-radius:12px;max-width:800px;width:90%;max-height:85vh;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;flex-direction:column;">';
        content += '<div style="flex:0 0 auto;display:flex;justify-content:space-between;align-items:center;margin:0 0 16px 0;padding:0 0 14px 0;border-bottom:2px solid #5a2032;">';
        content += '<h2 style="margin:0;color:#5a2032">Historial de Facturas</h2>';
        content += '<button onclick="document.getElementById(\'history-modal\').remove();" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>';
        content += '</div>';
        
        // Body scrollable para mantener el header fijo
        content += '<div style="flex:1 1 auto;overflow-y:auto;padding-right:4px;">';
        content += '<div style="margin-bottom:20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">';
        content += '<div style="display:flex;gap:10px;align-items:center;flex:1;min-width:300px">';
        content += '<label style="color:#5a2032;font-weight:600;white-space:nowrap">Filtrar por fecha:</label>';
        content += '<input type="date" id="history-date-filter" style="padding:8px 12px;border:1px solid #e3cfe0;border-radius:6px;font-family:Montserrat,sans-serif;flex:1" value="' + getLocalDateString() + '">';
        content += '</div>';
        content += '<div style="display:flex;gap:10px;align-items:center;flex:1;min-width:300px">';
        content += '<label style="color:#5a2032;font-weight:600;white-space:nowrap">O por factura:</label>';
        content += '<input type="text" id="history-invoice-filter" style="padding:8px 12px;border:1px solid #e3cfe0;border-radius:6px;font-family:Montserrat,sans-serif;flex:1" placeholder="Ej: FAC-1234">';
        content += '</div>';
        content += '<button onclick="filterInvoices()" style="padding:8px 16px;background:#5a2032;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;white-space:nowrap">üîç Buscar</button>';
        content += '<button onclick="exportInvoiceHistoryCSV()" style="padding:8px 16px;background:#2e7d32;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;white-space:nowrap">‚¨áÔ∏è Descargar CSV</button>';
        content += '</div>';
        
        content += '<div id="history-results" style="margin-top:20px"></div>';
        content += '</div>'; // cierre body scrollable
        content += '</div>'; // cierre contenedor principal
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
        
        // Mostrar facturas de hoy por defecto
        filterInvoices();
      }

      function filterInvoices() {
        var dateInput = document.getElementById('history-date-filter');
        var invoiceInput = document.getElementById('history-invoice-filter');
        if (!dateInput || !invoiceInput) return;
        
        // Asegurar que siempre use la fecha local del sistema como default
        var selectedDate = dateInput.value.trim();
        if (!selectedDate) {
          selectedDate = getLocalDateString();
          dateInput.value = selectedDate;
        }
        
        var invoiceNumber = invoiceInput.value.trim().toUpperCase();
        var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
        
        console.log('üìÖ Buscando - Fecha:', selectedDate, 'Factura:', invoiceNumber);
        console.log('Total facturas guardadas:', invoices.length);
        console.log('Facturas con apartadoInfo:', invoices.filter(function(inv) { return inv.apartadoInfo; }).length);
        
        var filtered = invoices.filter(function(invoice) {
          var matchDate = true;
          var matchInvoice = true;
          
          // Si hay fecha seleccionada y no hay n√∫mero de factura, filtrar por fecha
          if (selectedDate && !invoiceNumber) {
            var invoiceDateString = invoice.date.split('T')[0];
            matchDate = invoiceDateString === selectedDate;
            return matchDate;
          }
          
          // Si hay n√∫mero de factura, buscar por n√∫mero
          if (invoiceNumber) {
            matchInvoice = invoice.id.includes(invoiceNumber);
            return matchInvoice;
          }
          
          // Si no hay ning√∫n filtro, mostrar todos de hoy
          var invoiceDateString = invoice.date.split('T')[0];
          return invoiceDateString === selectedDate;
        });
        
        console.log('‚úì Resultados encontrados:', filtered.length);
        console.log('‚úì Apartados en resultados:', filtered.filter(function(inv) { return inv.apartadoInfo; }).length);

        window.filteredInvoices = filtered;
        
        var resultsDiv = document.getElementById('history-results');
        if (!resultsDiv) return;
        
        if (filtered.length === 0) {
          var dateDisplay = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-CR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
          resultsDiv.innerHTML = '<p style="text-align:center;color:#999;padding:20px">No se encontraron facturas para ' + dateDisplay + '</p>';
          return;
        }
        
        var html = '';
        for (var i = filtered.length - 1; i >= 0; i--) {
          var invoice = filtered[i];
          var time = new Date(invoice.date).toLocaleTimeString('es-CR');
          var total = invoice.subtotal;
          var itemCount = invoice.items.length;
          var isApartado = invoice.apartadoInfo ? true : false;
          var backgroundColor = isApartado ? '#fffbf0' : '#f9f9f9';
          var borderColor = isApartado ? '#ff9800' : '#e3cfe0';
          
          html += '<div style="border:2px solid ' + borderColor + ';border-radius:8px;padding:15px;margin-bottom:10px;background:' + backgroundColor + '">';
          html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">';
          html += '<div style="flex:1">';
          
          // Indicador de apartado
          if (isApartado) {
            html += '<span style="display:inline-block;background:#ff9800;color:white;padding:3px 8px;border-radius:4px;font-size:0.75rem;font-weight:700;margin-bottom:5px">üè™ APARTADO</span><br>';
          }
          
          html += '<strong style="color:' + (isApartado ? '#ff9800' : '#5a2032') + ';font-size:1.1rem">' + invoice.id + '</strong><br>';
          html += '<small style="color:#999">' + time + ' | ' + itemCount + ' art√≠culo(s)';
          if (invoice.cashier) {
            html += ' | Cajero: ' + invoice.cashier;
          }
          html += '</small>';
          
          // Mostrar info de apartado si aplica
          if (isApartado) {
            var aptInfo = invoice.apartadoInfo;
            var statusBadge = '';
            
            // Mostrar badge seg√∫n el estado del apartado
            if (aptInfo.apartadoStatus === 'creado') {
              statusBadge = '<span style="display:inline-block;background:#4caf50;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:700;margin-left:8px">üü¢ Se√±a Recibida</span>';
            } else if (aptInfo.apartadoStatus === 'completado') {
              statusBadge = '<span style="display:inline-block;background:#2196f3;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:700;margin-left:8px">üîµ Saldo Pagado</span>';
            }
            
            html += '<div style="margin-top:8px;padding:8px;background:white;border-radius:4px;border-left:3px solid #ff9800;font-size:0.85rem">';
            html += '<strong style="color:#ff9800">Cliente:</strong> ' + aptInfo.clientName + statusBadge;
            if (aptInfo.phone) {
              html += ' | <strong style="color:#ff9800">Tel:</strong> ' + aptInfo.phone;
            }
            if (aptInfo.email) {
              html += ' | <strong style="color:#ff9800">Email:</strong> ' + aptInfo.email;
            }
            html += '<br>';
            html += '<strong style="color:#4caf50">Se√±a:</strong> ' + formatMoney(aptInfo.moneyApartado) + ' | ';
            html += '<strong style="color:#f44336">Saldo:</strong> ' + formatMoney(aptInfo.balance);
            if (aptInfo.paymentMethod) {
              var methodNames = {'efectivo': 'Efectivo', 'tarjeta': 'Tarjeta', 'sinpe': 'Sinpe', 'otro': 'Otro'};
              html += ' | <strong style="color:#1976d2">M√©todo:</strong> ' + (methodNames[aptInfo.paymentMethod] || aptInfo.paymentMethod);
            }
            if (aptInfo.expiresAt) {
              var expiresDate = new Date(aptInfo.expiresAt).toLocaleDateString('es-CR');
              html += ' | <strong style="color:#ff9800">Expira:</strong> ' + expiresDate;
            }
            html += '</div>';
          }
          
          html += '</div>';
          html += '<div style="text-align:right">';
          html += '<div style="font-size:1.3rem;font-weight:bold;color:' + (isApartado ? '#ff9800' : '#5a2032') + '">' + formatMoney(total) + '</div>';
          html += '</div>';
          html += '</div>';
          html += '<details style="margin-top:10px">';
          html += '<summary style="cursor:pointer;color:#5a2032;font-weight:600">Ver detalles</summary>';
          html += '<div style="padding:10px;margin-top:10px;background:white;border-radius:4px;border-left:3px solid #d946a6">';
          
          for (var j = 0; j < invoice.items.length; j++) {
            var item = invoice.items[j];
            var itemTitle = item.title;
            if (item.variantName) {
              itemTitle += ' - ' + item.variantName;
            }
            
            // Calcular descuento
            var discount = item.discount || 0;
            var discountType = item.discountType || 'percentage';
            var discountAmount = 0;
            
            if (discount > 0) {
              if (discountType === 'percentage') {
                discountAmount = (item.price * discount) / 100;
              } else {
                discountAmount = discount;
              }
            }
            
            // Usar priceAfterDiscount si existe, si no calcular
            var effectivePrice = item.priceAfterDiscount || item.price;
            if (!item.priceAfterDiscount && discount > 0) {
              effectivePrice = Math.max(0, item.price - discountAmount);
            }
            
            var itemTotal = effectivePrice * item.qty;
            
            html += '<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f0f0f0;font-size:0.9rem">';
            html += '<div>';
            html += '<div>' + itemTitle + ' x' + item.qty + '</div>';
            
            // Mostrar descuento si existe
            if (discount > 0) {
              var discountText = discountType === 'percentage' ? discount + '%' : formatMoney(discount);
              html += '<div style="font-size:0.75rem;color:#4caf50;margin-top:2px">Descuento: ' + discountText;
              html += ' (-' + formatMoney(discountAmount * item.qty) + ')</div>';
            }
            
            html += '</div>';
            html += '<div style="text-align:right">';
            
            // Mostrar precio original tachado si hay descuento
            if (discount > 0) {
              html += '<div style="font-size:0.75rem;text-decoration:line-through;color:#999">' + formatMoney(item.price * item.qty) + '</div>';
            }
            
            html += '<div style="font-weight:600">' + formatMoney(itemTotal) + '</div>';
            html += '</div>';
            html += '</div>';
          }
          
          html += '</div>';
          html += '</details>';
          html += '</div>';
        }
        
        resultsDiv.innerHTML = html;
      }

      function exportInvoiceHistoryCSV() {
        var invoices = window.filteredInvoices || JSON.parse(localStorage.getItem('invoiceHistory') || '[]');

        if (!invoices || invoices.length === 0) {
          alert('No hay facturas para exportar.');
          return;
        }

        var rows = [];
        rows.push([
          'Factura',
          'Fecha',
          'Hora',
          'Tienda',
          'Cajero',
          'Cantidad Items',
          'Subtotal',
          'M√©todos de Pago',
          'Apartado'
        ]);

        invoices.forEach(function(invoice) {
          var dateObj = new Date(invoice.date);
          var dateStr = isNaN(dateObj.getTime()) ? (invoice.date || '') : dateObj.toLocaleDateString('es-CR');
          var timeStr = isNaN(dateObj.getTime()) ? '' : dateObj.toLocaleTimeString('es-CR');
          var itemCount = (invoice.items && invoice.items.length) ? invoice.items.reduce(function(acc, it){ return acc + (it.qty || 0); }, 0) : 0;
          var subtotal = (typeof invoice.subtotal === 'number') ? invoice.subtotal : 0;
          var payments = (invoice.paymentMethods || []).map(function(p){
            return p.method + ' ‚Ç°' + (p.amount || 0);
          }).join(' | ');
          var apartadoFlag = invoice.apartadoInfo ? 'SI' : 'NO';

          rows.push([
            invoice.id || '',
            dateStr,
            timeStr,
            invoice.store || '',
            invoice.cashier || '',
            itemCount,
            subtotal,
            payments,
            apartadoFlag
          ]);
        });

        var csv = rows.map(function(row){
          return row.map(function(cell){
            var value = String(cell === undefined || cell === null ? '' : cell);
            return '"' + value.replace(/"/g, '""') + '"';
          }).join(',');
        }).join('\n');

        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        var url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'historial_facturas.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function filterInvoicesByDate() {
        // Funci√≥n legacy que mantiene compatibilidad
        filterInvoices();
      }

      function openDailyReportModal() {
        var modal = document.createElement('div');
        modal.id = 'report-date-selector-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
        
        var today = new Date();
        var year = today.getFullYear();
        var month = String(today.getMonth() + 1).padStart(2, '0');
        var day = String(today.getDate()).padStart(2, '0');
        var todayString = year + '-' + month + '-' + day;
        var currentMonth = year + '-' + month;
        
        var content = '<div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">';
        content += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #1976d2;padding-bottom:15px;">';
        content += '<h2 style="margin:0;color:#1976d2">Generar Reporte</h2>';
        content += '<button onclick="document.getElementById(\'report-date-selector-modal\').remove();" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#5a2032;font-weight:600;margin-bottom:10px">Selecciona una tienda:</label>';
        content += '<select id="report-store-select" style="width:100%;padding:12px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;margin-bottom:15px;">';
        content += '<option value="general">üìä General (Todas las tiendas)</option>';
        content += '<option value="tienda1">Sophie Store</option>';
        content += '<option value="tienda2">Sophie Mall</option>';
        content += '<option value="tienda3">Sophie\'s Ticados</option>';
        content += '<option value="tienda_virtual">üåê Tienda Virtual</option>';
        content += '</select>';
        content += '</div>';
        
        content += '<div style="margin-bottom:20px;">';
        content += '<label style="display:block;color:#5a2032;font-weight:600;margin-bottom:10px">Tipo de reporte:</label>';
        content += '<select id="report-type-select" onchange="toggleReportInputs()" style="width:100%;padding:12px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;margin-bottom:15px;">';
        content += '<option value="day">Por D√≠a</option>';
        content += '<option value="month">Por Mes</option>';
        content += '<option value="year">Por A√±o</option>';
        content += '</select>';
        
        content += '<div id="day-input" style="display:block;">';
        content += '<label style="display:block;color:#5a2032;font-weight:600;margin-bottom:10px">Selecciona una fecha:</label>';
        content += '<input type="date" id="report-date-input" style="width:100%;padding:12px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" value="' + todayString + '">';
        content += '</div>';
        
        content += '<div id="month-input" style="display:none;">';
        content += '<label style="display:block;color:#5a2032;font-weight:600;margin-bottom:10px">Selecciona un mes:</label>';
        content += '<input type="month" id="report-month-input" style="width:100%;padding:12px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" value="' + currentMonth + '">';
        content += '</div>';
        
        content += '<div id="year-input" style="display:none;">';
        content += '<label style="display:block;color:#5a2032;font-weight:600;margin-bottom:10px">Selecciona un a√±o:</label>';
        content += '<input type="number" id="report-year-input" style="width:100%;padding:12px;border:2px solid #e3cfe0;border-radius:8px;font-family:Montserrat,sans-serif;font-size:1rem;" value="' + year + '" min="2020" max="2100">';
        content += '</div>';
        content += '</div>';
        
        content += '<div style="display:flex;gap:10px;">';
        content += '<button onclick="generateReport()" style="flex:1;padding:12px;background:#1976d2;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:1rem;">Ver Reporte</button>';
        content += '<button onclick="document.getElementById(\'report-date-selector-modal\').remove();" style="flex:1;padding:12px;background:#9e9e9e;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:1rem;">Cancelar</button>';
        content += '</div>';
        content += '</div>';
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
      }
      
      function toggleReportInputs() {
        var reportType = document.getElementById('report-type-select').value;
        var dayInput = document.getElementById('day-input');
        var monthInput = document.getElementById('month-input');
        var yearInput = document.getElementById('year-input');
        
        dayInput.style.display = 'none';
        monthInput.style.display = 'none';
        yearInput.style.display = 'none';
        
        if (reportType === 'day') {
          dayInput.style.display = 'block';
        } else if (reportType === 'month') {
          monthInput.style.display = 'block';
        } else if (reportType === 'year') {
          yearInput.style.display = 'block';
        }
      }
      
      function generateReport() {
        var storeKey = document.getElementById('report-store-select').value;
        var reportType = document.getElementById('report-type-select').value;
        var value, period;
        
        if (reportType === 'day') {
          value = document.getElementById('report-date-input').value;
          period = value;
        } else if (reportType === 'month') {
          value = document.getElementById('report-month-input').value;
          period = value;
        } else if (reportType === 'year') {
          value = document.getElementById('report-year-input').value;
          period = value;
        }
        
        generateDailyReportForDate(period, reportType, storeKey);
      }

      function generateDailyReportForDate(dateString, reportType, storeKey) {
        reportType = reportType || 'day';
        storeKey = storeKey || 'general';
        
        // Cerrar modal de selector de fecha
        var selectorModal = document.getElementById('report-date-selector-modal');
        if (selectorModal) {
          selectorModal.remove();
        }
        
        var invoices = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
        
        // Filtrar facturas seg√∫n el tipo de reporte y tienda
        var selectedDateInvoices = invoices.filter(function(invoice) {
          var invoiceDateString = invoice.date.split('T')[0];
          
          // Filtrar por tienda
          if (storeKey !== 'general' && invoice.store !== storeKey) {
            return false;
          }
          
          if (reportType === 'day') {
            return invoiceDateString === dateString;
          } else if (reportType === 'month') {
            // dateString formato: YYYY-MM
            return invoiceDateString.substring(0, 7) === dateString;
          } else if (reportType === 'year') {
            // dateString formato: YYYY
            return invoiceDateString.substring(0, 4) === dateString;
          }
          
          return false;
        });
        
        console.log('Buscando facturas para:', dateString, 'Tienda:', storeKey);
        console.log('Facturas encontradas:', selectedDateInvoices.length);
        
        // Debug de apartados
        var apartadosEnHistorial = selectedDateInvoices.filter(function(inv) { return inv.apartadoInfo; });
        console.log('üì¶ Apartados encontrados en el per√≠odo:', apartadosEnHistorial.length);
        apartadosEnHistorial.forEach(function(apt) {
          console.log('   -', apt.apartadoInfo.apartadoId, 'Status:', apt.apartadoInfo.apartadoStatus, 'Se√±a:', apt.apartadoInfo.moneyApartado);
        });
        
        // Calcular totales
        var totalSales = 0;
        var totalItems = 0;
        var totalDiscounts = 0;
        var invoicesWithDiscount = 0;
        var paymentSummary = {
          'efectivo': 0,
          'tarjeta': 0,
          'sinpe': 0,
          'otro': 0,
          'apartado': 0
        };
        var productsSummary = {};
        var cashierSummary = {};
        var apartadosData = [];
        var apartadosCashierSummary = {};
        
        for (var i = 0; i < selectedDateInvoices.length; i++) {
          var invoice = selectedDateInvoices[i];
          
          // Verificar si es apartado
          if (invoice.apartadoInfo) {
            apartadosData.push(invoice);
            
            // Registrar apartados por cajero
            var apartadoCashier = invoice.cashier || 'Sin registrar';
            if (!apartadosCashierSummary[apartadoCashier]) {
              apartadosCashierSummary[apartadoCashier] = { total: 0, creados: 0, completados: 0, se√±aRecibida: 0, saldoPagado: 0 };
            }
            
            apartadosCashierSummary[apartadoCashier].total += invoice.subtotal;
            
            // Validar que moneyApartado sea un n√∫mero v√°lido
            var moneyApartado = parseFloat(invoice.apartadoInfo.moneyApartado || 0);
            var balance = parseFloat(invoice.apartadoInfo.balance || 0);
            
            // Distinguir entre apartado creado (se√±a) y completado (saldo)
            if (invoice.apartadoInfo.apartadoStatus === 'creado') {
              apartadosCashierSummary[apartadoCashier].creados += 1;
              apartadosCashierSummary[apartadoCashier].se√±aRecibida += moneyApartado;
              paymentSummary['apartado'] = (paymentSummary['apartado'] || 0) + moneyApartado;
              // Agregar se√±a al total de ventas del d√≠a
              totalSales += moneyApartado;
              console.log('‚úì Apartado creado sumado - Se√±a:', moneyApartado, 'Total actual:', totalSales);
            } else if (invoice.apartadoInfo.apartadoStatus === 'completado') {
              apartadosCashierSummary[apartadoCashier].completados += 1;
              apartadosCashierSummary[apartadoCashier].saldoPagado += balance;
              
              // Agregar saldo al total de ventas del d√≠a
              totalSales += balance;
              console.log('‚úì Apartado completado sumado - Saldo:', balance, 'Total actual:', totalSales);
              
              // Contar los m√©todos de pago del saldo completado
              for (var j = 0; j < invoice.paymentMethods.length; j++) {
                var payment = invoice.paymentMethods[j];
                paymentSummary[payment.method] = (paymentSummary[payment.method] || 0) + payment.amount;
              }
            } else {
              // Fallback para apartados antiguos sin status
              apartadosCashierSummary[apartadoCashier].creados += 1;
              apartadosCashierSummary[apartadoCashier].se√±aRecibida += moneyApartado;
              paymentSummary['apartado'] = (paymentSummary['apartado'] || 0) + moneyApartado;
              // Agregar se√±a al total de ventas del d√≠a (fallback)
              totalSales += moneyApartado;
              console.log('‚úì Apartado (fallback) sumado - Se√±a:', moneyApartado, 'Total actual:', totalSales);
            }
            
            continue;
          }
          
          // Verificar si es una venta de tienda virtual
          if (invoice.source === 'tienda_virtual') {
            totalSales += invoice.subtotal;
            
            // Agregar a resumen de pago
            for (var j = 0; j < invoice.paymentMethods.length; j++) {
              var payment = invoice.paymentMethods[j];
              paymentSummary[payment.method] = (paymentSummary[payment.method] || 0) + payment.amount;
            }
            
            // Contar productos de tienda virtual
            for (var j = 0; j < invoice.items.length; j++) {
              var item = invoice.items[j];
              totalItems += item.qty;
              
              var productKey = item.title + (item.variantName ? ' - ' + item.variantName : '');
              var effectivePrice = item.priceAfterDiscount || item.price;
              
              if (!productsSummary[productKey]) {
                productsSummary[productKey] = { 
                  qty: 0, 
                  total: 0, 
                  price: effectivePrice,
                  originalPrice: item.price,
                  totalDiscount: 0
                };
              }
              productsSummary[productKey].qty += item.qty;
              productsSummary[productKey].total += effectivePrice * item.qty;
            }
            
            console.log('‚úì Tienda Virtual sumada - Total:', invoice.subtotal, 'Total actual:', totalSales);
            
            continue;
          }
          
          totalSales += invoice.subtotal;
          
          // Registrar ventas por cajero
          var cashier = invoice.cashier || 'Sin registrar';
          if (!cashierSummary[cashier]) {
            cashierSummary[cashier] = { total: 0, count: 0 };
          }
          cashierSummary[cashier].total += invoice.subtotal;
          cashierSummary[cashier].count += 1;
          
          var hasDiscountInInvoice = false;
          
          // Contar m√©todos de pago
          for (var j = 0; j < invoice.paymentMethods.length; j++) {
            var payment = invoice.paymentMethods[j];
            paymentSummary[payment.method] = (paymentSummary[payment.method] || 0) + payment.amount;
          }
          
          // Contar productos y cantidades
          for (var j = 0; j < invoice.items.length; j++) {
            var item = invoice.items[j];
            totalItems += item.qty;
            
            var productKey = item.title + (item.variantName ? ' - ' + item.variantName : '');
            
            // Calcular descuento
            var discount = item.discount || 0;
            var discountType = item.discountType || 'percentage';
            var discountAmount = 0;
            
            if (discount > 0) {
              hasDiscountInInvoice = true;
              if (discountType === 'percentage') {
                discountAmount = (item.price * discount) / 100;
              } else {
                discountAmount = discount;
              }
              totalDiscounts += discountAmount * item.qty;
            }
            
            // Usar priceAfterDiscount si existe, si no calcular
            var effectivePrice = item.priceAfterDiscount || item.price;
            if (!item.priceAfterDiscount && discount) {
              if (discountType === 'percentage') {
                discountAmount = (item.price * discount) / 100;
              } else {
                discountAmount = discount;
              }
              
              effectivePrice = Math.max(0, item.price - discountAmount);
            }
            
            if (!productsSummary[productKey]) {
              productsSummary[productKey] = { 
                qty: 0, 
                total: 0, 
                price: effectivePrice,
                originalPrice: item.price,
                totalDiscount: 0
              };
            }
            productsSummary[productKey].qty += item.qty;
            productsSummary[productKey].total += effectivePrice * item.qty;
            if (discount > 0) {
              productsSummary[productKey].totalDiscount += discountAmount * item.qty;
            }
          }
          
          if (hasDiscountInInvoice) {
            invoicesWithDiscount++;
          }
        }
        
        // Crear modal del reporte
        var modal = document.createElement('div');
        modal.id = 'report-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
        
        var content = '<div style="background:white;padding:30px;border-radius:12px;max-width:1200px;width:96%;max-height:90vh;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;flex-direction:column;">';

        // Header fijo fuera del √°rea scrollable
        content += '<div style="flex:0 0 auto;display:flex;justify-content:space-between;align-items:center;margin:0 0 16px 0;padding:0 0 14px 0;border-bottom:3px solid #1976d2;">';
        content += '<div>';
        
        // Badge de tipo de reporte
        var reportBadge = '';
        var badgeColor = '';
        var badgeIcon = '';
        if (reportType === 'day') {
          reportBadge = 'DIARIO';
          badgeColor = '#4caf50';
          badgeIcon = 'üìÖ';
        } else if (reportType === 'month') {
          reportBadge = 'MENSUAL';
          badgeColor = '#ff9800';
          badgeIcon = 'üìÜ';
        } else if (reportType === 'year') {
          reportBadge = 'ANUAL';
          badgeColor = '#9c27b0';
          badgeIcon = 'üìä';
        }
        
        content += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">';
        content += '<h2 style="margin:0;color:#1976d2">Reporte de Ventas</h2>';
        content += '<span style="background:' + badgeColor + ';color:white;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:700;letter-spacing:0.5px">' + badgeIcon + ' ' + reportBadge + '</span>';
        content += '</div>';
        
        // Mostrar per√≠odo seg√∫n el tipo de reporte
        var periodText = '';
        var storeText = '';
        if (storeKey === 'general') {
          storeText = ' (Todas las tiendas)';
        } else {
          storeText = ' (' + getStoreName(storeKey) + ')';
        }
        
        if (reportType === 'day') {
          var selectedDate = new Date(dateString + 'T00:00:00');
          periodText = selectedDate.toLocaleDateString('es-CR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
        } else if (reportType === 'month') {
          var parts = dateString.split('-');
          var monthDate = new Date(parts[0], parts[1] - 1, 1);
          periodText = monthDate.toLocaleDateString('es-CR', {year: 'numeric', month: 'long'});
        } else if (reportType === 'year') {
          periodText = 'A√±o ' + dateString;
        }
        
        content += '<p style="margin:5px 0;color:#666;font-size:0.9rem">' + periodText + storeText + '</p>';
        content += '</div>';
        content += '<button onclick="document.getElementById(\'report-modal\').remove();" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666">‚úï</button>';
        content += '</div>';

        // Body scrollable para mantener header fijo
        content += '<div style="flex:1 1 auto;overflow-y:auto;padding-right:4px;">';

        // Resumen general
        content += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:15px;margin-bottom:20px;">';
        content += '<div style="background:#e3f2fd;padding:15px;border-radius:8px;text-align:center;border-left:4px solid #1976d2">';
        content += '<div style="font-size:0.9rem;color:#666">Total de Facturas</div>';
        content += '<div style="font-size:1.8rem;font-weight:bold;color:#1976d2">' + (selectedDateInvoices.length - apartadosData.length) + '</div>';
        content += '<div style="font-size:0.75rem;color:#999;margin-top:3px">+ ' + apartadosData.length + ' apartados</div>';
        content += '</div>';
        content += '<div style="background:#e8f5e9;padding:15px;border-radius:8px;text-align:center;border-left:4px solid #4caf50">';
        content += '<div style="font-size:0.9rem;color:#666">Total Art√≠culos Vendidos</div>';
        content += '<div style="font-size:1.8rem;font-weight:bold;color:#4caf50">' + totalItems + '</div>';
        content += '</div>';
        content += '<div style="background:#fff3e0;padding:15px;border-radius:8px;text-align:center;border-left:4px solid #ff9800">';
        content += '<div style="font-size:0.9rem;color:#666">Total de Ventas</div>';
        content += '<div style="font-size:1.8rem;font-weight:bold;color:#ff9800">' + formatMoney(totalSales) + '</div>';
        
        // Calcular totales de apartados para mostrar en el reporte
        var totalSe√±a = 0;
        var totalSaldo = 0;
        for (var i = 0; i < apartadosData.length; i++) {
          var apt = apartadosData[i];
          if (apt.apartadoInfo.apartadoStatus === 'creado') {
            totalSe√±a += parseFloat(apt.apartadoInfo.moneyApartado || 0);
          } else if (apt.apartadoInfo.apartadoStatus === 'completado') {
            totalSaldo += parseFloat(apt.apartadoInfo.balance || 0);
          }
        }
        
        if (apartadosData.length > 0) {
          content += '<div style="font-size:0.75rem;color:#999;margin-top:5px">';
          if (totalSe√±a > 0) {
            content += 'üü¢ Se√±a: ' + formatMoney(totalSe√±a);
          }
          if (totalSaldo > 0) {
            content += (totalSe√±a > 0 ? ' | ' : '') + 'üîµ Saldo: ' + formatMoney(totalSaldo);
          }
          content += '</div>';
        }
        
        content += '</div>';
        content += '<div style="background:#ffe0e0;padding:15px;border-radius:8px;text-align:center;border-left:4px solid #f44336">';
        content += '<div style="font-size:0.9rem;color:#666">Total Descuentos</div>';
        content += '<div style="font-size:1.8rem;font-weight:bold;color:#f44336">' + formatMoney(totalDiscounts) + '</div>';
        content += '<div style="font-size:0.75rem;color:#666;margin-top:5px">' + invoicesWithDiscount + ' facturas con descuento</div>';
        content += '</div>';
        content += '</div>';
        
        // M√©todos de pago
        content += '<div style="margin-bottom:20px;">';
        content += '<h3 style="color:#1976d2;margin-bottom:15px;border-bottom:2px solid #1976d2;padding-bottom:10px;">Desglose por M√©todo de Pago</h3>';
        content += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">';
        for (var method in paymentSummary) {
          var amount = paymentSummary[method];
          if (amount > 0) {
            var methodName = method === 'efectivo' ? 'üíµ Efectivo' : method === 'tarjeta' ? 'üí≥ Tarjeta' : method === 'sinpe' ? 'üì± Sinpe M√≥vil' : 'üìã Otro';
            content += '<div style="display:flex;justify-content:space-between;padding:10px;background:#f5f5f5;border-radius:6px;">';
            content += '<span style="color:#333;font-weight:600">' + methodName + '</span>';
            content += '<span style="color:#1976d2;font-weight:700">' + formatMoney(amount) + '</span>';
            content += '</div>';
          }
        }
        content += '</div>';
        content += '</div>';
        
        // Calcular ventas de Tienda Virtual
        var virtualSalesTotal = 0;
        var virtualSalesCount = 0;
        var virtualPendingCount = 0;
        
        for (var i = 0; i < selectedDateInvoices.length; i++) {
          var invoice = selectedDateInvoices[i];
          if (invoice.source === 'tienda_virtual') {
            virtualSalesCount += 1;
            virtualSalesTotal += invoice.subtotal;
            
            // Contar pendientes
            if (invoice.status === 'pendiente') {
              virtualPendingCount += 1;
            }
          }
        }
        
        // Ventas de Tienda Virtual
        content += '<div style="margin-bottom:20px;">';
        content += '<h3 style="color:#9c27b0;margin-bottom:15px;border-bottom:2px solid #9c27b0;padding-bottom:10px;">üåê Tienda Virtual</h3>';
        content += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:15px;">';
        content += '<div style="background:#f3e5f5;padding:15px;border-radius:8px;border-left:4px solid #9c27b0">';
        content += '<div style="font-size:0.9rem;color:#666">Ventas en L√≠nea</div>';
        content += '<div style="font-size:1.6rem;font-weight:bold;color:#9c27b0">' + formatMoney(virtualSalesTotal) + '</div>';
        content += '<div style="font-size:0.75rem;color:#999;margin-top:3px">' + virtualSalesCount + ' transacciones</div>';
        content += '</div>';
        content += '<div style="background:#f3e5f5;padding:15px;border-radius:8px;border-left:4px solid #9c27b0">';
        content += '<div style="font-size:0.9rem;color:#666">Pedidos Pendientes</div>';
        content += '<div style="font-size:1.6rem;font-weight:bold;color:#9c27b0">' + virtualPendingCount + '</div>';
        content += '<div style="font-size:0.75rem;color:#999;margin-top:3px">Esperando confirmaci√≥n de pago</div>';
        content += '</div>';
        content += '</div>';
        content += '</div>';
        
        // Ventas por Cajero
        content += '<div style="margin-bottom:20px;">';
        content += '<h3 style="color:#1976d2;margin-bottom:15px;border-bottom:2px solid #1976d2;padding-bottom:10px;">Ventas por Cajero</h3>';
        content += '<table style="width:100%;border-collapse:collapse;">';
        content += '<tr style="background:#f5f5f5;border-bottom:2px solid #1976d2;">';
        content += '<th style="padding:12px;text-align:left;color:#1976d2;font-weight:700">Cajero</th>';
        content += '<th style="padding:12px;text-align:center;color:#1976d2;font-weight:700;width:100px">Transacciones</th>';
        content += '<th style="padding:12px;text-align:right;color:#1976d2;font-weight:700;width:150px">Total Vendido</th>';
        content += '</tr>';
        
        var cashierKeys = Object.keys(cashierSummary).sort(function(a, b) {
          return cashierSummary[b].total - cashierSummary[a].total;
        });
        
        for (var i = 0; i < cashierKeys.length; i++) {
          var cashierName = cashierKeys[i];
          var cashierData = cashierSummary[cashierName];
          content += '<tr style="border-bottom:1px solid #e0e0e0;">';
          content += '<td style="padding:12px;text-align:left;color:#333;font-weight:600">' + cashierName + '</td>';
          content += '<td style="padding:12px;text-align:center;color:#333">' + cashierData.count + '</td>';
          content += '<td style="padding:12px;text-align:right;color:#1976d2;font-weight:700">' + formatMoney(cashierData.total) + '</td>';
          content += '</tr>';
        }
        
        content += '</table>';
        content += '</div>';
        
        // Apartados por Cajero
        if (Object.keys(apartadosCashierSummary).length > 0) {
          content += '<div style="margin-bottom:20px;">';
          content += '<h3 style="color:#ff9800;margin-bottom:15px;border-bottom:2px solid #ff9800;padding-bottom:10px;">üìã Apartados por Cajero</h3>';
          content += '<table style="width:100%;border-collapse:collapse;">';
          content += '<tr style="background:#fff3e0;border-bottom:2px solid #ff9800;">';
          content += '<th style="padding:12px;text-align:left;color:#ff9800;font-weight:700">Cajero</th>';
          content += '<th style="padding:12px;text-align:center;color:#ff9800;font-weight:700;width:80px">Creados</th>';
          content += '<th style="padding:12px;text-align:center;color:#ff9800;font-weight:700;width:80px">Retirados</th>';
          content += '<th style="padding:12px;text-align:right;color:#ff9800;font-weight:700;width:120px">Total Apartado</th>';
          content += '<th style="padding:12px;text-align:right;color:#ff9800;font-weight:700;width:120px">Se√±a Recibida</th>';
          content += '<th style="padding:12px;text-align:right;color:#ff9800;font-weight:700;width:120px">Saldo Pagado</th>';
          content += '</tr>';
          
          var apartadosCashierKeys = Object.keys(apartadosCashierSummary).sort(function(a, b) {
            return apartadosCashierSummary[b].total - apartadosCashierSummary[a].total;
          });
          
          for (var i = 0; i < apartadosCashierKeys.length; i++) {
            var cashierName = apartadosCashierKeys[i];
            var cashierData = apartadosCashierSummary[cashierName];
            
            content += '<tr style="border-bottom:1px solid #ffe0b2;">';
            content += '<td style="padding:12px;text-align:left;color:#ff9800;font-weight:600">' + cashierName + '</td>';
            content += '<td style="padding:12px;text-align:center;"><span style="background:#4caf50;color:white;padding:4px 8px;border-radius:12px;font-size:0.85rem;font-weight:600">' + cashierData.creados + '</span></td>';
            content += '<td style="padding:12px;text-align:center;"><span style="background:#2196f3;color:white;padding:4px 8px;border-radius:12px;font-size:0.85rem;font-weight:600">' + cashierData.completados + '</span></td>';
            content += '<td style="padding:12px;text-align:right;color:#ff9800;font-weight:700">' + formatMoney(cashierData.total) + '</td>';
            content += '<td style="padding:12px;text-align:right;color:#4caf50;font-weight:700">' + formatMoney(cashierData.se√±aRecibida) + '</td>';
            content += '<td style="padding:12px;text-align:right;color:#2196f3;font-weight:700">' + formatMoney(cashierData.saldoPagado) + '</td>';
            content += '</tr>';
          }
          
          content += '</table>';
          content += '</div>';
        }
        
        // Apartados
        if (apartadosData.length > 0) {
          content += '<div style="margin-bottom:20px;background:#fffbf0;border-left:4px solid #ff9800;padding:15px;border-radius:8px;">';
          content += '<h3 style="color:#ff9800;margin:0 0 15px 0;border-bottom:2px solid #ff9800;padding-bottom:10px;">üìã Apartados Registrados</h3>';
          content += '<table style="width:100%;border-collapse:collapse;">';
          content += '<tr style="background:#fff3e0;border-bottom:2px solid #ff9800;">';
          content += '<th style="padding:12px;text-align:left;color:#ff9800;font-weight:700">ID Apartado</th>';
          content += '<th style="padding:12px;text-align:left;color:#ff9800;font-weight:700">Cliente</th>';
          content += '<th style="padding:12px;text-align:center;color:#ff9800;font-weight:700;width:100px">Estado</th>';
          content += '<th style="padding:12px;text-align:center;color:#ff9800;font-weight:700;width:100px">Monto</th>';
          content += '<th style="padding:12px;text-align:center;color:#ff9800;font-weight:700;width:120px">M√©todo</th>';
          content += '<th style="padding:12px;text-align:right;color:#ff9800;font-weight:700;width:120px">Total</th>';
          content += '</tr>';
          
          for (var i = 0; i < apartadosData.length; i++) {
            var apt = apartadosData[i];
            var apartadoInfo = apt.apartadoInfo;
            var methodName = apt.paymentMethods && apt.paymentMethods.length > 0 ? apt.paymentMethods[0].method : 'APARTADO';
            var methodDisplay = methodName === 'APARTADO' ? 'üí∞ Apartado' : methodName === 'efectivo' ? 'üíµ Efectivo' : methodName === 'tarjeta' ? 'üí≥ Tarjeta' : methodName === 'sinpe' ? 'üì± Sinpe' : 'üìã Otro';
            
            // Determinar estado y monto seg√∫n apartadoStatus
            var statusBadge = '';
            var amount = 0;
            var statusColor = '';
            
            console.log('üì¶ Procesando apartado:', apartadoInfo.apartadoId, 'Status:', apartadoInfo.apartadoStatus, 'Se√±a:', apartadoInfo.moneyApartado, 'Balance:', apartadoInfo.balance);
            
            if (apartadoInfo.apartadoStatus === 'creado') {
              statusBadge = 'üü¢ Se√±a Recibida';
              amount = parseFloat(apartadoInfo.moneyApartado) || 0;
              statusColor = '#4caf50';
            } else if (apartadoInfo.apartadoStatus === 'completado') {
              statusBadge = 'üîµ Saldo Pagado';
              amount = parseFloat(apartadoInfo.balance) || 0;
              statusColor = '#2196f3';
            } else {
              // Fallback para apartados antiguos sin status
              statusBadge = 'üìã Apartado';
              amount = apartadoInfo.moneyApartado || 0;
              statusColor = '#ff9800';
            }
            
            content += '<tr style="border-bottom:1px solid #ffe0b2;">';
            content += '<td style="padding:12px;text-align:left;color:#ff9800;font-weight:600">' + apartadoInfo.apartadoId + '</td>';
            content += '<td style="padding:12px;text-align:left;color:#333">' + apartadoInfo.clientName + '</td>';
            content += '<td style="padding:12px;text-align:center;"><span style="background:' + statusColor + ';color:white;padding:4px 8px;border-radius:12px;font-size:0.8rem;font-weight:600">' + statusBadge + '</span></td>';
            content += '<td style="padding:12px;text-align:center;color:' + statusColor + ';font-weight:600">' + formatMoney(amount) + '</td>';
            content += '<td style="padding:12px;text-align:center;color:#ff9800;font-weight:600">' + methodDisplay + '</td>';
            content += '<td style="padding:12px;text-align:right;color:#ff9800;font-weight:700">' + formatMoney(apt.subtotal) + '</td>';
            content += '</tr>';
          }
          
          content += '</table>';
          content += '</div>';
        }
        
        // Reporte detallado de Tienda Virtual
        var virtualOrders = [];
        for (var i = 0; i < selectedDateInvoices.length; i++) {
          if (selectedDateInvoices[i].source === 'tienda_virtual') {
            virtualOrders.push(selectedDateInvoices[i]);
          }
        }
        
        if (virtualOrders.length > 0) {
          content += '<div style="margin-bottom:20px;background:#f3e5f5;border-left:4px solid #9c27b0;padding:15px;border-radius:8px;">';
          content += '<h3 style="color:#9c27b0;margin:0 0 15px 0;border-bottom:2px solid #9c27b0;padding-bottom:10px;">üåê Pedidos de Tienda Virtual (Detallado)</h3>';
          content += '<table style="width:100%;border-collapse:collapse;">';
          content += '<tr style="background:#f3e5f5;border-bottom:2px solid #9c27b0;">';
          content += '<th style="padding:12px;text-align:left;color:#9c27b0;font-weight:700">Orden</th>';
          content += '<th style="padding:12px;text-align:left;color:#9c27b0;font-weight:700">Cliente</th>';
          content += '<th style="padding:12px;text-align:left;color:#9c27b0;font-weight:700">Productos</th>';
          content += '<th style="padding:12px;text-align:center;color:#9c27b0;font-weight:700;width:80px">Cantidad</th>';
          content += '<th style="padding:12px;text-align:center;color:#9c27b0;font-weight:700;width:100px">M√©todo Pago</th>';
          content += '<th style="padding:12px;text-align:center;color:#9c27b0;font-weight:700;width:100px">Env√≠o</th>';
          content += '<th style="padding:12px;text-align:right;color:#9c27b0;font-weight:700;width:100px">Total</th>';
          content += '</tr>';
          
          for (var i = 0; i < virtualOrders.length; i++) {
            var order = virtualOrders[i];
            var totalQty = 0;
            var productsHTML = '';
            
            // Contar cantidad y listar productos
            for (var j = 0; j < order.items.length; j++) {
              var item = order.items[j];
              totalQty += item.qty;
              productsHTML += '‚Ä¢ ' + item.title + ' (x' + item.qty + ')<br>';
            }
            
            // Determinar env√≠o
            var shippingDisplay = 'üì¶ Correos';
            if (order.shippingMethod === 'pickup') {
              shippingDisplay = 'üè™ Retiro: ' + (order.pickupStoreInfo || 'No especificado');
            }
            
            // M√©todo de pago
            var paymentMethod = order.paymentMethods && order.paymentMethods.length > 0 
              ? order.paymentMethods[0].method 
              : 'No especificado';
            var paymentDisplay = paymentMethod === 'efectivo' ? 'üíµ Efectivo' : 
                                 paymentMethod === 'tarjeta' ? 'üí≥ Tarjeta' : 
                                 paymentMethod === 'sinpe' ? 'üì± Sinpe' : 
                                 paymentMethod === 'transferencia' ? 'üè¶ Transferencia' : 
                                 paymentMethod;
            
            content += '<tr style="border-bottom:1px solid #e0d0e0;">';
            content += '<td style="padding:12px;text-align:left;color:#9c27b0;font-weight:600">' + order.id + '</td>';
            content += '<td style="padding:12px;text-align:left;color:#333">' + order.customerEmail + '</td>';
            content += '<td style="padding:12px;text-align:left;color:#333;font-size:0.9rem">' + productsHTML + '</td>';
            content += '<td style="padding:12px;text-align:center;color:#333">' + totalQty + '</td>';
            content += '<td style="padding:12px;text-align:center;color:#666">' + paymentDisplay + '</td>';
            content += '<td style="padding:12px;text-align:center;color:#666;font-size:0.85rem">' + shippingDisplay + '</td>';
            content += '<td style="padding:12px;text-align:right;color:#9c27b0;font-weight:700">' + formatMoney(order.subtotal) + '</td>';
            content += '</tr>';
          }
          
          content += '</table>';
          content += '</div>';
        }
        
        // Productos m√°s vendidos
        content += '<div style="margin-bottom:20px;">';
        content += '<h3 style="color:#1976d2;margin-bottom:15px;border-bottom:2px solid #1976d2;padding-bottom:10px;">Productos Vendidos</h3>';
        content += '<table style="width:100%;border-collapse:collapse;">';
        content += '<tr style="background:#f5f5f5;border-bottom:2px solid #1976d2;">';
        content += '<th style="padding:12px;text-align:left;color:#1976d2;font-weight:700">Producto</th>';
        content += '<th style="padding:12px;text-align:center;color:#1976d2;font-weight:700;width:80px">Cantidad</th>';
        content += '<th style="padding:12px;text-align:right;color:#1976d2;font-weight:700;width:100px">Precio Unit.</th>';
        content += '<th style="padding:12px;text-align:right;color:#1976d2;font-weight:700;width:100px">Descuento</th>';
        content += '<th style="padding:12px;text-align:right;color:#1976d2;font-weight:700;width:120px">Total</th>';
        content += '</tr>';
        
        var productKeys = Object.keys(productsSummary).sort(function(a, b) {
          return productsSummary[b].total - productsSummary[a].total;
        });
        
        for (var i = 0; i < productKeys.length; i++) {
          var key = productKeys[i];
          var prod = productsSummary[key];
          content += '<tr style="border-bottom:1px solid #e0e0e0;">';
          content += '<td style="padding:12px;text-align:left;color:#333">' + key + '</td>';
          content += '<td style="padding:12px;text-align:center;color:#333;font-weight:600">' + prod.qty + '</td>';
          
          // Mostrar precio con indicador si hubo descuento
          if (prod.totalDiscount > 0) {
            content += '<td style="padding:12px;text-align:right;color:#666">';
            content += '<div style="text-decoration:line-through;font-size:0.8rem;color:#999">' + formatMoney(prod.originalPrice) + '</div>';
            content += '<div>' + formatMoney(prod.price) + '</div>';
            content += '</td>';
          } else {
            content += '<td style="padding:12px;text-align:right;color:#666">' + formatMoney(prod.price) + '</td>';
          }
          
          // Columna de descuento
          if (prod.totalDiscount > 0) {
            content += '<td style="padding:12px;text-align:right;color:#4caf50;font-weight:600">-' + formatMoney(prod.totalDiscount) + '</td>';
          } else {
            content += '<td style="padding:12px;text-align:right;color:#999">-</td>';
          }
          
          content += '<td style="padding:12px;text-align:right;color:#1976d2;font-weight:700">' + formatMoney(prod.total) + '</td>';
          content += '</tr>';
        }
        
        content += '</table>';
        content += '</div>';
        
        // Botones de acci√≥n
        content += '<div style="display:flex;gap:10px;margin-top:20px;padding-top:20px;border-top:1px solid #ddd;">';
        content += '<button onclick="printDailyReport(\'' + dateString + '\', \'' + reportType + '\')" style="flex:1;padding:12px;background:#4caf50;color:white;border:none;cursor:pointer;border-radius:6px;font-weight:700;font-size:1rem;">üñ®Ô∏è Imprimir Reporte</button>';
        content += '<button onclick="downloadDailyReport(\'' + dateString + '\', \'' + reportType + '\', \'' + storeKey + '\')" style="flex:1;padding:12px;background:#2196f3;color:white;border:none;cursor:pointer;border-radius:6px;font-weight:700;font-size:1rem;">üìÑ Descargar PDF</button>';
        content += '</div>';
        
        content += '</div>'; // cierre body scrollable
        content += '</div>'; // cierre contenedor principal
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
      }

      function printDailyReport(dateString, reportType, storeKey) {
        // Agregar estilos de impresi√≥n para el reporte
        var existingStyle = document.getElementById('report-print-style');
        if (existingStyle) {
          existingStyle.remove();
        }
        var style = document.createElement('style');
        style.id = 'report-print-style';
        style.textContent = `
          @media print {
            @page { 
              size: A4; 
              margin: 0.8cm;
            }
            * { 
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
            }
            body { 
              margin: 0 !important; 
              padding: 0 !important; 
              background: white !important;
              width: 100% !important;
            }
            html { 
              margin: 0 !important; 
              padding: 0 !important; 
            }
            header { display: none !important; }
            .pos-container { display: none !important; }
            .admin-tabs { display: none !important; }
            main { display: none !important; }
            #daily-report-modal { display: none !important; }
            #apartados-list-modal { display: none !important; }
            #payment-modal { display: none !important; }
            #invoice-modal { display: none !important; }
            #report-modal { 
              display: block !important; 
              position: static !important; 
              background: white !important; 
              z-index: auto !important;
              width: 100% !important;
              height: auto !important;
              top: 0 !important;
              left: 0 !important;
              right: 0 !important;
              bottom: 0 !important;
              overflow: visible !important;
            }
            #report-modal > div { 
              display: block !important;
              box-shadow: none !important; 
              padding: 8px !important; 
              max-height: none !important;
              height: auto !important;
              overflow: visible !important; 
              page-break-after: auto !important;
              width: 100% !important;
              max-width: none !important;
              border-radius: 0 !important;
              background: white !important;
              font-size: 11px !important;
            }
            button { display: none !important; }
            h1 { 
              font-size: 18px !important;
              margin: 8px 0 !important;
              page-break-after: avoid !important;
            }
            h2 { 
              font-size: 16px !important;
              margin: 6px 0 !important;
              page-break-after: avoid !important;
            }
            h3 { 
              font-size: 13px !important;
              margin: 5px 0 !important;
              page-break-after: avoid !important;
            }
            p { 
              margin: 3px 0 !important;
              font-size: 11px !important;
            }
            table { 
              page-break-inside: auto !important; 
              width: 100% !important;
              font-size: 9px !important;
              border-collapse: collapse !important;
              margin: 6px 0 !important;
            }
            thead { display: table-header-group !important; }
            tbody { display: table-row-group !important; }
            tr { 
              page-break-inside: avoid !important; 
              page-break-after: auto !important; 
            }
            td, th { 
              page-break-inside: avoid !important;
              padding: 3px 4px !important;
              border: none !important;
            }
            div { 
              page-break-inside: avoid !important;
            }
            .display\\:grid {
              display: grid !important;
              gap: 8px !important;
              margin: 8px 0 !important;
            }
          }
        `;
        document.head.appendChild(style);
        
        // Ejecutar impresi√≥n
        setTimeout(function() {
          window.print();
        }, 200);
      }

      function downloadDailyReport(dateString, reportType, storeKey) {
        // Cerrar el modal actual
        var reportModal = document.getElementById('report-modal');
        if (reportModal) {
          reportModal.style.display = 'none';
        }
        
        // Llamar a printDailyReport que ya tiene toda la l√≥gica de impresi√≥n
        printDailyReport(dateString, reportType, storeKey);
      }
    </script>
  </body>
</html>
